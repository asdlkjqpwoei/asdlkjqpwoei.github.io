



<!DOCTYPE html>
<html lang="default">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#FFF">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">

<link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">


<link rel="alternate" type="application/rss+xml" title="Jager的工地" href="https://asdlkjqpwoei.github.io/rss.xml" />
<link rel="alternate" type="application/atom+xml" title="Jager的工地" href="https://asdlkjqpwoei.github.io/atom.xml" />
<link rel="alternate" type="application/json" title="Jager的工地" href="https://asdlkjqpwoei.github.io/feed.json" />

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="/css/app.css?v=0.2.5">

  

<link rel="canonical" href="https://asdlkjqpwoei.github.io/2023/06/20/Lyra/">



  <title>
Lyra Sample - Unreal Engine |
Heaven = Jager的工地 = 施工中</title>
<meta name="generator" content="Hexo 6.3.0"></head>
<body itemscope itemtype="http://schema.org/WebPage">
  <div id="loading">
    <div class="cat">
      <div class="body"></div>
      <div class="head">
        <div class="face"></div>
      </div>
      <div class="foot">
        <div class="tummy-end"></div>
        <div class="bottom"></div>
        <div class="legs left"></div>
        <div class="legs right"></div>
      </div>
      <div class="paw">
        <div class="hands left"></div>
        <div class="hands right"></div>
      </div>
    </div>
  </div>
  <div id="container">
    <header id="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="inner">
        <div id="brand">
          <div class="pjax">
          
  <h1 itemprop="name headline">Lyra Sample
  </h1>
  
<div class="meta">
  <span class="item" title="创建时间：2023-06-20 15:25:08">
    <span class="icon">
      <i class="ic i-calendar"></i>
    </span>
    <span class="text">发表于</span>
    <time itemprop="dateCreated datePublished" datetime="2023-06-20T15:25:08+08:00">2023-06-20</time>
  </span>
</div>


          </div>
        </div>
        <nav id="nav">
  <div class="inner">
    <div class="toggle">
      <div class="lines" aria-label="切换导航栏">
        <span class="line"></span>
        <span class="line"></span>
        <span class="line"></span>
      </div>
    </div>
    <ul class="menu">
      <li class="item title"><a href="/" rel="start">Heaven</a></li>
    </ul>
    <ul class="right">
      <li class="item theme">
        <i class="ic i-sun"></i>
      </li>
      <li class="item search">
        <i class="ic i-search"></i>
      </li>
    </ul>
  </div>
</nav>

      </div>
      <div id="imgs" class="pjax">
        <ul>
          <li class="item" data-background-image="https://tva4.sinaimg.cn/large/6833939bly1gipew8gmvyj20zk0m87wh.jpg"></li>
          <li class="item" data-background-image="https://tva4.sinaimg.cn/large/6833939bly1giclfb3vzhj20zk0m8wny.jpg"></li>
          <li class="item" data-background-image="https://tva4.sinaimg.cn/large/6833939bly1gicitspjpbj20zk0m81ky.jpg"></li>
          <li class="item" data-background-image="https://tva4.sinaimg.cn/large/6833939bly1gipev1x5e4j20zk0m8b29.jpg"></li>
          <li class="item" data-background-image="https://tva4.sinaimg.cn/large/6833939bly1gipevo9j1jj20zk0m8e81.jpg"></li>
          <li class="item" data-background-image="https://tva4.sinaimg.cn/large/6833939bly1gipesx5fdwj20zk0m81kx.jpg"></li>
        </ul>
      </div>
    </header>
    <div id="waves">
      <svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto">
        <defs>
          <path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z" />
        </defs>
        <g class="parallax">
          <use xlink:href="#gentle-wave" x="48" y="0" />
          <use xlink:href="#gentle-wave" x="48" y="3" />
          <use xlink:href="#gentle-wave" x="48" y="5" />
          <use xlink:href="#gentle-wave" x="48" y="7" />
        </g>
      </svg>
    </div>
    <main>
      <div class="inner">
        <div id="main" class="pjax">
          
  <div class="article wrap">
    
<div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList">
<i class="ic i-home"></i>
<span><a href="/">首页</a></span><i class="ic i-angle-right"></i>
<span  class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/Unreal-Engine/" itemprop="item" rel="index" title="分类于 Unreal Engine"><span itemprop="name">Unreal Engine</span></a>
<meta itemprop="position" content="1" /></span>
</div>

    <article itemscope itemtype="http://schema.org/Article" class="post block" lang="default">
  <link itemprop="mainEntityOfPage" href="https://asdlkjqpwoei.github.io/2023/06/20/Lyra/">

  <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="image" content="/images/avatar.jpg">
    <meta itemprop="name" content="asdlkjqpwoei">
    <meta itemprop="description" content="施工中, 游戏开发">
  </span>

  <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Jager的工地">
  </span>

  <div class="body md" itemprop="articleBody">
    

    <h1 id="Version"><a href="#Version" class="headerlink" title="Version"></a>Version</h1><p>使用Unreal Engine 5.2的Lyra</p>
<h1 id="Game-Features"><a href="#Game-Features" class="headerlink" title="Game Features"></a>Game Features</h1><p>模块化玩法功能的框架，使玩法和功能成为一个个名为Game Feature插件，降低Pawn、Character等“热点”类的臃肿，降低维护的难度。</p>
<p>极度依赖Asset Manager。</p>
<h2 id="Key-Class"><a href="#Key-Class" class="headerlink" title="Key Class"></a>Key Class</h2><ul>
<li>UGameFeaturesSubsystemSettings</li>
</ul>
<blockquote>
<p>Settings for the Game Features framework.</p>
</blockquote>
<p>继承UDeveloperSettings，Game Features框架的设置，可以在编辑器中或者配置文件中进行修改和配置。</p>
<ul>
<li>UGameFeaturesSubsystem</li>
</ul>
<blockquote>
<p>The manager subsystem for game features.</p>
</blockquote>
<p>继承UEngineSubsystem，负责初始化、加载或者卸载Game Feature的框架管理类。</p>
<ul>
<li>UGameFeatureData</li>
</ul>
<blockquote>
<p>Data related to a game feature, a collection of code and content that adds a separable discrete feature to the game.</p>
</blockquote>
<p>继承UPrimaryDataAsset，Game Feature数据，代码和内容的集合，可独立添加到游戏中的功能数据组件。</p>
<ul>
<li>UGameFeatureStateMachine</li>
</ul>
<blockquote>
<p>A state machine to manage transitioning a game feature plugin from just a URL into a fully loaded and active plugin, including registering its contents with other game systems.</p>
</blockquote>
<p>继承UObject，管理Game Feature从仅有URL已知到完全加载和激活的过程，包括将它的内容注册进其他的游戏系统。</p>
<ul>
<li>UGameFeatureAction</li>
</ul>
<blockquote>
<p>Represents an action to be taken when a game feature is activated.</p>
</blockquote>
<p>继承UObject，代表一个Game Feature被激活时要执行的动作。</p>
<ul>
<li>UGameFeatureAction_WorldActionBase</li>
</ul>
<blockquote>
<p>Base class for GameFeatureActions that wish to do something world specific.</p>
</blockquote>
<p>继承UGameFeatureAction，Lyra中的GameFeatureAcitons基类，在Game Feature流程中触发的激活回调都会调用此类定义的回调函数。</p>
<h2 id="Flow-Diagram"><a href="#Flow-Diagram" class="headerlink" title="Flow Diagram"></a>Flow Diagram</h2><img data-src="/2023/06/20/Lyra/Unreal%20Engine%205%20Lyra%20Starter%20Game%20Game%20Feature%20Work%20Flow.png" class="" title="Game Feature Work Flow">

<h2 id="State-Machine"><a href="#State-Machine" class="headerlink" title="State Machine"></a>State Machine</h2><p>在<em>Engine\Plugins\Experimental\GameFeatures\Source\GameFeatures\Public\GameFeatureTypes.h</em>文件中查看所有状态的描述和定义。</p>
<p>在<em>Engine\Plugins\Experimental\GameFeatures\Source\GameFeatures\Private\GameFeaturePluginStateMachine.cpp</em>中有所有状态执行的动作逻辑（每个结构体都几乎会有个覆写的UpdateState函数）</p>
<ol>
<li>Uninitialized: 初始状态，未设置、还未被设置、未初始化。</li>
<li>UnknownStatus: 初始化后的状态，仅仅获取到该Game Feature的URL，其他信息均未知。（Game Feature信息有名称、是否确认启用、URL等，主要信息就是该Game Feature的URL。因为不知道URL到底是一个链接还是路径，所以未知）</li>
<li>CheckingStatus: 检查中的状态，一种从UnknownStatus到StatusKnown的过渡状态。</li>
<li>StatusKnown: 已经获取足够的Plugins信息后的状态，依据该信息进入Downloading或者Installed状态。(已经清楚该Game Feature的URL是链接或路径)</li>
<li>Downloading: 如果Game Feature的URL是一个链接，就会进入该状态尝试下载。</li>
<li>Installed: 处于该状态时，该Game Feature已经存在于硬盘。</li>
<li>Mounting: 一种从Installed到Regsitered的过渡状态之一，会把该Game Feature反序列化并进行预加载。（好像也是加载该Game Feature C++模块的状态）</li>
<li>WaitingForDependencies: 一种从Installed到Regsitered的过渡状态之一，如果该Game Feature有其他的依赖，并且未被加载，就会进入该状态。</li>
<li>Registering: 一种从Installed到Regsitered的过渡状态之一，读取设置并注册该Game Feature所有的UE资产。</li>
<li>Regsitered: 该Game Feature设置和资产已经被注册后所处的状态，可进入Loading状态。</li>
<li>Loading: 该状态就代表正式加载Game Feature的资产进入内存。</li>
<li>Loaded: Game Feature的所有相关数据和资产已经全部加载进入内存中，但没有与游戏系统一起注册，就会进入此状态，等待被激活。</li>
<li>Activating: 与游戏系统一起注册，正式进入激活。</li>
<li>Active: 全面激活，已经在游戏中产生影响和效果。</li>
</ol>
<h2 id="Key-Implementation"><a href="#Key-Implementation" class="headerlink" title="Key Implementation"></a>Key Implementation</h2><ul>
<li><p>Engine\Plugins\Experimental\GameFeatures\Source\GameFeatures\Private\GameFeaturesSubsystem.cpp</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">UGameFeaturesSubsystem::LoadBuiltInGameFeaturePlugin</span><span class="params">(<span class="type">const</span> TSharedRef&lt;IPlugin&gt;&amp; Plugin, FBuiltInPluginAdditionalFilters AdditionalFilter)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">UE_SCOPED_ENGINE_ACTIVITY</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;Loading GameFeaturePlugin %s&quot;</span>), *Plugin-&gt;<span class="built_in">GetName</span>());</span><br><span class="line"></span><br><span class="line">	UAssetManager::<span class="built_in">Get</span>().<span class="built_in">PushBulkScanning</span>();</span><br><span class="line"></span><br><span class="line">	<span class="type">const</span> FString&amp; PluginDescriptorFilename = Plugin-&gt;<span class="built_in">GetDescriptorFileName</span>();</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Make sure you are in a game feature plugins folder. All GameFeaturePlugins are rooted in a GameFeatures folder.</span></span><br><span class="line">	<span class="keyword">if</span> (!PluginDescriptorFilename.<span class="built_in">IsEmpty</span>() &amp;&amp; <span class="built_in">GetDefault</span>&lt;UGameFeaturesSubsystemSettings&gt;()-&gt;<span class="built_in">IsValidGameFeaturePlugin</span>(FPaths::<span class="built_in">ConvertRelativePathToFull</span>(PluginDescriptorFilename)) &amp;&amp; FPaths::<span class="built_in">FileExists</span>(PluginDescriptorFilename))</span><br><span class="line">	&#123;</span><br><span class="line">		FString PluginURL;</span><br><span class="line">		<span class="type">bool</span> bIsFileProtocol = <span class="literal">true</span>;</span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">GetPluginURLByName</span>(Plugin-&gt;<span class="built_in">GetName</span>(), PluginURL))</span><br><span class="line">		&#123;</span><br><span class="line">			bIsFileProtocol = UGameFeaturesSubsystem::<span class="built_in">IsPluginURLProtocol</span>(PluginURL, EGameFeaturePluginProtocol::File);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			PluginURL = <span class="built_in">GetPluginURL_FileProtocol</span>(PluginDescriptorFilename);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 检查该Game Feature是否存在及可否经过Game Feature加载策略的筛选</span></span><br><span class="line">		<span class="keyword">if</span> (bIsFileProtocol &amp;&amp; GameSpecificPolicies-&gt;<span class="built_in">IsPluginAllowed</span>(PluginURL))</span><br><span class="line">		&#123;</span><br><span class="line">			FGameFeaturePluginDetails PluginDetails;</span><br><span class="line">			<span class="keyword">if</span> (<span class="built_in">GetGameFeaturePluginDetails</span>(PluginDescriptorFilename, PluginDetails))</span><br><span class="line">			&#123;</span><br><span class="line">				FBuiltInGameFeaturePluginBehaviorOptions BehaviorOptions;</span><br><span class="line">				<span class="type">bool</span> bShouldProcess = <span class="built_in">AdditionalFilter</span>(PluginDescriptorFilename, PluginDetails, BehaviorOptions);</span><br><span class="line">				<span class="comment">// 给Game Feature建立状态机</span></span><br><span class="line">				<span class="keyword">if</span> (bShouldProcess)</span><br><span class="line">				&#123;</span><br><span class="line">					UGameFeaturePluginStateMachine* StateMachine = <span class="built_in">FindOrCreateGameFeaturePluginStateMachine</span>(PluginURL);</span><br><span class="line"></span><br><span class="line">					<span class="type">const</span> EBuiltInAutoState InitialAutoState = (BehaviorOptions.AutoStateOverride != EBuiltInAutoState::Invalid) ? BehaviorOptions.AutoStateOverride : PluginDetails.BuiltInAutoState;</span><br><span class="line">						</span><br><span class="line">					<span class="type">const</span> EGameFeaturePluginState DestinationState = <span class="built_in">ConvertInitialFeatureStateToTargetState</span>(InitialAutoState);</span><br><span class="line"></span><br><span class="line">					<span class="comment">// If we&#x27;re already at the destination or beyond, don&#x27;t transition back</span></span><br><span class="line">					<span class="function">FGameFeaturePluginStateRange <span class="title">Destination</span><span class="params">(DestinationState, EGameFeaturePluginState::Active)</span></span>;</span><br><span class="line">					<span class="comment">// 加载Game Feature插件，初始化状态机。</span></span><br><span class="line">					<span class="built_in">ChangeGameFeatureDestination</span>(StateMachine, Destination, </span><br><span class="line">						FGameFeaturePluginChangeStateComplete::<span class="built_in">CreateUObject</span>(<span class="keyword">this</span>, &amp;ThisClass::LoadBuiltInGameFeaturePluginComplete, StateMachine, Destination));</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	UAssetManager::<span class="built_in">Get</span>().<span class="built_in">PopBulkScanning</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">UGameFeaturesSubsystem::ChangeGameFeatureDestination</span><span class="params">(UGameFeaturePluginStateMachine* Machine, <span class="type">const</span> FGameFeaturePluginStateRange&amp; StateRange, FGameFeaturePluginChangeStateComplete CompleteDelegate)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	Machine-&gt;<span class="built_in">SetDestination</span>(StateRange, FGameFeatureStateTransitionComplete::<span class="built_in">CreateUObject</span>(<span class="keyword">this</span>, &amp;ThisClass::ChangeGameFeatureTargetStateComplete, CompleteDelegate));</span><br><span class="line">	<span class="comment">// ......</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 当Game Feature达到Registering状态时，Game Feature Action的Registering回调会被调用。</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">UGameFeaturesSubsystem::OnGameFeatureRegistering</span><span class="params">(<span class="type">const</span> UGameFeatureData* GameFeatureData, <span class="type">const</span> FString&amp; PluginName, <span class="type">const</span> FString&amp; PluginURL)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">CallbackObservers</span>(EObserverCallback::Registering, PluginURL, &amp;PluginName, GameFeatureData);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (UGameFeatureAction* Action : GameFeatureData-&gt;<span class="built_in">GetActions</span>())</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (Action != <span class="literal">nullptr</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			Action-&gt;<span class="built_in">OnGameFeatureRegistering</span>();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 当Game Feature达到Activating状态时，Game Feature Action的Activating回调会被调用。</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">UGameFeaturesSubsystem::OnGameFeatureActivating</span><span class="params">(<span class="type">const</span> UGameFeatureData* GameFeatureData, <span class="type">const</span> FString&amp; PluginName, FGameFeatureActivatingContext&amp; Context, <span class="type">const</span> FString&amp; PluginURL)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">CallbackObservers</span>(EObserverCallback::Activating, PluginURL, &amp;PluginName, GameFeatureData);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (UGameFeatureAction* Action : GameFeatureData-&gt;<span class="built_in">GetActions</span>())</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (Action != <span class="literal">nullptr</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			Action-&gt;<span class="built_in">OnGameFeatureActivating</span>(Context);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Engine\Plugins\Experimental\GameFeatures\Private\GameFeaturePluginStateMachine.cpp</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">UGameFeaturePluginStateMachine::SetDestination</span><span class="params">(FGameFeaturePluginStateRange InDestination, FGameFeatureStateTransitionComplete OnFeatureStateTransitionComplete, FDelegateHandle* OutCallbackHandle <span class="comment">/*= nullptr*/</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">check</span>(<span class="built_in">IsValidDestinationState</span>(InDestination.MinState));</span><br><span class="line">	<span class="built_in">check</span>(<span class="built_in">IsValidDestinationState</span>(InDestination.MaxState));</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!InDestination.<span class="built_in">IsValid</span>())</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// Invalid range</span></span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (CurrentStateInfo.State == EGameFeaturePluginState::Terminal &amp;&amp; !InDestination.<span class="built_in">Contains</span>(EGameFeaturePluginState::Terminal))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// Can&#x27;t tranistion away from terminal state</span></span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!<span class="built_in">IsRunning</span>())</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// Not running so any new range is acceptable</span></span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (OutCallbackHandle)</span><br><span class="line">		&#123;</span><br><span class="line">			OutCallbackHandle-&gt;<span class="built_in">Reset</span>();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		FDestinationGameFeaturePluginState* CurrState = AllStates[CurrentStateInfo.State]-&gt;<span class="built_in">AsDestinationState</span>();</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (InDestination.<span class="built_in">Contains</span>(CurrentStateInfo.State))</span><br><span class="line">		&#123;</span><br><span class="line">			OnFeatureStateTransitionComplete.<span class="built_in">ExecuteIfBound</span>(<span class="keyword">this</span>, <span class="built_in">MakeValue</span>());</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">if</span> (CurrentStateInfo.State &lt; InDestination)</span><br><span class="line">		&#123;</span><br><span class="line">			FDestinationGameFeaturePluginState* MinDestState = AllStates[InDestination.MinState]-&gt;<span class="built_in">AsDestinationState</span>();</span><br><span class="line">			FDelegateHandle CallbackHandle = MinDestState-&gt;OnDestinationStateReached.<span class="built_in">Add</span>(<span class="built_in">MoveTemp</span>(OnFeatureStateTransitionComplete));</span><br><span class="line">			<span class="keyword">if</span> (OutCallbackHandle)</span><br><span class="line">			&#123;</span><br><span class="line">				*OutCallbackHandle = CallbackHandle;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (CurrentStateInfo.State &gt; InDestination)</span><br><span class="line">		&#123;</span><br><span class="line">			FDestinationGameFeaturePluginState* MaxDestState = AllStates[InDestination.MaxState]-&gt;<span class="built_in">AsDestinationState</span>();</span><br><span class="line">			FDelegateHandle CallbackHandle = MaxDestState-&gt;OnDestinationStateReached.<span class="built_in">Add</span>(<span class="built_in">MoveTemp</span>(OnFeatureStateTransitionComplete));</span><br><span class="line">			<span class="keyword">if</span> (OutCallbackHandle)</span><br><span class="line">			&#123;</span><br><span class="line">				*OutCallbackHandle = CallbackHandle;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		StateProperties.Destination = InDestination;</span><br><span class="line">		<span class="built_in">UpdateStateMachine</span>();</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (TOptional&lt;FGameFeaturePluginStateRange&gt; NewDestination = StateProperties.Destination.<span class="built_in">Intersect</span>(InDestination))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// The machine is already running so we can only transition to this range if it overlaps with our current range.</span></span><br><span class="line">		<span class="comment">// We can satisfy both ranges in this case.</span></span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (OutCallbackHandle)</span><br><span class="line">		&#123;</span><br><span class="line">			OutCallbackHandle-&gt;<span class="built_in">Reset</span>();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (CurrentStateInfo.State &lt; StateProperties.Destination)</span><br><span class="line">		&#123;</span><br><span class="line">			StateProperties.Destination = *NewDestination;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (InDestination.<span class="built_in">Contains</span>(CurrentStateInfo.State))</span><br><span class="line">			&#123;</span><br><span class="line">				OnFeatureStateTransitionComplete.<span class="built_in">ExecuteIfBound</span>(<span class="keyword">this</span>, <span class="built_in">MakeValue</span>());</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			FDestinationGameFeaturePluginState* MinDestState = AllStates[InDestination.MinState]-&gt;<span class="built_in">AsDestinationState</span>();</span><br><span class="line">			FDelegateHandle CallbackHandle = MinDestState-&gt;OnDestinationStateReached.<span class="built_in">Add</span>(<span class="built_in">MoveTemp</span>(OnFeatureStateTransitionComplete));</span><br><span class="line">			<span class="keyword">if</span> (OutCallbackHandle)</span><br><span class="line">			&#123;</span><br><span class="line">				*OutCallbackHandle = CallbackHandle;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span>(CurrentStateInfo.State &gt; StateProperties.Destination)</span><br><span class="line">		&#123;</span><br><span class="line">			StateProperties.Destination = *NewDestination;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (InDestination.<span class="built_in">Contains</span>(CurrentStateInfo.State))</span><br><span class="line">			&#123;</span><br><span class="line">				OnFeatureStateTransitionComplete.<span class="built_in">ExecuteIfBound</span>(<span class="keyword">this</span>, <span class="built_in">MakeValue</span>());</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			FDestinationGameFeaturePluginState* MaxDestState = AllStates[InDestination.MaxState]-&gt;<span class="built_in">AsDestinationState</span>();</span><br><span class="line">			FDelegateHandle CallbackHandle = MaxDestState-&gt;OnDestinationStateReached.<span class="built_in">Add</span>(<span class="built_in">MoveTemp</span>(OnFeatureStateTransitionComplete));</span><br><span class="line">			<span class="keyword">if</span> (OutCallbackHandle)</span><br><span class="line">			&#123;</span><br><span class="line">				*OutCallbackHandle = CallbackHandle;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">checkf</span>(<span class="literal">false</span>, <span class="built_in">TEXT</span>(<span class="string">&quot;IsRunning() returned true but state machine has reached destination!&quot;</span>));</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// The requested state range is completely outside the the current state range so reject the request</span></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">UGameFeaturePluginStateMachine::UpdateStateMachine</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	EGameFeaturePluginState CurrentState = <span class="built_in">GetCurrentState</span>();</span><br><span class="line">	<span class="keyword">if</span> (bInUpdateStateMachine)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">UE_LOG</span>(LogGameFeatures, Verbose, <span class="built_in">TEXT</span>(<span class="string">&quot;Game feature state machine skipping update for %s in ::UpdateStateMachine. Current State: %s&quot;</span>), *<span class="built_in">GetGameFeatureName</span>(), *UE::GameFeatures::<span class="built_in">ToString</span>(CurrentState));</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	TOptional&lt;TGuardValue&lt;<span class="type">bool</span>&gt;&gt; <span class="built_in">ScopeGuard</span>(InPlace, bInUpdateStateMachine, <span class="literal">true</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">using</span> StateIt = std::underlying_type&lt;EGameFeaturePluginState&gt;::type;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">auto</span> DoCallbacks = [<span class="keyword">this</span>](<span class="type">const</span> UE::GameFeatures::FResult&amp; Result, StateIt Begin, StateIt End)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">for</span> (StateIt iState = Begin; iState &lt; End; ++iState)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span> (FDestinationGameFeaturePluginState* DestState = AllStates[iState]-&gt;<span class="built_in">AsDestinationState</span>())</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="comment">// Use a local callback on the stack. If SetDestination() is called from the callback then we don&#x27;t want to stomp the callback</span></span><br><span class="line">				<span class="comment">// for the new state transition request.</span></span><br><span class="line">				<span class="comment">// Callback from terminal state could also trigger a GC that would destroy the state machine</span></span><br><span class="line">				FDestinationGameFeaturePluginState::FOnDestinationStateReached <span class="built_in">LocalOnDestinationStateReached</span>(<span class="built_in">MoveTemp</span>(DestState-&gt;OnDestinationStateReached));</span><br><span class="line">				DestState-&gt;OnDestinationStateReached.<span class="built_in">Clear</span>();</span><br><span class="line"></span><br><span class="line">				LocalOnDestinationStateReached.<span class="built_in">Broadcast</span>(<span class="keyword">this</span>, Result);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">auto</span> DoCallback = [&amp;DoCallbacks](<span class="type">const</span> UE::GameFeatures::FResult&amp; Result, StateIt InState)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">DoCallbacks</span>(Result, InState, InState + <span class="number">1</span>);</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="type">bool</span> bKeepProcessing = <span class="literal">false</span>;</span><br><span class="line">	int32 NumTransitions = <span class="number">0</span>;</span><br><span class="line">	<span class="type">const</span> int32 MaxTransitions = <span class="number">10000</span>;</span><br><span class="line">	<span class="keyword">do</span></span><br><span class="line">	&#123;</span><br><span class="line">		bKeepProcessing = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">		FGameFeaturePluginStateStatus StateStatus;</span><br><span class="line">		<span class="comment">// 达到注册状态才会开始加载Game Feature Data资产。</span></span><br><span class="line">		AllStates[CurrentState]-&gt;<span class="built_in">UpdateState</span>(StateStatus);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (StateStatus.TransitionToState == CurrentState)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">UE_LOG</span>(LogGameFeatures, Fatal, <span class="built_in">TEXT</span>(<span class="string">&quot;Game feature state %s transitioning to itself. GameFeature: %s&quot;</span>), *UE::GameFeatures::<span class="built_in">ToString</span>(CurrentState), *<span class="built_in">GetGameFeatureName</span>());</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (StateStatus.TransitionToState != EGameFeaturePluginState::Uninitialized)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">UE_LOG</span>(LogGameFeatures, Verbose, <span class="built_in">TEXT</span>(<span class="string">&quot;Game feature &#x27;%s&#x27; transitioning state (%s -&gt; %s)&quot;</span>), *<span class="built_in">GetGameFeatureName</span>(), *UE::GameFeatures::<span class="built_in">ToString</span>(CurrentState), *UE::GameFeatures::<span class="built_in">ToString</span>(StateStatus.TransitionToState));</span><br><span class="line">			AllStates[CurrentState]-&gt;<span class="built_in">EndState</span>();</span><br><span class="line">			CurrentStateInfo = <span class="built_in">FGameFeaturePluginStateInfo</span>(StateStatus.TransitionToState);</span><br><span class="line">			CurrentState = StateStatus.TransitionToState;</span><br><span class="line">			<span class="built_in">check</span>(CurrentState != EGameFeaturePluginState::MAX);</span><br><span class="line">			AllStates[CurrentState]-&gt;<span class="built_in">BeginState</span>();</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (CurrentState == EGameFeaturePluginState::Terminal)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="comment">// Remove from gamefeature subsystem before calling back in case this GFP is reloaded on callback,</span></span><br><span class="line">				<span class="comment">// but make sure we don&#x27;t get destroyed from a GC during a callback</span></span><br><span class="line">				UGameFeaturesSubsystem::<span class="built_in">Get</span>().<span class="built_in">BeginTermination</span>(<span class="keyword">this</span>);</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (StateProperties.bTryCancel &amp;&amp; AllStates[CurrentState]-&gt;<span class="built_in">GetStateType</span>() != EGameFeaturePluginStateType::Transition)</span><br><span class="line">			&#123;</span><br><span class="line">				StateProperties.Destination = <span class="built_in">FGameFeaturePluginStateRange</span>(CurrentState);</span><br><span class="line"></span><br><span class="line">				StateProperties.bTryCancel = <span class="literal">false</span>;</span><br><span class="line">				bKeepProcessing = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">				<span class="comment">// Make sure bInUpdateStateMachine is not set while processing callbacks if we are at our destination</span></span><br><span class="line">				ScopeGuard.<span class="built_in">Reset</span>();</span><br><span class="line"></span><br><span class="line">				<span class="comment">// For all callbacks, return the CanceledResult</span></span><br><span class="line">				<span class="built_in">DoCallbacks</span>(UE::GameFeatures::CanceledResult, <span class="number">0</span>, EGameFeaturePluginState::MAX);</span><br><span class="line"></span><br><span class="line">				<span class="comment">// Must be called after transtition callbacks, UGameFeaturesSubsystem::ChangeGameFeatureTargetStateComplete may remove the this machine from the subsystem</span></span><br><span class="line">				<span class="function">FGameFeaturePluginStateMachineProperties::FOnTransitionCanceled <span class="title">LocalOnTransitionCanceled</span><span class="params">(MoveTemp(StateProperties.OnTransitionCanceled))</span></span>;</span><br><span class="line">				StateProperties.OnTransitionCanceled.<span class="built_in">Clear</span>();</span><br><span class="line">				LocalOnTransitionCanceled.<span class="built_in">Broadcast</span>(<span class="keyword">this</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (<span class="type">const</span> <span class="type">bool</span> bError = !StateStatus.TransitionResult.<span class="built_in">HasValue</span>(); bError)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="built_in">check</span>(<span class="built_in">IsValidErrorState</span>(CurrentState));</span><br><span class="line">				StateProperties.Destination = <span class="built_in">FGameFeaturePluginStateRange</span>(CurrentState);</span><br><span class="line"></span><br><span class="line">				bKeepProcessing = <span class="literal">false</span>;</span><br><span class="line">				</span><br><span class="line">				<span class="comment">// Make sure bInUpdateStateMachine is not set while processing callbacks if we are at our destination</span></span><br><span class="line">				ScopeGuard.<span class="built_in">Reset</span>();</span><br><span class="line"></span><br><span class="line">				<span class="comment">// In case of an error, callback all possible callbacks</span></span><br><span class="line">				<span class="built_in">DoCallbacks</span>(StateStatus.TransitionResult, <span class="number">0</span>, EGameFeaturePluginState::MAX);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">			&#123;</span><br><span class="line">				bKeepProcessing = AllStates[CurrentState]-&gt;<span class="built_in">GetStateType</span>() == EGameFeaturePluginStateType::Transition || !StateProperties.Destination.<span class="built_in">Contains</span>(CurrentState);</span><br><span class="line">				<span class="keyword">if</span> (!bKeepProcessing)</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="comment">// Make sure bInUpdateStateMachine is not set while processing callbacks if we are at our destination</span></span><br><span class="line">					ScopeGuard.<span class="built_in">Reset</span>();</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				<span class="built_in">DoCallback</span>(StateStatus.TransitionResult, CurrentState);</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (CurrentState == EGameFeaturePluginState::Terminal)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="built_in">check</span>(bKeepProcessing == <span class="literal">false</span>);</span><br><span class="line">				<span class="comment">// Now that callbacks are done this machine can be cleaned up</span></span><br><span class="line">				UGameFeaturesSubsystem::<span class="built_in">Get</span>().<span class="built_in">FinishTermination</span>(<span class="keyword">this</span>);</span><br><span class="line">				<span class="built_in">MarkAsGarbage</span>();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (NumTransitions++ &gt; MaxTransitions)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">UE_LOG</span>(LogGameFeatures, Fatal, <span class="built_in">TEXT</span>(<span class="string">&quot;Infinite loop in game feature state machine transitions. Current state %s. GameFeature: %s&quot;</span>), *UE::GameFeatures::<span class="built_in">ToString</span>(CurrentState), *<span class="built_in">GetGameFeatureName</span>());</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; <span class="keyword">while</span> (bKeepProcessing);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Engine\Plugins\Experimental\GameFeatures\Source\GameFeatures\Private\GameFeaturePluginStateMachine.cpp</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">FGameFeaturePluginState_Registering</span> : <span class="keyword">public</span> FGameFeaturePluginState</span><br><span class="line">&#123;</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">UpdateState</span><span class="params">(FGameFeaturePluginStateStatus&amp; StateStatus)</span> <span class="keyword">override</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="built_in">TRACE_CPUPROFILER_EVENT_SCOPE</span>(GFP_Registering);</span><br><span class="line">		<span class="type">const</span> FString PluginFolder = FPaths::<span class="built_in">GetPath</span>(StateProperties.PluginInstalledFilename);</span><br><span class="line">		UGameplayTagsManager::<span class="built_in">Get</span>().<span class="built_in">AddTagIniSearchPath</span>(PluginFolder / <span class="built_in">TEXT</span>(<span class="string">&quot;Config&quot;</span>) / <span class="built_in">TEXT</span>(<span class="string">&quot;Tags&quot;</span>));</span><br><span class="line"></span><br><span class="line">		<span class="type">const</span> FString BackupGameFeatureDataPath = FString::<span class="built_in">Printf</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;/%s/%s.%s&quot;</span>), *StateProperties.PluginName, *StateProperties.PluginName, *StateProperties.PluginName);</span><br><span class="line"></span><br><span class="line">		FString PreferredGameFeatureDataPath = <span class="built_in">TEXT</span>(<span class="string">&quot;/&quot;</span>) + StateProperties.PluginName + <span class="built_in">TEXT</span>(<span class="string">&quot;/GameFeatureData.GameFeatureData&quot;</span>);</span><br><span class="line">		<span class="comment">// Allow game feature location to be overriden globally and from within the plugin</span></span><br><span class="line">		FString OverrideIniPathName = StateProperties.PluginName + <span class="built_in">TEXT</span>(<span class="string">&quot;_Override&quot;</span>);</span><br><span class="line">		FString OverridePath = GConfig-&gt;<span class="built_in">GetStr</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;GameFeatureData&quot;</span>), *OverrideIniPathName, GGameIni);</span><br><span class="line">		<span class="keyword">if</span> (OverridePath.<span class="built_in">IsEmpty</span>())</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="type">const</span> FString SettingsOverride = PluginFolder / <span class="built_in">TEXT</span>(<span class="string">&quot;Config&quot;</span>) / <span class="built_in">TEXT</span>(<span class="string">&quot;Settings.ini&quot;</span>);</span><br><span class="line">			<span class="keyword">if</span> (FPaths::<span class="built_in">FileExists</span>(SettingsOverride))</span><br><span class="line">			&#123;</span><br><span class="line">				GConfig-&gt;<span class="built_in">LoadFile</span>(SettingsOverride);</span><br><span class="line">				OverridePath = GConfig-&gt;<span class="built_in">GetStr</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;GameFeatureData&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;Override&quot;</span>), SettingsOverride);</span><br><span class="line">				GConfig-&gt;<span class="built_in">UnloadFile</span>(SettingsOverride);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (!OverridePath.<span class="built_in">IsEmpty</span>())</span><br><span class="line">		&#123;</span><br><span class="line">			PreferredGameFeatureDataPath = OverridePath;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">auto</span> LoadGameFeatureData = [](<span class="type">const</span> FString&amp; Path) -&gt; UGameFeatureData*</span><br><span class="line">		&#123;</span><br><span class="line">			TSharedPtr&lt;FStreamableHandle&gt; GameFeatureDataHandle;</span><br><span class="line">			<span class="keyword">if</span> (FPackageName::<span class="built_in">DoesPackageExist</span>(Path))</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="comment">//开始加载Game Feature Data资产。</span></span><br><span class="line">				GameFeatureDataHandle = UGameFeaturesSubsystem::<span class="built_in">LoadGameFeatureData</span>(Path);</span><br><span class="line">				<span class="comment">// @todo make this async. For now we just wait</span></span><br><span class="line">				<span class="keyword">if</span> (GameFeatureDataHandle.<span class="built_in">IsValid</span>())</span><br><span class="line">				&#123;</span><br><span class="line">					GameFeatureDataHandle-&gt;<span class="built_in">WaitUntilComplete</span>(<span class="number">0.0f</span>, <span class="literal">false</span>);</span><br><span class="line">					<span class="keyword">return</span> <span class="built_in">Cast</span>&lt;UGameFeatureData&gt;(GameFeatureDataHandle-&gt;<span class="built_in">GetLoadedAsset</span>());</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">		&#125;;</span><br><span class="line"></span><br><span class="line">		StateProperties.GameFeatureData = <span class="built_in">LoadGameFeatureData</span>(PreferredGameFeatureDataPath);</span><br><span class="line">		<span class="keyword">if</span> (!StateProperties.GameFeatureData)</span><br><span class="line">		&#123;</span><br><span class="line">			StateProperties.GameFeatureData = <span class="built_in">LoadGameFeatureData</span>(BackupGameFeatureDataPath);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (StateProperties.GameFeatureData)</span><br><span class="line">		&#123;</span><br><span class="line">			StateProperties.GameFeatureData-&gt;<span class="built_in">InitializeBasePluginIniFile</span>(StateProperties.PluginInstalledFilename);</span><br><span class="line">			StateStatus.<span class="built_in">SetTransition</span>(EGameFeaturePluginState::Registered);</span><br><span class="line"></span><br><span class="line">			<span class="built_in">check</span>(StateProperties.AddedPrimaryAssetTypes.<span class="built_in">Num</span>() == <span class="number">0</span>);</span><br><span class="line">			UGameFeaturesSubsystem::<span class="built_in">Get</span>().<span class="built_in">AddGameFeatureToAssetManager</span>(StateProperties.GameFeatureData, StateProperties.PluginName, StateProperties.AddedPrimaryAssetTypes);</span><br><span class="line">			<span class="comment">// 触发Game Feature Registering回调委托</span></span><br><span class="line">			UGameFeaturesSubsystem::<span class="built_in">Get</span>().<span class="built_in">OnGameFeatureRegistering</span>(StateProperties.GameFeatureData, StateProperties.PluginName, StateProperties.PluginIdentifier.<span class="built_in">GetFullPluginURL</span>());</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">// The gamefeaturedata does not exist. The pak file may not be openable or this is a builtin plugin where the pak file does not exist.</span></span><br><span class="line">			StateStatus.<span class="built_in">SetTransitionError</span>(EGameFeaturePluginState::ErrorRegistering, <span class="built_in">GetErrorResult</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;Plugin_Missing_GameFeatureData&quot;</span>)));</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></li>
</ul>
<h1 id="Game-Abilities-System"><a href="#Game-Abilities-System" class="headerlink" title="Game Abilities System"></a>Game Abilities System</h1><blockquote>
<p>The Gameplay Ability System is a highly flexible framework for building the types of abilities and attributes that you might find in an RPG or MOBA title. You can build actions or passive abilities for the characters in your games to use, and status effects that can build up or wear down various attributes as a result of these actions, additionally you can implement “cooldown” timers or resource costs to regulate the usage of these actions, change the level of the ability and its effects at each level, activate particle, sound effects, and more. The Gameplay Ability System can help you to design, implement, and efficiently network in-game abilities from as simple as jumping to as complex as your favorite character’s ability set in any modern RPG or MOBA title.</p>
</blockquote>
<p>游戏技能系统是一个高度灵活的Gameplay框架，虽说相当合适做RPG或者MOBA，但是其实用来做别的类型应该也可以。</p>
<h2 id="Key-Concept"><a href="#Key-Concept" class="headerlink" title="Key Concept"></a>Key Concept</h2><ul>
<li>Gameplay Cue</li>
</ul>
<blockquote>
<p>Gameplay Cues are Actors and UObjects responsible for running visual and sound effects, and are the preferred method for replicating cosmetic feedback in a multiplayer game. When you create a Gameplay Cue, you run the logic for the effects you want to play inside its Event Graph. Gameplay Cues can be associated with a series of Gameplay Tags, and any Gameplay Effect matching those tags will automatically apply them. </p>
</blockquote>
<p>Gameplay Cue极度依赖Gameplay Tag去添加、运行视觉特效和音效，在Cpp中没有明确的UGameplayCue类，但有UGameplayCueManager这种管理类，负责分发Gameplay Cue和生成GameplayCueNotify Actor。</p>
<h2 id="Key-Class-1"><a href="#Key-Class-1" class="headerlink" title="Key Class"></a>Key Class</h2><ul>
<li>UAbilitySystemComponent</li>
</ul>
<blockquote>
<p>The core ActorComponent for interfacing with the Gameplay Abilities System.</p>
</blockquote>
<p>继承UGameplayTasksComponent、IGameplayTagAssetInteface和IAbilitySystemReplicationProxyInterface，与游戏玩法技能系统交互的核心Actor组件，所有打算使用Gameplay Abilities System的Actor必须拥有该组件。</p>
<ul>
<li>UGameplayAbility</li>
</ul>
<blockquote>
<p>Abilities define custom gameplay logic that can be activated by players or external game logic.</p>
</blockquote>
<p>继承UObject和IGameplayTaskOwnerInterface，游戏技能的玩法逻辑定义和实现，可由玩家激活或者外部游戏逻辑。</p>
<ul>
<li>FGameplayAttribute</li>
</ul>
<blockquote>
<p>Describes a FGameplayAttributeData or float property inside an attribute set. Using this provides editor UI and helper functions.</p>
</blockquote>
<p>用来存储游戏数值和相关属性的结构体，例如移动速度、健康值、攻击速度等。</p>
<ul>
<li>UGameplayAbilitySet</li>
</ul>
<blockquote>
<p>This is an example DataAsset that could be used for defining a set of abilities to give to an AbilitySystemComponent and bind to an input command.</p>
</blockquote>
<p>继承UDataAsset，一个数据资产定义，包含着UGameplayAbility成员和EGameplayAbilityInputBind成员的结构体数组，其中EGameplayAbility是负责输入绑定的枚举定义。</p>
<ul>
<li>FGameplayAbilitySpec</li>
</ul>
<blockquote>
<p>An activatable ability spec, hosted on the ability system component. This defines both what the ability is (what class, what level, input binding etc)<br>and also holds runtime state that must be kept outside of the ability being instanced&#x2F;activated.</p>
</blockquote>
<p>继承FFastArraySerializerItem，可激活技能的详细信息类，一般由技能系统组件管理。该类包含技能的详细定义信息（类型、等级、输入绑定等），并且保持未被实例化或者未被激活的技能的运行状态。</p>
<ul>
<li>FGameplayAbilitySpecHandle</li>
</ul>
<blockquote>
<p>Handle that points to a specific granted ability. These are globally unique.</p>
</blockquote>
<p>全局唯一，指向特定要赋予的技能的引用。只有一个32位整数成员。</p>
<ul>
<li>FGameplayAbilityActorInfo</li>
</ul>
<blockquote>
<p>Cached data associated with an Actor using an Ability.<br>-Initialized from an AActor* in InitFromActor<br>-Abilities use this to know what to actor upon. E.g., instead of being coupled to a specific actor class.<br>-These are generally passed around as pointers to support polymorphism.<br>-Projects can override UAbilitySystemGlobals::AllocAbilityActorInfo to override the default struct type that is created.</p>
</blockquote>
<p>用来缓存使用该技能的Actor信息类。</p>
<ul>
<li>FGameplayAbilityActivationInfo</li>
</ul>
<blockquote>
<p>Data tied to a specific activation of an ability.<br>-Tell us whether we are the authority, if we are predicting, confirmed, etc.<br>-Holds current and previous PredictionKey<br>-Generally not meant to be subclassed in projects.<br>-Passed around by value since the struct is small.</p>
</blockquote>
<p>技能激活的相关信息类。</p>
<ul>
<li>UGameplayEffect</li>
</ul>
<blockquote>
<p>The GameplayEffect definition. This is the data asset defined in the editor that drives everything.<br>This is only blueprintable to allow for templating gameplay effects. Gameplay effects should NOT contain blueprint graphs.</p>
</blockquote>
<p>继承UObject和IGameplayTagAssetInterface，字面意思似乎是玩法效果，容易理解成特效美术相关的意义。</p>
<blockquote>
<p>Gameplay Effects provide a way to alter Gameplay Attributes instantaneously or over time (commonly known as “buffs” and “debuffs”), such as subtracting magic points when casting a spell, granting a movement speed boost while a “Sprint” Ability is active, or gradually restoring health points over the lifetime of a dose of healing medicine.</p>
</blockquote>
<p>实际上根据官方文档、注释描述和具体的蓝图脚本逻辑，这是在游戏运行时随意改动Game Attributes的类，可以理解成一个游戏增益&#x2F;减益效果的类，比如按Shift进行冲刺可以是一种加速增益、遭到毒药侵害随时间减少健康值是一种伤害性减益。</p>
<ul>
<li>FGameplayEffectSpec</li>
</ul>
<blockquote>
<p>GameplayEffect Specification. Tells us:<br>-What UGameplayEffect (const data)<br>-What Level<br>-Who instigated<br>FGameplayEffectSpec is modifiable. We start with initial conditions and modifications be applied to it. In this sense, it is stateful&#x2F;mutable but it<br>is still distinct from an FActiveGameplayEffect which in an applied instance of an FGameplayEffectSpec.</p>
</blockquote>
<p>技能效果的详细信息类</p>
<ul>
<li>UAttributeSet</li>
</ul>
<blockquote>
<p>Defines the set of all GameplayAttributes for your game<br>Games should subclass this and add FGameplayAttributeData properties to represent attributes like health, damage, etc<br>AttributeSets are added to the actors as subobjects, and then registered with the AbilitySystemComponent<br>It often desired to have several sets per project that inherit from each other<br>You could make a base health set, then have a player set that inherits from it and adds more attributes</p>
</blockquote>
<p>继承UObject，可以添加给Actor的属性集合类，会被注册进AbilitySystemComponent，GameEffect的逻辑及相关数值计算都会影响此类的成员。</p>
<ul>
<li>FGameplayEffectExecutionDefinition</li>
</ul>
<blockquote>
<p>Struct representing the definition of a custom execution for a gameplay effect.<br>Custom executions run special logic from an outside class each time the gameplay effect executes.</p>
</blockquote>
<p>游戏效果的具体逻辑执行定义的结构体，每一次游戏效果的执行都可以从外部类中运行。</p>
<ul>
<li>UGameplayEffectCalculation</li>
</ul>
<p>继承UObject</p>
<ul>
<li>UGameplayEffectExecutionCalculation</li>
</ul>
<p>继承UGameplayEffectCalculation，有虚成员函数Execute，负责执行游戏效果的具体逻辑和相关的机制计算。</p>
<h2 id="Flow-Diagram-1"><a href="#Flow-Diagram-1" class="headerlink" title="Flow Diagram"></a>Flow Diagram</h2><img data-src="/2023/06/20/Lyra/Unreal%20Engine%205%20Lyra%20Starter%20Game%20Game%20Ability%20System%20Work%20Flow.png" class="" title="Game Ability System Work Flow">

<h2 id="Key-Implementation-1"><a href="#Key-Implementation-1" class="headerlink" title="Key Implementation"></a>Key Implementation</h2><ul>
<li><p>Engine\Plugins\Runtime\GameplayAbilities\Source\GameplayAbilities\Private\Abilties\GameplayAbilitySet.cpp</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">UGameplayAbilitySet::GiveAbilities</span><span class="params">(UAbilitySystemComponent* AbilitySystemComponent)</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">for</span> (<span class="type">const</span> FGameplayAbilityBindInfo&amp; BindInfo : Abilities)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (BindInfo.GameplayAbilityClass)</span><br><span class="line">		&#123;</span><br><span class="line">			AbilitySystemComponent-&gt;<span class="built_in">GiveAbility</span>(<span class="built_in">FGameplayAbilitySpec</span>(BindInfo.GameplayAbilityClass, <span class="number">1</span>, (int32)BindInfo.Command));</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Engine\Plugins\Runtime\GameplayAbilities\Source\GameplayAbilities\Private\AbilitySystemComponent_Abilities.cpp</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">FGameplayAbilitySpecHandle <span class="title">UAbilitySystemComponent::GiveAbility</span><span class="params">(<span class="type">const</span> FGameplayAbilitySpec&amp; Spec)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (!<span class="built_in">IsValid</span>(Spec.Ability))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">ABILITY_LOG</span>(Error, <span class="built_in">TEXT</span>(<span class="string">&quot;GiveAbility called with an invalid Ability Class.&quot;</span>));</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">FGameplayAbilitySpecHandle</span>();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!<span class="built_in">IsOwnerActorAuthoritative</span>())</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">ABILITY_LOG</span>(Error, <span class="built_in">TEXT</span>(<span class="string">&quot;GiveAbility called on ability %s on the client, not allowed!&quot;</span>), *Spec.Ability-&gt;<span class="built_in">GetName</span>());</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">FGameplayAbilitySpecHandle</span>();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// If locked, add to pending list. The Spec.Handle is not regenerated when we receive, so returning this is ok.</span></span><br><span class="line">	<span class="keyword">if</span> (AbilityScopeLockCount &gt; <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		AbilityPendingAdds.<span class="built_in">Add</span>(Spec);</span><br><span class="line">		<span class="keyword">return</span> Spec.Handle;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">ABILITYLIST_SCOPE_LOCK</span>();</span><br><span class="line">	<span class="comment">// 把技能添加到该技能系统组件的技能容器</span></span><br><span class="line">	FGameplayAbilitySpec&amp; OwnedSpec = ActivatableAbilities.Items[ActivatableAbilities.Items.<span class="built_in">Add</span>(Spec)];</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//网络复制相关，检查技能实例化策略，是否需要将技能在Actor上进行实例化。</span></span><br><span class="line">	<span class="keyword">if</span> (OwnedSpec.Ability-&gt;<span class="built_in">GetInstancingPolicy</span>() == EGameplayAbilityInstancingPolicy::InstancedPerActor)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// Create the instance at creation time</span></span><br><span class="line">		<span class="built_in">CreateNewInstanceOfAbility</span>(OwnedSpec, Spec.Ability);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">OnGiveAbility</span>(OwnedSpec);</span><br><span class="line">	<span class="built_in">MarkAbilitySpecDirty</span>(OwnedSpec, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> OwnedSpec.Handle;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">FGameplayAbilitySpecHandle <span class="title">UAbilitySystemComponent::GiveAbilityAndActivateOnce</span><span class="params">(FGameplayAbilitySpec&amp; Spec, <span class="type">const</span> FGameplayEventData* GameplayEventData)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (!<span class="built_in">IsValid</span>(Spec.Ability))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">ABILITY_LOG</span>(Error, <span class="built_in">TEXT</span>(<span class="string">&quot;GiveAbilityAndActivateOnce called with an invalid Ability Class.&quot;</span>));</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">FGameplayAbilitySpecHandle</span>();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (Spec.Ability-&gt;<span class="built_in">GetInstancingPolicy</span>() == EGameplayAbilityInstancingPolicy::NonInstanced || Spec.Ability-&gt;<span class="built_in">GetNetExecutionPolicy</span>() == EGameplayAbilityNetExecutionPolicy::LocalOnly)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">ABILITY_LOG</span>(Error, <span class="built_in">TEXT</span>(<span class="string">&quot;GiveAbilityAndActivateOnce called on ability %s that is non instanced or won&#x27;t execute on server, not allowed!&quot;</span>), *Spec.Ability-&gt;<span class="built_in">GetName</span>());</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">FGameplayAbilitySpecHandle</span>();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!<span class="built_in">IsOwnerActorAuthoritative</span>())</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">ABILITY_LOG</span>(Error, <span class="built_in">TEXT</span>(<span class="string">&quot;GiveAbilityAndActivateOnce called on ability %s on the client, not allowed!&quot;</span>), *Spec.Ability-&gt;<span class="built_in">GetName</span>());</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">FGameplayAbilitySpecHandle</span>();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	Spec.bActivateOnce = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">	FGameplayAbilitySpecHandle AddedAbilityHandle = <span class="built_in">GiveAbility</span>(Spec);</span><br><span class="line"></span><br><span class="line">	FGameplayAbilitySpec* FoundSpec = <span class="built_in">FindAbilitySpecFromHandle</span>(AddedAbilityHandle);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (FoundSpec)</span><br><span class="line">	&#123;</span><br><span class="line">		FoundSpec-&gt;RemoveAfterActivation = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (!<span class="built_in">InternalTryActivateAbility</span>(AddedAbilityHandle, <span class="built_in">FPredictionKey</span>(), <span class="literal">nullptr</span>, <span class="literal">nullptr</span>, GameplayEventData))</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">// We failed to activate it, so remove it now</span></span><br><span class="line">			<span class="built_in">ClearAbility</span>(AddedAbilityHandle);</span><br><span class="line"></span><br><span class="line">			<span class="keyword">return</span> <span class="built_in">FGameplayAbilitySpecHandle</span>();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> AddedAbilityHandle;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">UAbilitySystemComponent::TryActivateAbilitiesByTag</span><span class="params">(<span class="type">const</span> FGameplayTagContainer&amp; GameplayTagContainer, <span class="type">bool</span> bAllowRemoteActivation)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	TArray&lt;FGameplayAbilitySpec*&gt; AbilitiesToActivate;</span><br><span class="line">	<span class="built_in">GetActivatableGameplayAbilitySpecsByAllMatchingTags</span>(GameplayTagContainer, AbilitiesToActivate);</span><br><span class="line"></span><br><span class="line">	<span class="type">bool</span> bSuccess = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">auto</span> GameplayAbilitySpec : AbilitiesToActivate)</span><br><span class="line">	&#123;</span><br><span class="line">		bSuccess |= <span class="built_in">TryActivateAbility</span>(GameplayAbilitySpec-&gt;Handle, bAllowRemoteActivation);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> bSuccess;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">UAbilitySystemComponent::TryActivateAbilityByClass</span><span class="params">(TSubclassOf&lt;UGameplayAbility&gt; InAbilityToActivate, <span class="type">bool</span> bAllowRemoteActivation)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="type">bool</span> bSuccess = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">	<span class="type">const</span> UGameplayAbility* <span class="type">const</span> InAbilityCDO = InAbilityToActivate.<span class="built_in">GetDefaultObject</span>();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (<span class="type">const</span> FGameplayAbilitySpec&amp; Spec : ActivatableAbilities.Items)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (Spec.Ability == InAbilityCDO)</span><br><span class="line">		&#123;</span><br><span class="line">			bSuccess |= <span class="built_in">TryActivateAbility</span>(Spec.Handle, bAllowRemoteActivation);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> bSuccess;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">UAbilitySystemComponent::TryActivateAbility</span><span class="params">(FGameplayAbilitySpecHandle AbilityToActivate, <span class="type">bool</span> bAllowRemoteActivation)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	FGameplayTagContainer FailureTags;</span><br><span class="line">	FGameplayAbilitySpec* Spec = <span class="built_in">FindAbilitySpecFromHandle</span>(AbilityToActivate);</span><br><span class="line">	<span class="keyword">if</span> (!Spec)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">ABILITY_LOG</span>(Warning, <span class="built_in">TEXT</span>(<span class="string">&quot;TryActivateAbility called with invalid Handle&quot;</span>));</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// don&#x27;t activate abilities that are waiting to be removed</span></span><br><span class="line">	<span class="keyword">if</span> (Spec-&gt;PendingRemove || Spec-&gt;RemoveAfterActivation)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	UGameplayAbility* Ability = Spec-&gt;Ability;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!Ability)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">ABILITY_LOG</span>(Warning, <span class="built_in">TEXT</span>(<span class="string">&quot;TryActivateAbility called with invalid Ability&quot;</span>));</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="type">const</span> FGameplayAbilityActorInfo* ActorInfo = AbilityActorInfo.<span class="built_in">Get</span>();</span><br><span class="line"></span><br><span class="line">	<span class="comment">// make sure the ActorInfo and then Actor on that FGameplayAbilityActorInfo are valid, if not bail out.</span></span><br><span class="line">	<span class="keyword">if</span> (ActorInfo == <span class="literal">nullptr</span> || !ActorInfo-&gt;OwnerActor.<span class="built_in">IsValid</span>() || !ActorInfo-&gt;AvatarActor.<span class="built_in">IsValid</span>())</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">		</span><br><span class="line">	<span class="type">const</span> ENetRole NetMode = ActorInfo-&gt;AvatarActor-&gt;<span class="built_in">GetLocalRole</span>();</span><br><span class="line"></span><br><span class="line">	<span class="comment">// This should only come from button presses/local instigation (AI, etc).</span></span><br><span class="line">	<span class="keyword">if</span> (NetMode == ROLE_SimulatedProxy)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="type">bool</span> bIsLocal = AbilityActorInfo-&gt;<span class="built_in">IsLocallyControlled</span>();</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Check to see if this a local only or server only ability, if so either remotely execute or fail</span></span><br><span class="line">	<span class="keyword">if</span> (!bIsLocal &amp;&amp; (Ability-&gt;<span class="built_in">GetNetExecutionPolicy</span>() == EGameplayAbilityNetExecutionPolicy::LocalOnly || Ability-&gt;<span class="built_in">GetNetExecutionPolicy</span>() == EGameplayAbilityNetExecutionPolicy::LocalPredicted))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (bAllowRemoteActivation)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">ClientTryActivateAbility</span>(AbilityToActivate);</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="built_in">ABILITY_LOG</span>(Log, <span class="built_in">TEXT</span>(<span class="string">&quot;Can&#x27;t activate LocalOnly or LocalPredicted ability %s when not local.&quot;</span>), *Ability-&gt;<span class="built_in">GetName</span>());</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (NetMode != ROLE_Authority &amp;&amp; (Ability-&gt;<span class="built_in">GetNetExecutionPolicy</span>() == EGameplayAbilityNetExecutionPolicy::ServerOnly || Ability-&gt;<span class="built_in">GetNetExecutionPolicy</span>() == EGameplayAbilityNetExecutionPolicy::ServerInitiated))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (bAllowRemoteActivation)</span><br><span class="line">		&#123;</span><br><span class="line">			FScopedCanActivateAbilityLogEnabler LogEnabler;</span><br><span class="line">			<span class="keyword">if</span> (Ability-&gt;<span class="built_in">CanActivateAbility</span>(AbilityToActivate, ActorInfo, <span class="literal">nullptr</span>, <span class="literal">nullptr</span>, &amp;FailureTags))</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="comment">// No prediction key, server will assign a server-generated key</span></span><br><span class="line">				<span class="built_in">CallServerTryActivateAbility</span>(AbilityToActivate, Spec-&gt;InputPressed, <span class="built_in">FPredictionKey</span>());</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">			&#123;</span><br><span class="line">				<span class="built_in">NotifyAbilityFailed</span>(AbilityToActivate, Ability, FailureTags);</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="built_in">ABILITY_LOG</span>(Log, <span class="built_in">TEXT</span>(<span class="string">&quot;Can&#x27;t activate ServerOnly or ServerInitiated ability %s when not the server.&quot;</span>), *Ability-&gt;<span class="built_in">GetName</span>());</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">InternalTryActivateAbility</span>(AbilityToActivate);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">UAbilitySystemComponent::InternalTryActivateAbility</span><span class="params">(FGameplayAbilitySpecHandle Handle, FPredictionKey InPredictionKey, UGameplayAbility** OutInstancedAbility, FOnGameplayAbilityEnded::FDelegate* OnGameplayAbilityEndedDelegate, <span class="type">const</span> FGameplayEventData* TriggerEventData)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="type">const</span> FGameplayTag&amp; NetworkFailTag = UAbilitySystemGlobals::<span class="built_in">Get</span>().ActivateFailNetworkingTag;</span><br><span class="line">	</span><br><span class="line">	InternalTryActivateAbilityFailureTags.<span class="built_in">Reset</span>();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (Handle.<span class="built_in">IsValid</span>() == <span class="literal">false</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">ABILITY_LOG</span>(Warning, <span class="built_in">TEXT</span>(<span class="string">&quot;InternalTryActivateAbility called with invalid Handle! ASC: %s. AvatarActor: %s&quot;</span>), *<span class="built_in">GetPathName</span>(), *<span class="built_in">GetNameSafe</span>(<span class="built_in">GetAvatarActor_Direct</span>()));</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	FGameplayAbilitySpec* Spec = <span class="built_in">FindAbilitySpecFromHandle</span>(Handle);</span><br><span class="line">	<span class="keyword">if</span> (!Spec)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">ABILITY_LOG</span>(Warning, <span class="built_in">TEXT</span>(<span class="string">&quot;InternalTryActivateAbility called with a valid handle but no matching ability was found. Handle: %s ASC: %s. AvatarActor: %s&quot;</span>), *Handle.<span class="built_in">ToString</span>(), *<span class="built_in">GetPathName</span>(), *<span class="built_in">GetNameSafe</span>(<span class="built_in">GetAvatarActor_Direct</span>()));</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Lock ability list so our Spec doesn&#x27;t get destroyed while activating</span></span><br><span class="line">	<span class="built_in">ABILITYLIST_SCOPE_LOCK</span>();</span><br><span class="line"></span><br><span class="line">	<span class="type">const</span> FGameplayAbilityActorInfo* ActorInfo = AbilityActorInfo.<span class="built_in">Get</span>();</span><br><span class="line"></span><br><span class="line">	<span class="comment">// make sure the ActorInfo and then Actor on that FGameplayAbilityActorInfo are valid, if not bail out.</span></span><br><span class="line">	<span class="keyword">if</span> (ActorInfo == <span class="literal">nullptr</span> || !ActorInfo-&gt;OwnerActor.<span class="built_in">IsValid</span>() || !ActorInfo-&gt;AvatarActor.<span class="built_in">IsValid</span>())</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// This should only come from button presses/local instigation (AI, etc)</span></span><br><span class="line">	ENetRole NetMode = ROLE_SimulatedProxy;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Use PC netmode if its there</span></span><br><span class="line">	<span class="keyword">if</span> (APlayerController* PC = ActorInfo-&gt;PlayerController.<span class="built_in">Get</span>())</span><br><span class="line">	&#123;</span><br><span class="line">		NetMode = PC-&gt;<span class="built_in">GetLocalRole</span>();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// Fallback to avataractor otherwise. Edge case: avatar &quot;dies&quot; and becomes torn off and ROLE_Authority. We don&#x27;t want to use this case (use PC role instead).</span></span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (AActor* LocalAvatarActor = <span class="built_in">GetAvatarActor_Direct</span>())</span><br><span class="line">	&#123;</span><br><span class="line">		NetMode = LocalAvatarActor-&gt;<span class="built_in">GetLocalRole</span>();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (NetMode == ROLE_SimulatedProxy)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="type">bool</span> bIsLocal = AbilityActorInfo-&gt;<span class="built_in">IsLocallyControlled</span>();</span><br><span class="line"></span><br><span class="line">	UGameplayAbility* Ability = Spec-&gt;Ability;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!Ability)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">ABILITY_LOG</span>(Warning, <span class="built_in">TEXT</span>(<span class="string">&quot;InternalTryActivateAbility called with invalid Ability&quot;</span>));</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Check to see if this a local only or server only ability, if so don&#x27;t execute</span></span><br><span class="line">	<span class="keyword">if</span> (!bIsLocal)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (Ability-&gt;<span class="built_in">GetNetExecutionPolicy</span>() == EGameplayAbilityNetExecutionPolicy::LocalOnly || (Ability-&gt;<span class="built_in">GetNetExecutionPolicy</span>() == EGameplayAbilityNetExecutionPolicy::LocalPredicted &amp;&amp; !InPredictionKey.<span class="built_in">IsValidKey</span>()))</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">// If we have a valid prediction key, the ability was started on the local client so it&#x27;s okay</span></span><br><span class="line"></span><br><span class="line">			<span class="built_in">ABILITY_LOG</span>(Warning, <span class="built_in">TEXT</span>(<span class="string">&quot;Can&#x27;t activate LocalOnly or LocalPredicted ability %s when not local! Net Execution Policy is %d.&quot;</span>), *Ability-&gt;<span class="built_in">GetName</span>(), (int32)Ability-&gt;<span class="built_in">GetNetExecutionPolicy</span>());</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (NetworkFailTag.<span class="built_in">IsValid</span>())</span><br><span class="line">			&#123;</span><br><span class="line">				InternalTryActivateAbilityFailureTags.<span class="built_in">AddTag</span>(NetworkFailTag);</span><br><span class="line">				<span class="built_in">NotifyAbilityFailed</span>(Handle, Ability, InternalTryActivateAbilityFailureTags);</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">		&#125;		</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (NetMode != ROLE_Authority &amp;&amp; (Ability-&gt;<span class="built_in">GetNetExecutionPolicy</span>() == EGameplayAbilityNetExecutionPolicy::ServerOnly || Ability-&gt;<span class="built_in">GetNetExecutionPolicy</span>() == EGameplayAbilityNetExecutionPolicy::ServerInitiated))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">ABILITY_LOG</span>(Warning, <span class="built_in">TEXT</span>(<span class="string">&quot;Can&#x27;t activate ServerOnly or ServerInitiated ability %s when not the server! Net Execution Policy is %d.&quot;</span>), *Ability-&gt;<span class="built_in">GetName</span>(), (int32)Ability-&gt;<span class="built_in">GetNetExecutionPolicy</span>());</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (NetworkFailTag.<span class="built_in">IsValid</span>())</span><br><span class="line">		&#123;</span><br><span class="line">			InternalTryActivateAbilityFailureTags.<span class="built_in">AddTag</span>(NetworkFailTag);</span><br><span class="line">			<span class="built_in">NotifyAbilityFailed</span>(Handle, Ability, InternalTryActivateAbilityFailureTags);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// If it&#x27;s instance once the instanced ability will be set, otherwise it will be null</span></span><br><span class="line">	UGameplayAbility* InstancedAbility = Spec-&gt;<span class="built_in">GetPrimaryInstance</span>();</span><br><span class="line"></span><br><span class="line">	<span class="type">const</span> FGameplayTagContainer* SourceTags = <span class="literal">nullptr</span>;</span><br><span class="line">	<span class="type">const</span> FGameplayTagContainer* TargetTags = <span class="literal">nullptr</span>;</span><br><span class="line">	<span class="keyword">if</span> (TriggerEventData != <span class="literal">nullptr</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		SourceTags = &amp;TriggerEventData-&gt;InstigatorTags;</span><br><span class="line">		TargetTags = &amp;TriggerEventData-&gt;TargetTags;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// If we have an instanced ability, call CanActivateAbility on it.</span></span><br><span class="line">		<span class="comment">// Otherwise we always do a non instanced CanActivateAbility check using the CDO of the Ability.</span></span><br><span class="line">		UGameplayAbility* <span class="type">const</span> CanActivateAbilitySource = InstancedAbility ? InstancedAbility : Ability;</span><br><span class="line">		FScopedCanActivateAbilityLogEnabler LogEnabler;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (!CanActivateAbilitySource-&gt;<span class="built_in">CanActivateAbility</span>(Handle, ActorInfo, SourceTags, TargetTags, &amp;InternalTryActivateAbilityFailureTags))</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">NotifyAbilityFailed</span>(Handle, CanActivateAbilitySource, InternalTryActivateAbilityFailureTags);</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// If we&#x27;re instance per actor and we&#x27;re already active, don&#x27;t let us activate again as this breaks the graph</span></span><br><span class="line">	<span class="keyword">if</span> (Ability-&gt;<span class="built_in">GetInstancingPolicy</span>() == EGameplayAbilityInstancingPolicy::InstancedPerActor)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (Spec-&gt;<span class="built_in">IsActive</span>())</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span> (Ability-&gt;bRetriggerInstancedAbility &amp;&amp; InstancedAbility)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="type">bool</span> bReplicateEndAbility = <span class="literal">true</span>;</span><br><span class="line">				<span class="type">bool</span> bWasCancelled = <span class="literal">false</span>;</span><br><span class="line">				InstancedAbility-&gt;<span class="built_in">EndAbility</span>(Handle, ActorInfo, Spec-&gt;ActivationInfo, bReplicateEndAbility, bWasCancelled);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">			&#123;</span><br><span class="line">				<span class="built_in">ABILITY_LOG</span>(Verbose, <span class="built_in">TEXT</span>(<span class="string">&quot;Can&#x27;t activate instanced per actor ability %s when their is already a currently active instance for this actor.&quot;</span>), *Ability-&gt;<span class="built_in">GetName</span>());</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Make sure we have a primary</span></span><br><span class="line">	<span class="keyword">if</span> (Ability-&gt;<span class="built_in">GetInstancingPolicy</span>() == EGameplayAbilityInstancingPolicy::InstancedPerActor &amp;&amp; !InstancedAbility)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">ABILITY_LOG</span>(Warning, <span class="built_in">TEXT</span>(<span class="string">&quot;InternalTryActivateAbility called but instanced ability is missing! NetMode: %d. Ability: %s&quot;</span>), (int32)NetMode, *Ability-&gt;<span class="built_in">GetName</span>());</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Setup a fresh ActivationInfo for this AbilitySpec.</span></span><br><span class="line">	Spec-&gt;ActivationInfo = <span class="built_in">FGameplayAbilityActivationInfo</span>(ActorInfo-&gt;OwnerActor.<span class="built_in">Get</span>());</span><br><span class="line">	FGameplayAbilityActivationInfo &amp;ActivationInfo = Spec-&gt;ActivationInfo;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// If we are the server or this is local only</span></span><br><span class="line">	<span class="keyword">if</span> (Ability-&gt;<span class="built_in">GetNetExecutionPolicy</span>() == EGameplayAbilityNetExecutionPolicy::LocalOnly || (NetMode == ROLE_Authority))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// if we&#x27;re the server and don&#x27;t have a valid key or this ability should be started on the server create a new activation key</span></span><br><span class="line">		<span class="type">bool</span> bCreateNewServerKey = NetMode == ROLE_Authority &amp;&amp;</span><br><span class="line">			(!InPredictionKey.<span class="built_in">IsValidKey</span>() ||</span><br><span class="line">			 (Ability-&gt;<span class="built_in">GetNetExecutionPolicy</span>() == EGameplayAbilityNetExecutionPolicy::ServerInitiated ||</span><br><span class="line">			  Ability-&gt;<span class="built_in">GetNetExecutionPolicy</span>() == EGameplayAbilityNetExecutionPolicy::ServerOnly));</span><br><span class="line">		<span class="keyword">if</span> (bCreateNewServerKey)</span><br><span class="line">		&#123;</span><br><span class="line">			ActivationInfo.<span class="built_in">ServerSetActivationPredictionKey</span>(FPredictionKey::<span class="built_in">CreateNewServerInitiatedKey</span>(<span class="keyword">this</span>));</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (InPredictionKey.<span class="built_in">IsValidKey</span>())</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">// Otherwise if available, set the prediction key to what was passed up</span></span><br><span class="line">			ActivationInfo.<span class="built_in">ServerSetActivationPredictionKey</span>(InPredictionKey);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// we may have changed the prediction key so we need to update the scoped key to match</span></span><br><span class="line">		<span class="function">FScopedPredictionWindow <span class="title">ScopedPredictionWindow</span><span class="params">(<span class="keyword">this</span>, ActivationInfo.GetActivationPredictionKey())</span></span>;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// ----------------------------------------------</span></span><br><span class="line">		<span class="comment">// Tell the client that you activated it (if we&#x27;re not local and not server only)</span></span><br><span class="line">		<span class="comment">// ----------------------------------------------</span></span><br><span class="line">		<span class="keyword">if</span> (!bIsLocal &amp;&amp; Ability-&gt;<span class="built_in">GetNetExecutionPolicy</span>() != EGameplayAbilityNetExecutionPolicy::ServerOnly)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span> (TriggerEventData)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="built_in">ClientActivateAbilitySucceedWithEventData</span>(Handle, ActivationInfo.<span class="built_in">GetActivationPredictionKey</span>(), *TriggerEventData);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">			&#123;</span><br><span class="line">				<span class="built_in">ClientActivateAbilitySucceed</span>(Handle, ActivationInfo.<span class="built_in">GetActivationPredictionKey</span>());</span><br><span class="line">			&#125;</span><br><span class="line">			</span><br><span class="line">			<span class="comment">// This will get copied into the instanced abilities</span></span><br><span class="line">			ActivationInfo.bCanBeEndedByOtherInstance = Ability-&gt;bServerRespectsRemoteAbilityCancellation;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// ----------------------------------------------</span></span><br><span class="line">		<span class="comment">//	Call ActivateAbility (note this could end the ability too!)</span></span><br><span class="line">		<span class="comment">// ----------------------------------------------</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">// Create instance of this ability if necessary</span></span><br><span class="line">		<span class="keyword">if</span> (Ability-&gt;<span class="built_in">GetInstancingPolicy</span>() == EGameplayAbilityInstancingPolicy::InstancedPerExecution)</span><br><span class="line">		&#123;</span><br><span class="line">			InstancedAbility = <span class="built_in">CreateNewInstanceOfAbility</span>(*Spec, Ability);</span><br><span class="line">			InstancedAbility-&gt;<span class="built_in">CallActivateAbility</span>(Handle, ActorInfo, ActivationInfo, OnGameplayAbilityEndedDelegate, TriggerEventData);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (InstancedAbility)</span><br><span class="line">		&#123;</span><br><span class="line">			InstancedAbility-&gt;<span class="built_in">CallActivateAbility</span>(Handle, ActorInfo, ActivationInfo, OnGameplayAbilityEndedDelegate, TriggerEventData);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			Ability-&gt;<span class="built_in">CallActivateAbility</span>(Handle, ActorInfo, ActivationInfo, OnGameplayAbilityEndedDelegate, TriggerEventData);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (Ability-&gt;<span class="built_in">GetNetExecutionPolicy</span>() == EGameplayAbilityNetExecutionPolicy::LocalPredicted)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// Flush server moves that occurred before this ability activation so that the server receives the RPCs in the correct order</span></span><br><span class="line">		<span class="comment">// Necessary to prevent abilities that trigger animation root motion or impact movement from causing network corrections</span></span><br><span class="line">		<span class="keyword">if</span> (!ActorInfo-&gt;<span class="built_in">IsNetAuthority</span>())</span><br><span class="line">		&#123;</span><br><span class="line">			ACharacter* AvatarCharacter = <span class="built_in">Cast</span>&lt;ACharacter&gt;(ActorInfo-&gt;AvatarActor.<span class="built_in">Get</span>());</span><br><span class="line">			<span class="keyword">if</span> (AvatarCharacter)</span><br><span class="line">			&#123;</span><br><span class="line">				UCharacterMovementComponent* AvatarCharMoveComp = <span class="built_in">Cast</span>&lt;UCharacterMovementComponent&gt;(AvatarCharacter-&gt;<span class="built_in">GetMovementComponent</span>());</span><br><span class="line">				<span class="keyword">if</span> (AvatarCharMoveComp)</span><br><span class="line">				&#123;</span><br><span class="line">					AvatarCharMoveComp-&gt;<span class="built_in">FlushServerMoves</span>();</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// This execution is now officially EGameplayAbilityActivationMode:Predicting and has a PredictionKey</span></span><br><span class="line">		<span class="function">FScopedPredictionWindow <span class="title">ScopedPredictionWindow</span><span class="params">(<span class="keyword">this</span>, <span class="literal">true</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">		ActivationInfo.<span class="built_in">SetPredicting</span>(ScopedPredictionKey);</span><br><span class="line">		</span><br><span class="line">		<span class="comment">// This must be called immediately after GeneratePredictionKey to prevent problems with recursively activating abilities</span></span><br><span class="line">		<span class="keyword">if</span> (TriggerEventData)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">ServerTryActivateAbilityWithEventData</span>(Handle, Spec-&gt;InputPressed, ScopedPredictionKey, *TriggerEventData);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">CallServerTryActivateAbility</span>(Handle, Spec-&gt;InputPressed, ScopedPredictionKey);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// When this prediction key is caught up, we better know if the ability was confirmed or rejected</span></span><br><span class="line">		ScopedPredictionKey.<span class="built_in">NewCaughtUpDelegate</span>().<span class="built_in">BindUObject</span>(<span class="keyword">this</span>, &amp;UAbilitySystemComponent::OnClientActivateAbilityCaughtUp, Handle, ScopedPredictionKey.Current);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (Ability-&gt;<span class="built_in">GetInstancingPolicy</span>() == EGameplayAbilityInstancingPolicy::InstancedPerExecution)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">// For now, only NonReplicated + InstancedPerExecution abilities can be Predictive.</span></span><br><span class="line">			<span class="comment">// We lack the code to predict spawning an instance of the execution and then merge/combine</span></span><br><span class="line">			<span class="comment">// with the server spawned version when it arrives.</span></span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (Ability-&gt;<span class="built_in">GetReplicationPolicy</span>() == EGameplayAbilityReplicationPolicy::ReplicateNo)</span><br><span class="line">			&#123;</span><br><span class="line">				InstancedAbility = <span class="built_in">CreateNewInstanceOfAbility</span>(*Spec, Ability);</span><br><span class="line">				InstancedAbility-&gt;<span class="built_in">CallActivateAbility</span>(Handle, ActorInfo, ActivationInfo, OnGameplayAbilityEndedDelegate, TriggerEventData);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">			&#123;</span><br><span class="line">				<span class="built_in">ABILITY_LOG</span>(Error, <span class="built_in">TEXT</span>(<span class="string">&quot;InternalTryActivateAbility called on ability %s that is InstancePerExecution and Replicated. This is an invalid configuration.&quot;</span>), *Ability-&gt;<span class="built_in">GetName</span>() );</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (InstancedAbility)</span><br><span class="line">		&#123;</span><br><span class="line">			InstancedAbility-&gt;<span class="built_in">CallActivateAbility</span>(Handle, ActorInfo, ActivationInfo, OnGameplayAbilityEndedDelegate, TriggerEventData);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> </span><br><span class="line">		&#123;</span><br><span class="line">			Ability-&gt;<span class="built_in">CallActivateAbility</span>(Handle, ActorInfo, ActivationInfo, OnGameplayAbilityEndedDelegate, TriggerEventData);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> (InstancedAbility)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (OutInstancedAbility)</span><br><span class="line">		&#123;</span><br><span class="line">			*OutInstancedAbility = InstancedAbility;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		InstancedAbility-&gt;<span class="built_in">SetCurrentActivationInfo</span>(ActivationInfo);	<span class="comment">// Need to push this to the ability if it was instanced.</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">MarkAbilitySpecDirty</span>(*Spec);</span><br><span class="line"></span><br><span class="line">	AbilityLastActivatedTime = <span class="built_in">GetWorld</span>()-&gt;<span class="built_in">GetTimeSeconds</span>();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">FActiveGameplayEffectHandle <span class="title">UAbilitySystemComponent::ApplyGameplayEffectSpecToSelf</span><span class="params">(<span class="type">const</span> FGameplayEffectSpec &amp;Spec, FPredictionKey PredictionKey)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> WITH_SERVER_CODE</span></span><br><span class="line">	<span class="built_in">SCOPE_CYCLE_COUNTER</span>(STAT_AbilitySystemComp_ApplyGameplayEffectSpecToSelf);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// Scope lock the container after the addition has taken place to prevent the new effect from potentially getting mangled during the remainder</span></span><br><span class="line">	<span class="comment">// of the add operation</span></span><br><span class="line">	<span class="function">FScopedActiveGameplayEffectLock <span class="title">ScopeLock</span><span class="params">(ActiveGameplayEffects)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="function">FScopeCurrentGameplayEffectBeingApplied <span class="title">ScopedGEApplication</span><span class="params">(&amp;Spec, <span class="keyword">this</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="type">const</span> <span class="type">bool</span> bIsNetAuthority = <span class="built_in">IsOwnerActorAuthoritative</span>();</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Check Network Authority</span></span><br><span class="line">	<span class="keyword">if</span> (!<span class="built_in">HasNetworkAuthorityToApplyGameplayEffect</span>(PredictionKey))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">FActiveGameplayEffectHandle</span>();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Don&#x27;t allow prediction of periodic effects</span></span><br><span class="line">	<span class="keyword">if</span>(PredictionKey.<span class="built_in">IsValidKey</span>() &amp;&amp; Spec.<span class="built_in">GetPeriod</span>() &gt; <span class="number">0.f</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span>(<span class="built_in">IsOwnerActorAuthoritative</span>())</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">// Server continue with invalid prediction key</span></span><br><span class="line">			PredictionKey = <span class="built_in">FPredictionKey</span>();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">// Client just return now</span></span><br><span class="line">			<span class="keyword">return</span> <span class="built_in">FActiveGameplayEffectHandle</span>();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Are we currently immune to this? (ApplicationImmunity)</span></span><br><span class="line">	<span class="type">const</span> FActiveGameplayEffect* ImmunityGE=<span class="literal">nullptr</span>;</span><br><span class="line">	<span class="keyword">if</span> (ActiveGameplayEffects.<span class="built_in">HasApplicationImmunityToSpec</span>(Spec, ImmunityGE))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">OnImmunityBlockGameplayEffect</span>(Spec, ImmunityGE);</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">FActiveGameplayEffectHandle</span>();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Check AttributeSet requirements: make sure all attributes are valid</span></span><br><span class="line">	<span class="comment">// We may want to cache this off in some way to make the runtime check quicker.</span></span><br><span class="line">	<span class="comment">// We also need to handle things in the execution list</span></span><br><span class="line">	<span class="keyword">for</span> (<span class="type">const</span> FGameplayModifierInfo&amp; Mod : Spec.Def-&gt;Modifiers)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (!Mod.Attribute.<span class="built_in">IsValid</span>())</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">ABILITY_LOG</span>(Warning, <span class="built_in">TEXT</span>(<span class="string">&quot;%s has a null modifier attribute.&quot;</span>), *Spec.Def-&gt;<span class="built_in">GetPathName</span>());</span><br><span class="line">			<span class="keyword">return</span> <span class="built_in">FActiveGameplayEffectHandle</span>();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// check if the effect being applied actually succeeds</span></span><br><span class="line">	<span class="type">float</span> ChanceToApply = Spec.<span class="built_in">GetChanceToApplyToTarget</span>();</span><br><span class="line">	<span class="keyword">if</span> ((ChanceToApply &lt; <span class="number">1.f</span> - SMALL_NUMBER) &amp;&amp; (FMath::<span class="built_in">FRand</span>() &gt; ChanceToApply))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">FActiveGameplayEffectHandle</span>();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Get MyTags.</span></span><br><span class="line">	<span class="comment">//	We may want to cache off a GameplayTagContainer instead of rebuilding it every time.</span></span><br><span class="line">	<span class="comment">//	But this will also be where we need to merge in context tags? (Headshot, executing ability, etc?)</span></span><br><span class="line">	<span class="comment">//	Or do we push these tags into (our copy of the spec)?</span></span><br><span class="line"></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// Note: static is ok here since the scope is so limited, but wider usage of MyTags is not safe since this function can be recursively called</span></span><br><span class="line">		<span class="type">static</span> FGameplayTagContainer MyTags;</span><br><span class="line">		MyTags.<span class="built_in">Reset</span>();</span><br><span class="line"></span><br><span class="line">		<span class="built_in">GetOwnedGameplayTags</span>(MyTags);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (Spec.Def-&gt;ApplicationTagRequirements.<span class="built_in">RequirementsMet</span>(MyTags) == <span class="literal">false</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="built_in">FActiveGameplayEffectHandle</span>();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (!Spec.Def-&gt;RemovalTagRequirements.<span class="built_in">IsEmpty</span>() &amp;&amp; Spec.Def-&gt;RemovalTagRequirements.<span class="built_in">RequirementsMet</span>(MyTags) == <span class="literal">true</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="built_in">FActiveGameplayEffectHandle</span>();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Custom application requirement check</span></span><br><span class="line">	<span class="keyword">for</span> (<span class="type">const</span> TSubclassOf&lt;UGameplayEffectCustomApplicationRequirement&gt;&amp; AppReq : Spec.Def-&gt;ApplicationRequirements)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (*AppReq &amp;&amp; AppReq-&gt;<span class="built_in">GetDefaultObject</span>&lt;UGameplayEffectCustomApplicationRequirement&gt;()-&gt;<span class="built_in">CanApplyGameplayEffect</span>(Spec.Def, Spec, <span class="keyword">this</span>) == <span class="literal">false</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="built_in">FActiveGameplayEffectHandle</span>();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	bIsNetDirty = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Clients should treat predicted instant effects as if they have infinite duration. The effects will be cleaned up later.</span></span><br><span class="line">	<span class="type">bool</span> bTreatAsInfiniteDuration = <span class="built_in">GetOwnerRole</span>() != ROLE_Authority &amp;&amp; PredictionKey.<span class="built_in">IsLocalClientKey</span>() &amp;&amp; Spec.Def-&gt;DurationPolicy == EGameplayEffectDurationType::Instant;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Make sure we create our copy of the spec in the right place</span></span><br><span class="line">	<span class="comment">// We initialize the FActiveGameplayEffectHandle here with INDEX_NONE to handle the case of instant GE</span></span><br><span class="line">	<span class="comment">// Initializing it like this will set the bPassedFiltersAndWasExecuted on the FActiveGameplayEffectHandle to true so we can know that we applied a GE</span></span><br><span class="line">	<span class="function">FActiveGameplayEffectHandle	<span class="title">MyHandle</span><span class="params">(INDEX_NONE)</span></span>;</span><br><span class="line">	<span class="type">bool</span> bInvokeGameplayCueApplied = Spec.Def-&gt;DurationPolicy != EGameplayEffectDurationType::Instant; <span class="comment">// Cache this now before possibly modifying predictive instant effect to infinite duration effect.</span></span><br><span class="line">	<span class="type">bool</span> bFoundExistingStackableGE = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">	FActiveGameplayEffect* AppliedEffect = <span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line">	FGameplayEffectSpec* OurCopyOfSpec = <span class="literal">nullptr</span>;</span><br><span class="line">	TSharedPtr&lt;FGameplayEffectSpec&gt; StackSpec;</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (Spec.Def-&gt;DurationPolicy != EGameplayEffectDurationType::Instant || bTreatAsInfiniteDuration)</span><br><span class="line">		&#123;</span><br><span class="line">			AppliedEffect = ActiveGameplayEffects.<span class="built_in">ApplyGameplayEffectSpec</span>(Spec, PredictionKey, bFoundExistingStackableGE);</span><br><span class="line">			<span class="keyword">if</span> (!AppliedEffect)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">return</span> <span class="built_in">FActiveGameplayEffectHandle</span>();</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			MyHandle = AppliedEffect-&gt;Handle;</span><br><span class="line">			OurCopyOfSpec = &amp;(AppliedEffect-&gt;Spec);</span><br><span class="line"></span><br><span class="line">			<span class="comment">// Log results of applied GE spec</span></span><br><span class="line">			<span class="keyword">if</span> (<span class="built_in">UE_LOG_ACTIVE</span>(VLogAbilitySystem, Log))</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="built_in">ABILITY_VLOG</span>(<span class="built_in">GetOwnerActor</span>(), Log, <span class="built_in">TEXT</span>(<span class="string">&quot;Applied %s&quot;</span>), *OurCopyOfSpec-&gt;Def-&gt;<span class="built_in">GetFName</span>().<span class="built_in">ToString</span>());</span><br><span class="line"></span><br><span class="line">				<span class="keyword">for</span> (<span class="type">const</span> FGameplayModifierInfo&amp; Modifier : Spec.Def-&gt;Modifiers)</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="type">float</span> Magnitude = <span class="number">0.f</span>;</span><br><span class="line">					Modifier.ModifierMagnitude.<span class="built_in">AttemptCalculateMagnitude</span>(Spec, Magnitude);</span><br><span class="line">					<span class="built_in">ABILITY_VLOG</span>(<span class="built_in">GetOwnerActor</span>(), Log, <span class="built_in">TEXT</span>(<span class="string">&quot;         %s: %s %f&quot;</span>), *Modifier.Attribute.<span class="built_in">GetName</span>(), *<span class="built_in">EGameplayModOpToString</span>(Modifier.ModifierOp), Magnitude);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (!OurCopyOfSpec)</span><br><span class="line">		&#123;</span><br><span class="line">			StackSpec = <span class="built_in">TSharedPtr</span>&lt;FGameplayEffectSpec&gt;(<span class="keyword">new</span> <span class="built_in">FGameplayEffectSpec</span>(Spec));</span><br><span class="line">			OurCopyOfSpec = StackSpec.<span class="built_in">Get</span>();</span><br><span class="line">			UAbilitySystemGlobals::<span class="built_in">Get</span>().<span class="built_in">GlobalPreGameplayEffectSpecApply</span>(*OurCopyOfSpec, <span class="keyword">this</span>);</span><br><span class="line">			OurCopyOfSpec-&gt;<span class="built_in">CaptureAttributeDataFromTarget</span>(<span class="keyword">this</span>);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// if necessary add a modifier to OurCopyOfSpec to force it to have an infinite duration</span></span><br><span class="line">		<span class="keyword">if</span> (bTreatAsInfiniteDuration)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">// This should just be a straight set of the duration float now</span></span><br><span class="line">			OurCopyOfSpec-&gt;<span class="built_in">SetDuration</span>(UGameplayEffect::INFINITE_DURATION, <span class="literal">true</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (OurCopyOfSpec)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// Update (not push) the global spec being applied [we want to switch it to our copy, from the const input copy)</span></span><br><span class="line">		UAbilitySystemGlobals::<span class="built_in">Get</span>().<span class="built_in">SetCurrentAppliedGE</span>(OurCopyOfSpec);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">	<span class="comment">// We still probably want to apply tags and stuff even if instant?</span></span><br><span class="line">	<span class="comment">// If bSuppressStackingCues is set for this GameplayEffect, only add the GameplayCue if this is the first instance of the GameplayEffect</span></span><br><span class="line">	<span class="keyword">if</span> (!bSuppressGameplayCues &amp;&amp; bInvokeGameplayCueApplied &amp;&amp; AppliedEffect &amp;&amp; !AppliedEffect-&gt;bIsInhibited &amp;&amp; </span><br><span class="line">		(!bFoundExistingStackableGE || !Spec.Def-&gt;bSuppressStackingCues))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// We both added and activated the GameplayCue here.</span></span><br><span class="line">		<span class="comment">// On the client, which will invoke the gameplay cue from an OnRep, it will need to look at the StartTime to determine</span></span><br><span class="line">		<span class="comment">// if the Cue was actually added+activated or just added (due to relevancy)</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">// Fixme: what if we wanted to scale Cue magnitude based on damage? E.g, scale an cue effect when the GE is buffed?</span></span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (OurCopyOfSpec-&gt;StackCount &gt; Spec.StackCount)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">// Because PostReplicatedChange will get called from modifying the stack count</span></span><br><span class="line">			<span class="comment">// (and not PostReplicatedAdd) we won&#x27;t know which GE was modified.</span></span><br><span class="line">			<span class="comment">// So instead we need to explicitly RPC the client so it knows the GC needs updating</span></span><br><span class="line">			UAbilitySystemGlobals::<span class="built_in">Get</span>().<span class="built_in">GetGameplayCueManager</span>()-&gt;<span class="built_in">InvokeGameplayCueAddedAndWhileActive_FromSpec</span>(<span class="keyword">this</span>, *OurCopyOfSpec, PredictionKey);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">// Otherwise these will get replicated to the client when the GE gets added to the replicated array</span></span><br><span class="line">			<span class="built_in">InvokeGameplayCueEvent</span>(*OurCopyOfSpec, EGameplayCueEvent::OnActive);</span><br><span class="line">			<span class="built_in">InvokeGameplayCueEvent</span>(*OurCopyOfSpec, EGameplayCueEvent::WhileActive);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// Execute the GE at least once (if instant, this will execute once and be done. If persistent, it was added to ActiveGameplayEffects above)</span></span><br><span class="line">	</span><br><span class="line">	<span class="comment">// Execute if this is an instant application effect</span></span><br><span class="line">	<span class="keyword">if</span> (bTreatAsInfiniteDuration)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// This is an instant application but we are treating it as an infinite duration for prediction. We should still predict the execute GameplayCUE.</span></span><br><span class="line">		<span class="comment">// (in non predictive case, this will happen inside ::ExecuteGameplayEffect)</span></span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (!bSuppressGameplayCues)</span><br><span class="line">		&#123;</span><br><span class="line">			UAbilitySystemGlobals::<span class="built_in">Get</span>().<span class="built_in">GetGameplayCueManager</span>()-&gt;<span class="built_in">InvokeGameplayCueExecuted_FromSpec</span>(<span class="keyword">this</span>, *OurCopyOfSpec, PredictionKey);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (Spec.Def-&gt;DurationPolicy == EGameplayEffectDurationType::Instant)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (OurCopyOfSpec-&gt;Def-&gt;OngoingTagRequirements.<span class="built_in">IsEmpty</span>())</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">ExecuteGameplayEffect</span>(*OurCopyOfSpec, PredictionKey);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">ABILITY_LOG</span>(Warning, <span class="built_in">TEXT</span>(<span class="string">&quot;%s is instant but has tag requirements. Tag requirements can only be used with gameplay effects that have a duration. This gameplay effect will be ignored.&quot;</span>), *Spec.Def-&gt;<span class="built_in">GetPathName</span>());</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (Spec.<span class="built_in">GetPeriod</span>() != UGameplayEffect::NO_PERIOD &amp;&amp; Spec.TargetEffectSpecs.<span class="built_in">Num</span>() &gt; <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">ABILITY_LOG</span>(Warning, <span class="built_in">TEXT</span>(<span class="string">&quot;%s is periodic but also applies GameplayEffects to its target. GameplayEffects will only be applied once, not every period.&quot;</span>), *Spec.Def-&gt;<span class="built_in">GetPathName</span>());</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// evaluate if any active effects need to be removed by the application of this effect</span></span><br><span class="line">	<span class="keyword">if</span> (bIsNetAuthority)</span><br><span class="line">	&#123;</span><br><span class="line">		ActiveGameplayEffects.<span class="built_in">AttemptRemoveActiveEffectsOnEffectApplication</span>(*OurCopyOfSpec, MyHandle);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// ------------------------------------------------------</span></span><br><span class="line">	<span class="comment">// Apply Linked effects</span></span><br><span class="line">	<span class="comment">// todo: this is ignoring the returned handles, should we put them into a TArray and return all of the handles?</span></span><br><span class="line">	<span class="comment">// ------------------------------------------------------</span></span><br><span class="line">	<span class="keyword">for</span> (<span class="type">const</span> FGameplayEffectSpecHandle&amp; TargetSpec: Spec.TargetEffectSpecs)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (TargetSpec.<span class="built_in">IsValid</span>())</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">ApplyGameplayEffectSpecToSelf</span>(*TargetSpec.Data.<span class="built_in">Get</span>(), PredictionKey);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	UAbilitySystemComponent* InstigatorASC = Spec.<span class="built_in">GetContext</span>().<span class="built_in">GetInstigatorAbilitySystemComponent</span>();</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Send ourselves a callback	</span></span><br><span class="line">	<span class="built_in">OnGameplayEffectAppliedToSelf</span>(InstigatorASC, *OurCopyOfSpec, MyHandle);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Send the instigator a callback</span></span><br><span class="line">	<span class="keyword">if</span> (InstigatorASC)</span><br><span class="line">	&#123;</span><br><span class="line">		InstigatorASC-&gt;<span class="built_in">OnGameplayEffectAppliedToTarget</span>(<span class="keyword">this</span>, *OurCopyOfSpec, MyHandle);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> MyHandle;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">UAbilitySystemComponent::ExecuteGameplayEffect</span><span class="params">(FGameplayEffectSpec &amp;Spec, FPredictionKey PredictionKey)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> WITH_SERVER_CODE</span></span><br><span class="line">	<span class="built_in">SCOPE_CYCLE_COUNTER</span>(STAT_AbilitySystemComp_ExecuteGameplayEffect);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// Should only ever execute effects that are instant application or periodic application</span></span><br><span class="line">	<span class="comment">// Effects with no period and that aren&#x27;t instant application should never be executed</span></span><br><span class="line">	<span class="built_in">check</span>( (Spec.<span class="built_in">GetDuration</span>() == UGameplayEffect::INSTANT_APPLICATION || Spec.<span class="built_in">GetPeriod</span>() != UGameplayEffect::NO_PERIOD) );</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">UE_LOG_ACTIVE</span>(VLogAbilitySystem, Log))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">ABILITY_VLOG</span>(<span class="built_in">GetOwnerActor</span>(), Log, <span class="built_in">TEXT</span>(<span class="string">&quot;Executed %s&quot;</span>), *Spec.Def-&gt;<span class="built_in">GetFName</span>().<span class="built_in">ToString</span>());</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">for</span> (<span class="type">const</span> FGameplayModifierInfo&amp; Modifier : Spec.Def-&gt;Modifiers)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="type">float</span> Magnitude = <span class="number">0.f</span>;</span><br><span class="line">			Modifier.ModifierMagnitude.<span class="built_in">AttemptCalculateMagnitude</span>(Spec, Magnitude);</span><br><span class="line">			<span class="built_in">ABILITY_VLOG</span>(<span class="built_in">GetOwnerActor</span>(), Log, <span class="built_in">TEXT</span>(<span class="string">&quot;         %s: %s %f&quot;</span>), *Modifier.Attribute.<span class="built_in">GetName</span>(), *<span class="built_in">EGameplayModOpToString</span>(Modifier.ModifierOp), Magnitude);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	bIsNetDirty = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">	ActiveGameplayEffects.<span class="built_in">ExecuteActiveEffectsFrom</span>(Spec, PredictionKey);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Engine\Plugins\Runtime\GameplayAbilities\Source\GameplayAbilities\Private\Abilities\GameplayAbility.cpp</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">UGameplayAbility::CallActivateAbility</span><span class="params">(<span class="type">const</span> FGameplayAbilitySpecHandle Handle, <span class="type">const</span> FGameplayAbilityActorInfo* ActorInfo, <span class="type">const</span> FGameplayAbilityActivationInfo ActivationInfo, FOnGameplayAbilityEnded::FDelegate* OnGameplayAbilityEndedDelegate, <span class="type">const</span> FGameplayEventData* TriggerEventData)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">PreActivate</span>(Handle, ActorInfo, ActivationInfo, OnGameplayAbilityEndedDelegate, TriggerEventData);</span><br><span class="line">	<span class="built_in">ActivateAbility</span>(Handle, ActorInfo, ActivationInfo, TriggerEventData);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">UGameplayAbility::ActivateAbility</span><span class="params">(<span class="type">const</span> FGameplayAbilitySpecHandle Handle, <span class="type">const</span> FGameplayAbilityActorInfo* ActorInfo, <span class="type">const</span> FGameplayAbilityActivationInfo ActivationInfo, <span class="type">const</span> FGameplayEventData* TriggerEventData)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (bHasBlueprintActivate)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// A Blueprinted ActivateAbility function must call CommitAbility somewhere in its execution chain.</span></span><br><span class="line">		<span class="built_in">K2_ActivateAbility</span>();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (bHasBlueprintActivateFromEvent)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (TriggerEventData)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">// A Blueprinted ActivateAbility function must call CommitAbility somewhere in its execution chain.</span></span><br><span class="line">			<span class="built_in">K2_ActivateAbilityFromEvent</span>(*TriggerEventData);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">UE_LOG</span>(LogAbilitySystem, Warning, <span class="built_in">TEXT</span>(<span class="string">&quot;Ability %s expects event data but none is being supplied. Use Activate Ability instead of Activate Ability From Event.&quot;</span>), *<span class="built_in">GetName</span>());</span><br><span class="line">			<span class="type">bool</span> bReplicateEndAbility = <span class="literal">false</span>;</span><br><span class="line">			<span class="type">bool</span> bWasCancelled = <span class="literal">true</span>;</span><br><span class="line">			<span class="built_in">EndAbility</span>(Handle, ActorInfo, ActivationInfo, bReplicateEndAbility, bWasCancelled);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// Native child classes may want to override ActivateAbility and do something like this:</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">// Do stuff...</span></span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">CommitAbility</span>(Handle, ActorInfo, ActivationInfo))		<span class="comment">// ..then commit the ability...</span></span><br><span class="line">		&#123;			</span><br><span class="line">			<span class="comment">//	Then do more stuff...</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">bool</span> UGameplayAbility::<span class="built_in">CommitAbility</span>(<span class="type">const</span> FGameplayAbilitySpecHandle Handle, <span class="type">const</span> FGameplayAbilityActorInfo* ActorInfo, <span class="type">const</span> FGameplayAbilityActivationInfo ActivationInfo, OUT FGameplayTagContainer* OptionalRelevantTags)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">// Last chance to fail (maybe we no longer have resources to commit since we after we started this ability activation)</span></span><br><span class="line">	<span class="keyword">if</span> (!<span class="built_in">CommitCheck</span>(Handle, ActorInfo, ActivationInfo, OptionalRelevantTags))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">CommitExecute</span>(Handle, ActorInfo, ActivationInfo);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Fixme: Should we always call this or only if it is implemented? A noop may not hurt but could be bad for perf (storing a HasBlueprintCommit per instance isn&#x27;t good either)</span></span><br><span class="line">	<span class="built_in">K2_CommitExecute</span>();</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Broadcast this commitment</span></span><br><span class="line">	ActorInfo-&gt;AbilitySystemComponent-&gt;<span class="built_in">NotifyAbilityCommit</span>(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">UGameplayAbility::CommitExecute</span><span class="params">(<span class="type">const</span> FGameplayAbilitySpecHandle Handle, <span class="type">const</span> FGameplayAbilityActorInfo* ActorInfo, <span class="type">const</span> FGameplayAbilityActivationInfo ActivationInfo)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">ApplyCooldown</span>(Handle, ActorInfo, ActivationInfo);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">ApplyCost</span>(Handle, ActorInfo, ActivationInfo);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">UGameplayAbility::ApplyCooldown</span><span class="params">(<span class="type">const</span> FGameplayAbilitySpecHandle Handle, <span class="type">const</span> FGameplayAbilityActorInfo* ActorInfo, <span class="type">const</span> FGameplayAbilityActivationInfo ActivationInfo)</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	UGameplayEffect* CooldownGE = <span class="built_in">GetCooldownGameplayEffect</span>();</span><br><span class="line">	<span class="keyword">if</span> (CooldownGE)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">ApplyGameplayEffectToOwner</span>(Handle, ActorInfo, ActivationInfo, CooldownGE, <span class="built_in">GetAbilityLevel</span>(Handle, ActorInfo));</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">UGameplayAbility::ApplyCost</span><span class="params">(<span class="type">const</span> FGameplayAbilitySpecHandle Handle, <span class="type">const</span> FGameplayAbilityActorInfo* ActorInfo, <span class="type">const</span> FGameplayAbilityActivationInfo ActivationInfo)</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	UGameplayEffect* CostGE = <span class="built_in">GetCostGameplayEffect</span>();</span><br><span class="line">	<span class="keyword">if</span> (CostGE)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">ApplyGameplayEffectToOwner</span>(Handle, ActorInfo, ActivationInfo, CostGE, <span class="built_in">GetAbilityLevel</span>(Handle, ActorInfo));</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">FActiveGameplayEffectHandle <span class="title">UGameplayAbility::ApplyGameplayEffectToOwner</span><span class="params">(<span class="type">const</span> FGameplayAbilitySpecHandle Handle, <span class="type">const</span> FGameplayAbilityActorInfo* ActorInfo, <span class="type">const</span> FGameplayAbilityActivationInfo ActivationInfo, <span class="type">const</span> UGameplayEffect* GameplayEffect, <span class="type">float</span> GameplayEffectLevel, int32 Stacks)</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (GameplayEffect &amp;&amp; (<span class="built_in">HasAuthorityOrPredictionKey</span>(ActorInfo, &amp;ActivationInfo)))</span><br><span class="line">	&#123;</span><br><span class="line">		FGameplayEffectSpecHandle SpecHandle = <span class="built_in">MakeOutgoingGameplayEffectSpec</span>(Handle, ActorInfo, ActivationInfo, GameplayEffect-&gt;<span class="built_in">GetClass</span>(), GameplayEffectLevel);</span><br><span class="line">		<span class="keyword">if</span> (SpecHandle.<span class="built_in">IsValid</span>())</span><br><span class="line">		&#123;</span><br><span class="line">			SpecHandle.Data-&gt;StackCount = Stacks;</span><br><span class="line">			<span class="keyword">return</span> <span class="built_in">ApplyGameplayEffectSpecToOwner</span>(Handle, ActorInfo, ActivationInfo, SpecHandle);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// We cannot apply GameplayEffects in this context. Return an empty handle.</span></span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">FActiveGameplayEffectHandle</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">FActiveGameplayEffectHandle <span class="title">UGameplayAbility::ApplyGameplayEffectSpecToOwner</span><span class="params">(<span class="type">const</span> FGameplayAbilitySpecHandle AbilityHandle, <span class="type">const</span> FGameplayAbilityActorInfo* ActorInfo, <span class="type">const</span> FGameplayAbilityActivationInfo ActivationInfo, <span class="type">const</span> FGameplayEffectSpecHandle SpecHandle)</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// This batches all created cues together</span></span><br><span class="line">	FScopedGameplayCueSendContext GameplayCueSendContext;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (SpecHandle.<span class="built_in">IsValid</span>() &amp;&amp; (<span class="built_in">HasAuthorityOrPredictionKey</span>(ActorInfo, &amp;ActivationInfo)))</span><br><span class="line">	&#123;</span><br><span class="line">		UAbilitySystemComponent* <span class="type">const</span> AbilitySystemComponent = ActorInfo-&gt;AbilitySystemComponent.<span class="built_in">Get</span>();</span><br><span class="line">		<span class="keyword">return</span> AbilitySystemComponent-&gt;<span class="built_in">ApplyGameplayEffectSpecToSelf</span>(*SpecHandle.Data.<span class="built_in">Get</span>(), AbilitySystemComponent-&gt;<span class="built_in">GetPredictionKeyForNewAction</span>());</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">FActiveGameplayEffectHandle</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Engine\Plugins\Runtime\GameplayAbilities\Source\GameplayAbilities\Private\GameplayEffect.cpp</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** This is the main function that executes a GameplayEffect on Attributes and ActiveGameplayEffects */</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">FActiveGameplayEffectsContainer::ExecuteActiveEffectsFrom</span><span class="params">(FGameplayEffectSpec &amp;Spec, FPredictionKey PredictionKey)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> WITH_SERVER_CODE</span></span><br><span class="line">	<span class="built_in">SCOPE_CYCLE_COUNTER</span>(STAT_ExecuteActiveEffectsFrom);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!Owner)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	FGameplayEffectSpec&amp; SpecToUse = Spec;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Capture our own tags.</span></span><br><span class="line">	<span class="comment">// <span class="doctag">TODO:</span> We should only capture them if we need to. We may have snapshotted target tags (?) (in the case of dots with exotic setups?)</span></span><br><span class="line"></span><br><span class="line">	SpecToUse.CapturedTargetTags.<span class="built_in">GetActorTags</span>().<span class="built_in">Reset</span>();</span><br><span class="line">	Owner-&gt;<span class="built_in">GetOwnedGameplayTags</span>(SpecToUse.CapturedTargetTags.<span class="built_in">GetActorTags</span>());</span><br><span class="line"></span><br><span class="line">	SpecToUse.<span class="built_in">CalculateModifierMagnitudes</span>();</span><br><span class="line"></span><br><span class="line">	<span class="comment">// ------------------------------------------------------</span></span><br><span class="line">	<span class="comment">//	Modifiers</span></span><br><span class="line">	<span class="comment">//		These will modify the base value of attributes</span></span><br><span class="line">	<span class="comment">// ------------------------------------------------------</span></span><br><span class="line">	</span><br><span class="line">	<span class="type">bool</span> ModifierSuccessfullyExecuted = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (int32 ModIdx = <span class="number">0</span>; ModIdx &lt; SpecToUse.Modifiers.<span class="built_in">Num</span>(); ++ModIdx)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="type">const</span> FGameplayModifierInfo&amp; ModDef = SpecToUse.Def-&gt;Modifiers[ModIdx];</span><br><span class="line">		</span><br><span class="line">		<span class="function">FGameplayModifierEvaluatedData <span class="title">EvalData</span><span class="params">(ModDef.Attribute, ModDef.ModifierOp, SpecToUse.GetModifierMagnitude(ModIdx, <span class="literal">true</span>))</span></span>;</span><br><span class="line">		ModifierSuccessfullyExecuted |= <span class="built_in">InternalExecuteMod</span>(SpecToUse, EvalData);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// ------------------------------------------------------</span></span><br><span class="line">	<span class="comment">//	Executions</span></span><br><span class="line">	<span class="comment">//		This will run custom code to &#x27;do stuff&#x27;</span></span><br><span class="line">	<span class="comment">// ------------------------------------------------------</span></span><br><span class="line">	</span><br><span class="line">	TArray&lt; FGameplayEffectSpecHandle, TInlineAllocator&lt;<span class="number">4</span>&gt; &gt; ConditionalEffectSpecs;</span><br><span class="line"></span><br><span class="line">	<span class="type">bool</span> GameplayCuesWereManuallyHandled = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (<span class="type">const</span> FGameplayEffectExecutionDefinition&amp; CurExecDef : SpecToUse.Def-&gt;Executions)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="type">bool</span> bRunConditionalEffects = <span class="literal">true</span>; <span class="comment">// Default to true if there is no CalculationClass specified.</span></span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (CurExecDef.CalculationClass)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="type">const</span> UGameplayEffectExecutionCalculation* ExecCDO = CurExecDef.CalculationClass-&gt;<span class="built_in">GetDefaultObject</span>&lt;UGameplayEffectExecutionCalculation&gt;();</span><br><span class="line">			<span class="built_in">check</span>(ExecCDO);</span><br><span class="line"></span><br><span class="line">			<span class="comment">// Run the custom execution</span></span><br><span class="line">			<span class="function">FGameplayEffectCustomExecutionParameters <span class="title">ExecutionParams</span><span class="params">(SpecToUse, CurExecDef.CalculationModifiers, Owner, CurExecDef.PassedInTags, PredictionKey)</span></span>;</span><br><span class="line">			FGameplayEffectCustomExecutionOutput ExecutionOutput;</span><br><span class="line">			ExecCDO-&gt;<span class="built_in">Execute</span>(ExecutionParams, ExecutionOutput);</span><br><span class="line"></span><br><span class="line">			bRunConditionalEffects = ExecutionOutput.<span class="built_in">ShouldTriggerConditionalGameplayEffects</span>();</span><br><span class="line"></span><br><span class="line">			<span class="comment">// Execute any mods the custom execution yielded</span></span><br><span class="line">			TArray&lt;FGameplayModifierEvaluatedData&gt;&amp; OutModifiers = ExecutionOutput.<span class="built_in">GetOutputModifiersRef</span>();</span><br><span class="line"></span><br><span class="line">			<span class="type">const</span> <span class="type">bool</span> bApplyStackCountToEmittedMods = !ExecutionOutput.<span class="built_in">IsStackCountHandledManually</span>();</span><br><span class="line">			<span class="type">const</span> int32 SpecStackCount = SpecToUse.StackCount;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">for</span> (FGameplayModifierEvaluatedData&amp; CurExecMod : OutModifiers)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="comment">// If the execution didn&#x27;t manually handle the stack count, automatically apply it here</span></span><br><span class="line">				<span class="keyword">if</span> (bApplyStackCountToEmittedMods &amp;&amp; SpecStackCount &gt; <span class="number">1</span>)</span><br><span class="line">				&#123;</span><br><span class="line">					CurExecMod.Magnitude = GameplayEffectUtilities::<span class="built_in">ComputeStackedModifierMagnitude</span>(CurExecMod.Magnitude, SpecStackCount, CurExecMod.ModifierOp);</span><br><span class="line">				&#125;</span><br><span class="line">				ModifierSuccessfullyExecuted |= <span class="built_in">InternalExecuteMod</span>(SpecToUse, CurExecMod);</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// If execution handled GameplayCues, we dont have to.</span></span><br><span class="line">			<span class="keyword">if</span> (ExecutionOutput.<span class="built_in">AreGameplayCuesHandledManually</span>())</span><br><span class="line">			&#123;</span><br><span class="line">				GameplayCuesWereManuallyHandled = <span class="literal">true</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (bRunConditionalEffects)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">// If successful, apply conditional specs</span></span><br><span class="line">			<span class="keyword">for</span> (<span class="type">const</span> FConditionalGameplayEffect&amp; ConditionalEffect : CurExecDef.ConditionalGameplayEffects)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">if</span> (ConditionalEffect.<span class="built_in">CanApply</span>(SpecToUse.CapturedSourceTags.<span class="built_in">GetActorTags</span>(), SpecToUse.<span class="built_in">GetLevel</span>()))</span><br><span class="line">				&#123;</span><br><span class="line">					FGameplayEffectSpecHandle SpecHandle = ConditionalEffect.<span class="built_in">CreateSpec</span>(SpecToUse.<span class="built_in">GetEffectContext</span>(), SpecToUse.<span class="built_in">GetLevel</span>());</span><br><span class="line">					<span class="keyword">if</span> (SpecHandle.<span class="built_in">IsValid</span>())</span><br><span class="line">					&#123;</span><br><span class="line">						ConditionalEffectSpecs.<span class="built_in">Add</span>(SpecHandle);</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// ------------------------------------------------------</span></span><br><span class="line">	<span class="comment">//	Invoke GameplayCue events</span></span><br><span class="line">	<span class="comment">// ------------------------------------------------------</span></span><br><span class="line">	</span><br><span class="line">	<span class="comment">// If there are no modifiers or we don&#x27;t require modifier success to trigger, we apply the GameplayCue.</span></span><br><span class="line">	<span class="type">const</span> <span class="type">bool</span> bHasModifiers = SpecToUse.Modifiers.<span class="built_in">Num</span>() &gt; <span class="number">0</span>;</span><br><span class="line">	<span class="type">const</span> <span class="type">bool</span> bHasExecutions = SpecToUse.Def-&gt;Executions.<span class="built_in">Num</span>() &gt; <span class="number">0</span>;</span><br><span class="line">	<span class="type">const</span> <span class="type">bool</span> bHasModifiersOrExecutions = bHasModifiers || bHasExecutions;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// If there are no modifiers or we don&#x27;t require modifier success to trigger, we apply the GameplayCue.</span></span><br><span class="line">	<span class="type">bool</span> InvokeGameplayCueExecute = (!bHasModifiersOrExecutions) || !Spec.Def-&gt;bRequireModifierSuccessToTriggerCues;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (bHasModifiersOrExecutions &amp;&amp; ModifierSuccessfullyExecuted)</span><br><span class="line">	&#123;</span><br><span class="line">		InvokeGameplayCueExecute = <span class="literal">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Don&#x27;t trigger gameplay cues if one of the executions says it manually handled them</span></span><br><span class="line">	<span class="keyword">if</span> (GameplayCuesWereManuallyHandled)</span><br><span class="line">	&#123;</span><br><span class="line">		InvokeGameplayCueExecute = <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (InvokeGameplayCueExecute &amp;&amp; SpecToUse.Def-&gt;GameplayCues.<span class="built_in">Num</span>())</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// <span class="doctag">TODO:</span> check replication policy. Right now we will replicate every execute via a multicast RPC</span></span><br><span class="line"></span><br><span class="line">		<span class="built_in">ABILITY_LOG</span>(Log, <span class="built_in">TEXT</span>(<span class="string">&quot;Invoking Execute GameplayCue for %s&quot;</span>), *SpecToUse.<span class="built_in">ToSimpleString</span>());</span><br><span class="line"></span><br><span class="line">		UAbilitySystemGlobals::<span class="built_in">Get</span>().<span class="built_in">GetGameplayCueManager</span>()-&gt;<span class="built_in">InvokeGameplayCueExecuted_FromSpec</span>(Owner, SpecToUse, PredictionKey);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Apply any conditional linked effects</span></span><br><span class="line">	<span class="keyword">for</span> (<span class="type">const</span> FGameplayEffectSpecHandle&amp; TargetSpec : ConditionalEffectSpecs)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (TargetSpec.<span class="built_in">IsValid</span>())</span><br><span class="line">		&#123;</span><br><span class="line">			Owner-&gt;<span class="built_in">ApplyGameplayEffectSpecToSelf</span>(*TargetSpec.Data.<span class="built_in">Get</span>(), PredictionKey);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">FActiveGameplayEffectsContainer::InternalExecuteMod</span><span class="params">(FGameplayEffectSpec&amp; Spec, FGameplayModifierEvaluatedData&amp; ModEvalData)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">SCOPE_CYCLE_COUNTER</span>(STAT_InternalExecuteMod);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">check</span>(Owner);</span><br><span class="line"></span><br><span class="line">	<span class="type">bool</span> bExecuted = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">	UAttributeSet* AttributeSet = <span class="literal">nullptr</span>;</span><br><span class="line">	UClass* AttributeSetClass = ModEvalData.Attribute.<span class="built_in">GetAttributeSetClass</span>();</span><br><span class="line">	<span class="keyword">if</span> (AttributeSetClass &amp;&amp; AttributeSetClass-&gt;<span class="built_in">IsChildOf</span>(UAttributeSet::<span class="built_in">StaticClass</span>()))</span><br><span class="line">	&#123;</span><br><span class="line">		AttributeSet = <span class="built_in">const_cast</span>&lt;UAttributeSet*&gt;(Owner-&gt;<span class="built_in">GetAttributeSubobject</span>(AttributeSetClass));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (AttributeSet)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="function">FGameplayEffectModCallbackData <span class="title">ExecuteData</span><span class="params">(Spec, ModEvalData, *Owner)</span></span>;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/**</span></span><br><span class="line"><span class="comment">		 *  This should apply &#x27;gamewide&#x27; rules. Such as clamping Health to MaxHealth or granting +3 health for every point of strength, etc</span></span><br><span class="line"><span class="comment">		 *	PreAttributeModify can return false to &#x27;throw out&#x27; this modification.</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		<span class="keyword">if</span> (AttributeSet-&gt;<span class="built_in">PreGameplayEffectExecute</span>(ExecuteData))</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="type">float</span> OldValueOfProperty = Owner-&gt;<span class="built_in">GetNumericAttribute</span>(ModEvalData.Attribute);</span><br><span class="line">			<span class="built_in">ApplyModToAttribute</span>(ModEvalData.Attribute, ModEvalData.ModifierOp, ModEvalData.Magnitude, &amp;ExecuteData);</span><br><span class="line"></span><br><span class="line">			FGameplayEffectModifiedAttribute* ModifiedAttribute = Spec.<span class="built_in">GetModifiedAttribute</span>(ModEvalData.Attribute);</span><br><span class="line">			<span class="keyword">if</span> (!ModifiedAttribute)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="comment">// If we haven&#x27;t already created a modified attribute holder, create it</span></span><br><span class="line">				ModifiedAttribute = Spec.<span class="built_in">AddModifiedAttribute</span>(ModEvalData.Attribute);</span><br><span class="line">			&#125;</span><br><span class="line">			ModifiedAttribute-&gt;TotalMagnitude += ModEvalData.Magnitude;</span><br><span class="line"></span><br><span class="line">			&#123;</span><br><span class="line">				<span class="built_in">SCOPE_CYCLE_COUNTER</span>(STAT_PostGameplayEffectExecute);</span><br><span class="line">				<span class="comment">/** This should apply &#x27;gamewide&#x27; rules. Such as clamping Health to MaxHealth or granting +3 health for every point of strength, etc */</span></span><br><span class="line">				AttributeSet-&gt;<span class="built_in">PostGameplayEffectExecute</span>(ExecuteData);</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> ENABLE_VISUAL_LOG</span></span><br><span class="line">			<span class="keyword">if</span> (FVisualLogger::<span class="built_in">IsRecording</span>())</span><br><span class="line">			&#123;</span><br><span class="line">				DebugExecutedGameplayEffectData DebugData;</span><br><span class="line">				DebugData.GameplayEffectName = Spec.Def-&gt;<span class="built_in">GetName</span>();</span><br><span class="line">				DebugData.ActivationState = <span class="string">&quot;INSTANT&quot;</span>;</span><br><span class="line">				DebugData.Attribute = ModEvalData.Attribute;</span><br><span class="line">				DebugData.Magnitude = Owner-&gt;<span class="built_in">GetNumericAttribute</span>(ModEvalData.Attribute) - OldValueOfProperty;</span><br><span class="line">				DebugExecutedGameplayEffects.<span class="built_in">Add</span>(DebugData);</span><br><span class="line">			&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// ENABLE_VISUAL_LOG</span></span></span><br><span class="line"></span><br><span class="line">			bExecuted = <span class="literal">true</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// Our owner doesn&#x27;t have this attribute, so we can&#x27;t do anything</span></span><br><span class="line">		<span class="built_in">ABILITY_LOG</span>(Log, <span class="built_in">TEXT</span>(<span class="string">&quot;%s does not have attribute %s. Skipping modifier&quot;</span>), *Owner-&gt;<span class="built_in">GetPathName</span>(), *ModEvalData.Attribute.<span class="built_in">GetName</span>());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> bExecuted;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="Questions-x2F-Unfinished-Part"><a href="#Questions-x2F-Unfinished-Part" class="headerlink" title="Questions&#x2F;Unfinished Part"></a>Questions&#x2F;Unfinished Part</h2><ul>
<li>FPredictionKey</li>
</ul>
<p>多人游戏&#x2F;网络复制相关，详情要阅读GameplayPrediction头文件注释。</p>
<h1 id="Enhanced-Input"><a href="#Enhanced-Input" class="headerlink" title="Enhanced Input"></a>Enhanced Input</h1><h1 id="Lyra-Input"><a href="#Lyra-Input" class="headerlink" title="Lyra Input"></a>Lyra Input</h1><p>Lyra的输入处理是基于Enhanced Input的</p>
<h2 id="Key-Class-2"><a href="#Key-Class-2" class="headerlink" title="Key Class"></a>Key Class</h2><ul>
<li>UGameFeatureAction_AddInputConfig</li>
</ul>
<blockquote>
<p>Registers a Player Mappable Input config to the Game User Settings<br>Expects that local players are set up to use the EnhancedInput system.</p>
</blockquote>
<p>继承UGameFeatureAction_WorldActionBase，将玩家输入映射配置注册进Game User Settings。</p>
<ul>
<li>UGameFeatureAction_AddInputBinding</li>
</ul>
<blockquote>
<p>Adds InputMappingContext to local players’ EnhancedInput system.<br>Expects that local players are set up to use the EnhancedInput system.</p>
</blockquote>
<p>继承UGameFeatureAction_WorldActionBase，将InputMappingContext加入到本地玩家增强输入系统中。</p>
<ul>
<li>ULyraAssetManager</li>
</ul>
<blockquote>
<p>Game implementation of the asset manager that override functionality and store game-specific types.<br>It is expected that most game will want to override AssetManager as it provides a good place for game-specific loading logic.<br>This class is used by setting ‘AssetManagerClassName’ in DefaultEngine.ini</p>
</blockquote>
<p>继承UAssetManager，Lyra的资产管理类，扩展资产管理的功能，并且可以存储一些特定游戏类型的资源。</p>
<ul>
<li>ULyraHeroComponent</li>
</ul>
<blockquote>
<p>Component that sets up input and camera handling for player controlled pawns (or bots that simulate players).<br>This depends on a PawnExtensionComponent to coordinate initialization.</p>
</blockquote>
<p>继承UPawnComponent和IGameFrameworkInitStateInterface，设置和初始化玩家角色输入（或者模拟玩家的AI输入）、控制摄像机的角色组件。与PawnExtensionComponent角色组件进行协同初始化。</p>
<p>玩家输入初始化的关键函数<code>InitializaPlayerInput(UInputComponent* PlayerInputComponent)</code>。</p>
<ul>
<li><p>ULyraInputConfig</p>
</li>
<li><p>ULyraInputComponent</p>
</li>
<li><p>ULyraGameplayTags</p>
</li>
<li><p>ULyraPawnData</p>
</li>
<li><p>ULyraPawnExtension</p>
</li>
<li><p>ULyraSettingsLocal</p>
</li>
</ul>
<h2 id="Flow-Diagram-2"><a href="#Flow-Diagram-2" class="headerlink" title="Flow Diagram"></a>Flow Diagram</h2><p>由于输入配置存在PawnData中，而PawnData又是一种重要的输入模块资产，会被GameFeature加载。所以先理清楚PawnData的来源</p>
<h3 id="PawnData-Data-Flow"><a href="#PawnData-Data-Flow" class="headerlink" title="PawnData Data Flow"></a>PawnData Data Flow</h3><img data-src="/2023/06/20/Lyra/Unreal%20Engine%205%20Lyra%20Starter%20Game%20Pawn%20Data%20Flow.png" class="" title="Lyra Pawn Data Flow">

<h3 id="Key-Implementation-2"><a href="#Key-Implementation-2" class="headerlink" title="Key Implementation"></a>Key Implementation</h3><ul>
<li>LyraHeroComponent.cpp: virtual void InitializaPlayerInput(UInputComponent* PlayerInputComponent)<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="type">const</span> ULyraPawnExtensionComponent* PawnExtComp = ULyraPawnExtensionComponent::<span class="built_in">FindPawnExtensionComponent</span>(Pawn))</span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">// 从PawnExetension组件获取PawnData</span></span><br><span class="line">	<span class="keyword">if</span> (<span class="type">const</span> ULyraPawnData* PawnData = PawnExtComp-&gt;<span class="built_in">GetPawnData</span>&lt;ULyraPawnData&gt;())</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// 在PawnData中获取应该激活的输入配置</span></span><br><span class="line">		<span class="keyword">if</span> (<span class="type">const</span> ULyraInputConfig* InputConfig = PawnData-&gt;InputConfig)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">// Register any default input configs with the settings so that they will be applied to the player during AddInputMappings</span></span><br><span class="line">			<span class="keyword">for</span> (<span class="type">const</span> FMappableConfigPair&amp; Pair : DefaultInputConfigs)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">if</span> (Pair.bShouldActivateAutomatically &amp;&amp; Pair.<span class="built_in">CanBeActivated</span>())</span><br><span class="line">				&#123;</span><br><span class="line">					FModifyContextOptions Options = &#123;&#125;;</span><br><span class="line">					Options.bIgnoreAllPressedKeysUntilRelease = <span class="literal">false</span>;</span><br><span class="line">					<span class="comment">// 将获取到的输入映射加入EnhancedInput实例中进行注册</span></span><br><span class="line">					<span class="comment">// Actually add the config to the local player							</span></span><br><span class="line">					Subsystem-&gt;<span class="built_in">AddPlayerMappableConfig</span>(Pair.Config.<span class="built_in">LoadSynchronous</span>(), Options);	</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// The Lyra Input Component has some additional functions to map Gameplay Tags to an Input Action.</span></span><br><span class="line">			<span class="comment">// If you want this functionality but still want to change your input component class, make it a subclass</span></span><br><span class="line">			<span class="comment">// of the ULyraInputComponent or modify this component accordingly.</span></span><br><span class="line">			ULyraInputComponent* LyraIC = <span class="built_in">Cast</span>&lt;ULyraInputComponent&gt;(PlayerInputComponent);</span><br><span class="line">			<span class="keyword">if</span> (<span class="built_in">ensureMsgf</span>(LyraIC, <span class="built_in">TEXT</span>(<span class="string">&quot;Unexpected Input Component class! The Gameplay Abilities will not be bound to their inputs. Change the input component to ULyraInputComponent or a subclass of it.&quot;</span>)))</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="comment">// Add the key mappings that may have been set by the player</span></span><br><span class="line">				<span class="comment">// 输入配置</span></span><br><span class="line">				LyraIC-&gt;<span class="built_in">AddInputMappings</span>(InputConfig, Subsystem);</span><br><span class="line"></span><br><span class="line">				<span class="comment">// This is where we actually bind and input action to a gameplay tag, which means that Gameplay Ability Blueprints will</span></span><br><span class="line">				<span class="comment">// be triggered directly by these input actions Triggered events. </span></span><br><span class="line">				TArray&lt;uint32&gt; BindHandles;</span><br><span class="line">				</span><br><span class="line">				<span class="comment">// </span></span><br><span class="line">				LyraIC-&gt;<span class="built_in">BindAbilityActions</span>(InputConfig, <span class="keyword">this</span>, &amp;ThisClass::Input_AbilityInputTagPressed, &amp;ThisClass::Input_AbilityInputTagReleased, <span class="comment">/*out*/</span> BindHandles);</span><br><span class="line"></span><br><span class="line">				<span class="comment">// 将输入配置、标签、输入触发事件、具体逻辑进行绑定</span></span><br><span class="line">				LyraIC-&gt;<span class="built_in">BindNativeAction</span>(InputConfig, LyraGameplayTags::InputTag_Move, ETriggerEvent::Triggered, <span class="keyword">this</span>, &amp;ThisClass::Input_Move, <span class="comment">/*bLogIfNotFound=*/</span> <span class="literal">false</span>);</span><br><span class="line">				LyraIC-&gt;<span class="built_in">BindNativeAction</span>(InputConfig, LyraGameplayTags::InputTag_Look_Mouse, ETriggerEvent::Triggered, <span class="keyword">this</span>, &amp;ThisClass::Input_LookMouse, <span class="comment">/*bLogIfNotFound=*/</span> <span class="literal">false</span>);</span><br><span class="line">				LyraIC-&gt;<span class="built_in">BindNativeAction</span>(InputConfig, LyraGameplayTags::InputTag_Look_Stick, ETriggerEvent::Triggered, <span class="keyword">this</span>, &amp;ThisClass::Input_LookStick, <span class="comment">/*bLogIfNotFound=*/</span> <span class="literal">false</span>);</span><br><span class="line">				LyraIC-&gt;<span class="built_in">BindNativeAction</span>(InputConfig, LyraGameplayTags::InputTag_Crouch, ETriggerEvent::Triggered, <span class="keyword">this</span>, &amp;ThisClass::Input_Crouch, <span class="comment">/*bLogIfNotFound=*/</span> <span class="literal">false</span>);</span><br><span class="line">				LyraIC-&gt;<span class="built_in">BindNativeAction</span>(InputConfig, LyraGameplayTags::InputTag_AutoRun, ETriggerEvent::Triggered, <span class="keyword">this</span>, &amp;ThisClass::Input_AutoRun, <span class="comment">/*bLogIfNotFound=*/</span> <span class="literal">false</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="Class-Diagram"><a href="#Class-Diagram" class="headerlink" title="Class Diagram"></a>Class Diagram</h3><img data-src="/2023/06/20/Lyra/Unreal%20Engine%205%20Lyra%20Starter%20Game%20Input%20Module%20Class%20Diagram.png" class="" title="Lyra Input Class Diagram">

<h3 id="Flow-Diagram-3"><a href="#Flow-Diagram-3" class="headerlink" title="Flow Diagram"></a>Flow Diagram</h3><img data-src="/2023/06/20/Lyra/Unreal%20Engine%205%20Lyra%20Starter%20Game%20Input%20Module%20Work%20Flow.png" class="" title="Lyra Input Work Flow">

<h2 id="Note"><a href="#Note" class="headerlink" title="Note"></a>Note</h2><p>不使用除Enhanced Input之外的插件时，需要关注代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> ULyraAssetManager::<span class="built_in">Get</span>().<span class="built_in">GetDefaultPawnData</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="built_in">GetAsset</span>(DefaultPawnData);</span><br><span class="line"></span><br><span class="line"><span class="built_in">UPROPERTY</span>(Config)</span><br><span class="line">TSoftObjectPtr&lt;ULyraPawnData&gt; DefaultPawnData;</span><br></pre></td></tr></table></figure>

<p>可在Character蓝图类中指定默认值。</p>
<h1 id="Lyra-Animation"><a href="#Lyra-Animation" class="headerlink" title="Lyra Animation"></a>Lyra Animation</h1><h2 id="Required-Plugin"><a href="#Required-Plugin" class="headerlink" title="Required Plugin"></a>Required Plugin</h2><ul>
<li>Animation Locomotion Library</li>
</ul>
<blockquote>
<p>Collection of techniques for driving locomotion animations.</p>
</blockquote>
<p>运动动画后期处理技术的代码库。</p>
<ul>
<li>Animation Warping</li>
</ul>
<blockquote>
<p>Framework for animation and pose warping. This plugin includes Stride, Orientation, and Slope Warping alongside the Root Motion Delta animation attribute.</p>
</blockquote>
<p>姿势扭曲的动画框架，可提供步幅扭曲、方向扭曲、根运动Delta动画属性等功能。</p>
<h2 id="Solution-Design"><a href="#Solution-Design" class="headerlink" title="Solution Design"></a>Solution Design</h2><p>ABP_Mannequin_Base-&gt;ALI_ItemAnimLayers-&gt;ABP_ItemAnimLayersBase-&gt;ABP_&lt;定义了要使用的具体动画的蓝图&gt;</p>
<p>ABP_Mannequine_Base负责角色动画状态机、上下半身动画分离处理再合并、线程安全更新动画所需要的数据、一部分后期处理。</p>
<p>ALI_ItemAnimLayers是纯接口层。</p>
<p>ABP_ItemAnimLayersBase负责实现具体的接口和大多数动画后期处理，例如瞄准偏移(Aim Offset)、步幅扭曲(Stride Warping)、距离匹配(Distance Match)等。</p>
<p>可使用Unreal Engine中的Reference View了解大致的</p>
<h2 id="Notice"><a href="#Notice" class="headerlink" title="Notice"></a>Notice</h2><h3 id="BlueprintThreadSafeUpdateAnimation"><a href="#BlueprintThreadSafeUpdateAnimation" class="headerlink" title="BlueprintThreadSafeUpdateAnimation"></a>BlueprintThreadSafeUpdateAnimation</h3><p>?线程安全更新动画数据，将这部分工作交给工作线程而不是游戏线程以提升性能，但是可能在C++中的NativeUpdateAnimation中进行该部分工作可能可以获得更好的性能?</p>
<h3 id="SelectCardinalDirectionFromAngle"><a href="#SelectCardinalDirectionFromAngle" class="headerlink" title="SelectCardinalDirectionFromAngle"></a>SelectCardinalDirectionFromAngle</h3><p>从字面意义和函数具体实现来看，是从得到的角色面向方向与速度的夹角推算出角色朝向的主要方向(Cardinal Direction)，主要方向有四个：前方(Forward)、后方(Backward)、左方(Left)、右方(Right)。</p>
<p>比如人物面朝前方往右偏前方移动，那么该函数的结果，主要方向为前方(Forward)。</p>
<p>?DeadZone意义位置，推测为摄像机的视野盲区，可能跟FOV有关系?</p>
<p>其他获取到的参数值是为了得到角色的面向方向与速度方向的夹角，根据四个主要方向的定义范围，判断该夹角的值是否位于某个方向的范围内，最后返回。</p>
<p>?八向移动?</p>
<h3 id="Root-Motion"><a href="#Root-Motion" class="headerlink" title="Root Motion"></a>Root Motion</h3><p>不启用根运动时，如果动画有运动数据，那么骨骼网格和角色会分离，动画播放结束以后骨骼网格会回到原点。启用以后骨骼会驱动角色动作，随着角色驱动动作。</p>
<p>用Miaximo的前进动画时，因为本身带有运动数据，然后根运动应该是默认关闭的，出现角色循环前进一段距离然后回到原点的情况。解决的办法应该是把胶囊体移速设置为0然后开启跟运动，但是估计效果仍然不好。</p>
<h3 id="Stride-Warping-步幅扭曲"><a href="#Stride-Warping-步幅扭曲" class="headerlink" title="Stride Warping (步幅扭曲)"></a>Stride Warping (步幅扭曲)</h3><p>动态调整角色的动画步幅来匹配胶囊体的移动速度。与距离匹配函数库配合来减少滑步的负面视觉影响。</p>
<p>在蓝图中，还提供了贴墙情况下的处理实现(UpdateCycleAnim)。</p>
<ul>
<li>Engine\Plugins\Animation\AnimationWarping\Source\Runtime\Private\BoneControllers\AnimNode_StrideWarping.cpp<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">FAnimNode_StrideWarping::EvaluateSkeletalControl_AnyThread</span><span class="params">(FComponentSpacePostContext&amp; Output, Tarray&lt;FboneTransform&gt;&amp; OutBoneTransforms)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">SCOPE_CYCLE_COUNTER</span>(STAT_StrideWarping_Eval);</span><br><span class="line">	<span class="built_in">check</span>(OutBoneTransforms.<span class="built_in">IsEmpty</span>());</span><br><span class="line"></span><br><span class="line">	<span class="type">const</span> FVector PreviousStrideDirection = ActualStrideDirection;</span><br><span class="line">	ActualStrideDirection = StrideDirection;</span><br><span class="line">	ActualStrideScale = StrideScale;</span><br><span class="line"></span><br><span class="line">	<span class="type">bool</span> bGraphDrivenWarping = <span class="literal">false</span>;</span><br><span class="line">	<span class="type">const</span> UE::Anim::IAnimRootMotionProvider* RootMotionProvider = UE::Anim::IAnimRootMotionProvider::<span class="built_in">Get</span>();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (Mode == EWarpingEvaluationMode::Graph)</span><br><span class="line">	&#123;</span><br><span class="line">		bGraphDrivenWarping = !!RootMotionProvider;</span><br><span class="line">		<span class="built_in">ensureMsgf</span>(bGraphDrivenWarping, <span class="built_in">TEXT</span>(<span class="string">&quot;Graph driven Stride Warping expected a valid root motion delta provider interface.&quot;</span>));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	FTransform RootMotionTransformDelta = FTransform::Identity;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (bGraphDrivenWarping)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// Graph driven stride warping will override the manual stride direction with the intent of the current animation sub-graph&#x27;s accumulated root motion</span></span><br><span class="line">		bGraphDrivenWarping = RootMotionProvider-&gt;<span class="built_in">ExtractRootMotion</span>(Output.CustomAttributes, RootMotionTransformDelta);</span><br><span class="line">		<span class="keyword">if</span> (bGraphDrivenWarping)</span><br><span class="line">		&#123;</span><br><span class="line">			CachedRootMotionDeltaTranslation = RootMotionTransformDelta.<span class="built_in">GetTranslation</span>();</span><br><span class="line">			<span class="comment">// If there&#x27;s no root motion delta, keep the previous stride direction</span></span><br><span class="line">			ActualStrideDirection = CachedRootMotionDeltaTranslation.<span class="built_in">GetSafeNormal</span>(UE_SMALL_NUMBER, PreviousStrideDirection);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">// Early exit on missing root motion delta attribute</span></span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="type">const</span> FBoneContainer&amp; RequiredBones = Output.Pose.<span class="built_in">GetPose</span>().<span class="built_in">GetBoneContainer</span>();</span><br><span class="line">	<span class="type">const</span> FTransform IKFootRootTransform = Output.Pose.<span class="built_in">GetComponentSpaceTransform</span>(IKFootRootBone.<span class="built_in">GetCompactPoseIndex</span>(RequiredBones));</span><br><span class="line">	<span class="type">const</span> FVector ResolvedFloorNormal = FloorNormalDirection.<span class="built_in">AsComponentSpaceDirection</span>(AnimInstanceProxy, IKFootRootTransform);</span><br><span class="line">	<span class="type">const</span> FVector ResolvedGravityDirection = GravityDirection.<span class="built_in">AsComponentSpaceDirection</span>(AnimInstanceProxy, IKFootRootTransform);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (bOrientStrideDirectionUsingFloorNormal)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="type">const</span> FVector StrideWarpingAxis = ResolvedFloorNormal ^ ActualStrideDirection;</span><br><span class="line">		ActualStrideDirection = StrideWarpingAxis ^ ResolvedFloorNormal;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// Get all foot IK Transforms</span></span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">auto</span>&amp; Foot : FootData)</span><br><span class="line">	&#123;</span><br><span class="line">		Foot.IKFootBoneTransform = Output.Pose.<span class="built_in">GetComponentSpaceTransform</span>(Foot.IKFootBoneIndex);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (bGraphDrivenWarping)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (CachedRootMotionDeltaSpeed &lt;= MinRootMotionSpeedThreshold)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">// If root motion speed is under the threshold, snap back to no stride adjustment.</span></span><br><span class="line">			<span class="comment">// If interpolation is on, it will blend the result</span></span><br><span class="line">			ActualStrideScale = <span class="number">1.0f</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">// Graph driven stride scale factor will be determined by the ratio of the</span></span><br><span class="line">			<span class="comment">// locomotion (capsule/physics) speed against the animation root motion speed</span></span><br><span class="line">			ActualStrideScale = LocomotionSpeed / CachedRootMotionDeltaSpeed;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Allow the opportunity for stride scale clamping and interpolation regardless of evaluation mode</span></span><br><span class="line">	ActualStrideScale = StrideScaleModifierState.<span class="built_in">ApplyTo</span>(StrideScaleModifier, ActualStrideScale, CachedDeltaTime);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (bGraphDrivenWarping)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// Forward the side effects of stride warping on the root motion contribution for this sub-graph</span></span><br><span class="line">		RootMotionTransformDelta.<span class="built_in">ScaleTranslation</span>(ActualStrideScale);</span><br><span class="line">		<span class="type">const</span> <span class="type">bool</span> bRootMotionOverridden = RootMotionProvider-&gt;<span class="built_in">OverrideRootMotion</span>(RootMotionTransformDelta, Output.CustomAttributes);</span><br><span class="line">		<span class="built_in">ensureMsgf</span>(bRootMotionOverridden, <span class="built_in">TEXT</span>(<span class="string">&quot;Graph driven Stride Warping expected a root motion delta to be present in the attribute stream prior to warping/overriding it.&quot;</span>));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Scale IK feet bones along Stride Warping Axis, from the Thigh bone location.</span></span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">auto</span>&amp; Foot : FootData)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// Stride Warping along Stride Warping Axis</span></span><br><span class="line">		<span class="type">const</span> FVector IKFootLocation = Foot.IKFootBoneTransform.<span class="built_in">GetLocation</span>();</span><br><span class="line">		<span class="type">const</span> FVector ThighBoneLocation = Output.Pose.<span class="built_in">GetComponentSpaceTransform</span>(Foot.ThighBoneIndex).<span class="built_in">GetLocation</span>();</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Project Thigh Bone Location on plane made of FootIKLocation and FloorPlaneNormal, along Gravity Dir.</span></span><br><span class="line">		<span class="comment">// This will be the StrideWarpingPlaneOrigin</span></span><br><span class="line">		<span class="type">const</span> FVector StrideWarpingPlaneOrigin = (FMath::<span class="built_in">Abs</span>(ResolvedGravityDirection | ResolvedFloorNormal) &gt; DELTA) ? FMath::<span class="built_in">LinePlaneIntersection</span>(ThighBoneLocation, ThighBoneLocation + ResolvedGravityDirection, IKFootLocation, ResolvedFloorNormal) : IKFootLocation;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Project FK Foot along StrideWarping Plane, this will be our Scale Origin</span></span><br><span class="line">		<span class="type">const</span> FVector ScaleOrigin = FVector::<span class="built_in">PointPlaneProject</span>(IKFootLocation, StrideWarpingPlaneOrigin, ActualStrideDirection);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Now the ScaleOrigin and IKFootLocation are forming a line parallel to the floor, and we can scale the IK foot.</span></span><br><span class="line">		<span class="type">const</span> FVector WarpedLocation = ScaleOrigin + (IKFootLocation - ScaleOrigin) * ActualStrideScale;</span><br><span class="line">		Foot.IKFootBoneTransform.<span class="built_in">SetLocation</span>(WarpedLocation);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	FVector PelvisOffset = FVector::ZeroVector;</span><br><span class="line">	<span class="type">const</span> FCompactPoseBoneIndex PelvisBoneIndex = PelvisBone.<span class="built_in">GetCompactPoseIndex</span>(RequiredBones);</span><br><span class="line"></span><br><span class="line">	FTransform PelvisTransform = Output.Pose.<span class="built_in">GetComponentSpaceTransform</span>(PelvisBoneIndex);</span><br><span class="line">	<span class="type">const</span> FVector InitialPelvisLocation = PelvisTransform.<span class="built_in">GetLocation</span>();</span><br><span class="line"></span><br><span class="line">	TArray&lt;<span class="type">float</span>, TInlineAllocator&lt;<span class="number">10</span>&gt;&gt; FKFootDistancesToPelvis;</span><br><span class="line">	FKFootDistancesToPelvis.<span class="built_in">Reserve</span>(FootData.<span class="built_in">Num</span>());</span><br><span class="line"></span><br><span class="line">	TArray&lt;FVector, TInlineAllocator&lt;<span class="number">10</span>&gt;&gt; IKFootLocations;</span><br><span class="line">	IKFootLocations.<span class="built_in">Reserve</span>(FootData.<span class="built_in">Num</span>());</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">auto</span>&amp; Foot : FootData)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="type">const</span> FVector FKFootLocation = Output.Pose.<span class="built_in">GetComponentSpaceTransform</span>(Foot.FKFootBoneIndex).<span class="built_in">GetLocation</span>();</span><br><span class="line">		FKFootDistancesToPelvis.<span class="built_in">Add</span>(FVector::<span class="built_in">Dist</span>(FKFootLocation, InitialPelvisLocation));</span><br><span class="line"></span><br><span class="line">		<span class="type">const</span> FVector IKFootLocation = Foot.IKFootBoneTransform.<span class="built_in">GetLocation</span>();</span><br><span class="line">		IKFootLocations.<span class="built_in">Add</span>(IKFootLocation);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Adjust Pelvis down if needed to keep foot contact with the ground and prevent over-extension</span></span><br><span class="line">	PelvisTransform = PelvisIKFootSolver.<span class="built_in">Solve</span>(PelvisTransform, FKFootDistancesToPelvis, IKFootLocations, CachedDeltaTime);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Add adjusted pelvis transform</span></span><br><span class="line">	<span class="built_in">check</span>(!PelvisTransform.<span class="built_in">ContainsNaN</span>());</span><br><span class="line">	OutBoneTransforms.<span class="built_in">Add</span>(<span class="built_in">FBoneTransform</span>(PelvisBoneIndex, PelvisTransform));</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Compute final offset to use below</span></span><br><span class="line">	PelvisOffset = (PelvisTransform.<span class="built_in">GetLocation</span>() - InitialPelvisLocation);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Rotate Thigh bones to help IK, and maintain leg shape.</span></span><br><span class="line">	<span class="keyword">if</span> (bCompensateIKUsingFKThighRotation)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">auto</span>&amp; Foot : FootData)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="type">const</span> FTransform ThighTransform = Output.Pose.<span class="built_in">GetComponentSpaceTransform</span>(Foot.ThighBoneIndex);</span><br><span class="line">			<span class="type">const</span> FTransform FKFootTransform = Output.Pose.<span class="built_in">GetComponentSpaceTransform</span>(Foot.FKFootBoneIndex);</span><br><span class="line">			</span><br><span class="line">			FTransform AdjustedThighTransform = ThighTransform;</span><br><span class="line">			AdjustedThighTransform.<span class="built_in">AddToTranslation</span>(PelvisOffset);</span><br><span class="line"></span><br><span class="line">			<span class="type">const</span> FVector InitialDir = (FKFootTransform.<span class="built_in">GetLocation</span>() - ThighTransform.<span class="built_in">GetLocation</span>()).<span class="built_in">GetSafeNormal</span>();</span><br><span class="line">			<span class="type">const</span> FVector TargetDir = (Foot.IKFootBoneTransform.<span class="built_in">GetLocation</span>() - AdjustedThighTransform.<span class="built_in">GetLocation</span>()).<span class="built_in">GetSafeNormal</span>();</span><br><span class="line">			</span><br><span class="line">			<span class="comment">// Find Delta Rotation take takes us from Old to New dir</span></span><br><span class="line">			<span class="type">const</span> FQuat DeltaRotation = FQuat::<span class="built_in">FindBetweenNormals</span>(InitialDir, TargetDir);</span><br><span class="line"></span><br><span class="line">			<span class="comment">// Rotate our Joint quaternion by this delta rotation</span></span><br><span class="line">			AdjustedThighTransform.<span class="built_in">SetRotation</span>(DeltaRotation * AdjustedThighTransform.<span class="built_in">GetRotation</span>());</span><br><span class="line"></span><br><span class="line">			<span class="comment">// Add adjusted thigh transform</span></span><br><span class="line">			<span class="built_in">check</span>(!AdjustedThighTransform.<span class="built_in">ContainsNaN</span>());</span><br><span class="line">			OutBoneTransforms.<span class="built_in">Add</span>(<span class="built_in">FBoneTransform</span>(Foot.ThighBoneIndex, AdjustedThighTransform));</span><br><span class="line"></span><br><span class="line">			<span class="comment">// Clamp IK Feet bone based on FK leg. To prevent over-extension and preserve animated motion.</span></span><br><span class="line">			<span class="keyword">if</span> (bClampIKUsingFKLimits)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="type">const</span> <span class="type">float</span> FKLength = FVector::<span class="built_in">Dist</span>(FKFootTransform.<span class="built_in">GetLocation</span>(), ThighTransform.<span class="built_in">GetLocation</span>());</span><br><span class="line">				<span class="type">const</span> <span class="type">float</span> IKLength = FVector::<span class="built_in">Dist</span>(Foot.IKFootBoneTransform.<span class="built_in">GetLocation</span>(), AdjustedThighTransform.<span class="built_in">GetLocation</span>());</span><br><span class="line">				<span class="keyword">if</span> (IKLength &gt; FKLength)</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="type">const</span> FVector ClampedFootLocation = AdjustedThighTransform.<span class="built_in">GetLocation</span>() + TargetDir * FKLength;</span><br><span class="line">					Foot.IKFootBoneTransform.<span class="built_in">SetLocation</span>(ClampedFootLocation);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Add final IK feet transforms</span></span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">auto</span>&amp; Foot : FootData)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">check</span>(!Foot.IKFootBoneTransform.<span class="built_in">ContainsNaN</span>());</span><br><span class="line">		OutBoneTransforms.<span class="built_in">Add</span>(<span class="built_in">FBoneTransform</span>(Foot.IKFootBoneIndex, Foot.IKFootBoneTransform));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Sort OutBoneTransforms so indices are in increasing order.</span></span><br><span class="line">	OutBoneTransforms.<span class="built_in">Sort</span>(<span class="built_in">FCompareBoneTransformIndex</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="Orientation-Warping-方向扭曲"><a href="#Orientation-Warping-方向扭曲" class="headerlink" title="Orientation Warping (方向扭曲)"></a>Orientation Warping (方向扭曲)</h3><p>隔离并扭曲动画姿势的腿部IK骨骼，契合根骨骼运动的动态更新移动方向。<br>用于填充动画序列中的覆盖缺口，减少手动创建间隙动画或创建过多混合空间过度的必要性。<br>上下半身分离、锁定瞄准、八向移动会有比较直观的效果。</p>
<ul>
<li>Engine\Plugins\Animation\AnimationWarping\Source\Runtime\Public\BoneControllers\AnimNode_OrientationWarping.cpp<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">FAnimNode_OrientationWarping::EvaluateSkeletalControl_AnyThread</span><span class="params">(FComponentSpacePoseContext&amp; Output, TArray&lt;FBoneTransform&gt;&amp; OutBoneTransforms)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">SCOPE_CYCLE_COUNTER</span>(STAT_OrientationWarping_Eval);</span><br><span class="line">	<span class="built_in">check</span>(OutBoneTransforms.<span class="built_in">Num</span>() == <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">	ActualOrientationAngle = OrientationAngle;</span><br><span class="line"></span><br><span class="line">	<span class="type">const</span> <span class="type">float</span> DeltaSeconds = Output.AnimInstanceProxy-&gt;<span class="built_in">GetDeltaSeconds</span>();</span><br><span class="line">	<span class="type">const</span> FVector RotationAxisVector = UE::Anim::<span class="built_in">GetAxisVector</span>(RotationAxis);</span><br><span class="line">	FVector RootMotionDeltaDirection = FVector::ZeroVector;</span><br><span class="line">	FVector LocomotionForward = FVector::ZeroVector;</span><br><span class="line"></span><br><span class="line">	<span class="type">bool</span> bGraphDrivenWarping = <span class="literal">false</span>;</span><br><span class="line">	<span class="type">const</span> UE::Anim::IAnimRootMotionProvider* RootMotionProvider = UE::Anim::IAnimRootMotionProvider::<span class="built_in">Get</span>();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (Mode == EWarpingEvaluationMode::Graph)</span><br><span class="line">	&#123;</span><br><span class="line">		bGraphDrivenWarping = !!RootMotionProvider;</span><br><span class="line">		<span class="built_in">ensureMsgf</span>(bGraphDrivenWarping, <span class="built_in">TEXT</span>(<span class="string">&quot;Graph driven Orientation Warping expected a valid root motion delta provider interface.&quot;</span>));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> WITH_EDITORONLY_DATA</span></span><br><span class="line">	bFoundRootMotionAttribute = <span class="literal">false</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// We will likely need to revisit LocomotionAngle participating as an input to orientation warping.</span></span><br><span class="line">	<span class="comment">// Without velocity information from the motion model (such as the capsule), LocomotionAngle isn&#x27;t enough</span></span><br><span class="line">	<span class="comment">// information in isolation for all cases when deciding to warp.</span></span><br><span class="line">	<span class="comment">//</span></span><br><span class="line">	<span class="comment">// For example imagine that the motion model has stopped moving with zero velocity due to a</span></span><br><span class="line">	<span class="comment">// transition into a strafing stop. During that transition we may play an animation with non-zero </span></span><br><span class="line">	<span class="comment">// velocity for an arbitrary number of frames. In this scenario the concept of direction is meaningless </span></span><br><span class="line">	<span class="comment">// since we cannot orient the animation to match a zero velocity and consequently a zero direction, </span></span><br><span class="line">	<span class="comment">// since that would break the pose. For those frames, we would incorrectly over-orient the strafe.</span></span><br><span class="line">	<span class="comment">//</span></span><br><span class="line">	<span class="comment">// The solution may be instead to pass velocity with the actor base rotation, allowing us to retain</span></span><br><span class="line">	<span class="comment">// speed information about the motion. It may also allow us to do more complex orienting behavior </span></span><br><span class="line">	<span class="comment">// when multiple degrees of freedom can be considered.</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (bGraphDrivenWarping)</span><br><span class="line">	&#123;</span><br><span class="line">		FTransform RootMotionTransformDelta = FTransform::Identity;</span><br><span class="line">		bGraphDrivenWarping = RootMotionProvider-&gt;<span class="built_in">ExtractRootMotion</span>(Output.CustomAttributes, RootMotionTransformDelta);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Graph driven orientation warping will modify the incoming root motion to orient towards the intended locomotion angle</span></span><br><span class="line">		<span class="keyword">if</span> (bGraphDrivenWarping)</span><br><span class="line">		&#123;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> WITH_EDITORONLY_DATA</span></span><br><span class="line">			<span class="comment">// Graph driven Orientation Warping expects a root motion delta to be present in the attribute stream.</span></span><br><span class="line">			bFoundRootMotionAttribute = <span class="literal">true</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">			<span class="comment">// In UE, forward is defined as +x; consequently this is also true when sampling an actor&#x27;s velocity. Historically the skeletal </span></span><br><span class="line">			<span class="comment">// mesh component forward will not match the actor, requiring us to correct the rotation before sampling the LocomotionForward.</span></span><br><span class="line">			<span class="comment">// In order to make orientation warping &#x27;pure&#x27; in the future we will need to provide more context about the intent of</span></span><br><span class="line">			<span class="comment">// the actor vs the intent of the animation in their respective spaces. Specifically, we will need some form the following information:</span></span><br><span class="line">			<span class="comment">//</span></span><br><span class="line">			<span class="comment">// 1. Actor Forward</span></span><br><span class="line">			<span class="comment">// 2. Actor Velocity</span></span><br><span class="line">			<span class="comment">// 3. Skeletal Mesh Relative Rotation</span></span><br><span class="line"></span><br><span class="line">			LocomotionAngle = FRotator::<span class="built_in">NormalizeAxis</span>(LocomotionAngle);</span><br><span class="line">			LocomotionAngle = FMath::<span class="built_in">DegreesToRadians</span>(LocomotionAngle);</span><br><span class="line">			<span class="type">const</span> FQuat LocomotionRotation = <span class="built_in">FQuat</span>(RotationAxisVector, LocomotionAngle);</span><br><span class="line"></span><br><span class="line">			<span class="type">const</span> FTransform SkeletalMeshRelativeTransform = Output.AnimInstanceProxy-&gt;<span class="built_in">GetComponentRelativeTransform</span>();</span><br><span class="line">			<span class="type">const</span> FQuat SkeletalMeshRelativeRotation = SkeletalMeshRelativeTransform.<span class="built_in">GetRotation</span>();</span><br><span class="line">			LocomotionForward = SkeletalMeshRelativeRotation.<span class="built_in">UnrotateVector</span>(LocomotionRotation.<span class="built_in">GetForwardVector</span>()).<span class="built_in">GetSafeNormal</span>();</span><br><span class="line">			</span><br><span class="line">			<span class="keyword">if</span> (OffsetAlpha == <span class="number">0.0</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="comment">// No alpha. Reset our heading offset.</span></span><br><span class="line">				HeadingOffset = <span class="number">0.0f</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">			&#123;</span><br><span class="line">				<span class="comment">// Accumulate a percentage of our component&#x27;s frame delta, based on offset alpha</span></span><br><span class="line">				<span class="type">const</span> <span class="type">float</span> LastComponentHeading = ComponentHeading;</span><br><span class="line">				ComponentHeading = Output.AnimInstanceProxy-&gt;<span class="built_in">GetComponentTransform</span>().<span class="built_in">GetRotation</span>().<span class="built_in">GetTwistAngle</span>(RotationAxisVector);</span><br><span class="line">				HeadingOffset += FMath::<span class="built_in">UnwindRadians</span>(LastComponentHeading - ComponentHeading) * OffsetAlpha;</span><br><span class="line"></span><br><span class="line">				<span class="comment">// Accumulate a percentage of our root motion&#x27;s heading, based on offset alpha</span></span><br><span class="line">				<span class="type">float</span> RootMotionDeltaHeading = RootMotionTransformDelta.<span class="built_in">GetRotation</span>().<span class="built_in">GetTwistAngle</span>(RotationAxisVector);</span><br><span class="line">				HeadingOffset += RootMotionDeltaHeading * OffsetAlpha;</span><br><span class="line"></span><br><span class="line">				<span class="comment">// If our alpha is decreasing, we&#x27;re blending out the offset.</span></span><br><span class="line">				<span class="comment">// We don&#x27;t need to do this when blending in because we&#x27;re just accumulating partial component offset and root motion.</span></span><br><span class="line">				<span class="type">const</span> <span class="type">float</span> OffsetAlphaStep = LastOffsetAlpha - OffsetAlpha;</span><br><span class="line">				<span class="keyword">if</span> (OffsetAlphaStep &gt; <span class="number">0.0f</span>)</span><br><span class="line">				&#123;</span><br><span class="line">					HeadingOffset -= OffsetAlphaStep * HeadingOffset / LastOffsetAlpha;</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				<span class="type">const</span> <span class="type">float</span> MaxOffsetRadians = FMath::<span class="built_in">DegreesToRadians</span>(MaxOffsetAngle);</span><br><span class="line">				HeadingOffset = FMath::<span class="built_in">Clamp</span>(HeadingOffset, -MaxOffsetAngle, MaxOffsetAngle);</span><br><span class="line">			&#125;</span><br><span class="line">			LastOffsetAlpha = OffsetAlpha;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// Rotate the root motion direction by our effective offset.</span></span><br><span class="line">			<span class="comment">// This means we will warp our pose based on the adjusted offset, and correct accordingly.</span></span><br><span class="line">			FQuat RootOffsetRotation = <span class="built_in">FQuat</span>(RotationAxisVector, HeadingOffset);</span><br><span class="line">			<span class="type">const</span> FVector RootMotionDeltaTranslation = RootOffsetRotation.<span class="built_in">RotateVector</span>(RootMotionTransformDelta.<span class="built_in">GetTranslation</span>());</span><br><span class="line"></span><br><span class="line">			<span class="comment">// Hold previous direction if we can&#x27;t calculate it from current move delta, because the root is no longer moving</span></span><br><span class="line">			RootMotionDeltaDirection = RootMotionDeltaTranslation.<span class="built_in">GetSafeNormal</span>(UE_SMALL_NUMBER, PreviousRootMotionDeltaDirection);</span><br><span class="line"></span><br><span class="line">			<span class="type">const</span> <span class="type">float</span> RootMotionDeltaSpeed = RootMotionDeltaTranslation.<span class="built_in">Size</span>() / DeltaSeconds;</span><br><span class="line">			<span class="keyword">if</span> (RootMotionDeltaSpeed &lt; MinRootMotionSpeedThreshold)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="comment">// If we&#x27;re under the threshold, snap orientation angle to 0, and let interpolation handle the delta</span></span><br><span class="line">				ActualOrientationAngle = <span class="number">0.0f</span>;</span><br><span class="line">				PreviousRootMotionDeltaDirection = RootMotionDeltaDirection;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">			&#123;</span><br><span class="line">				<span class="comment">// Capture the delta rotation from the axis of motion we care about</span></span><br><span class="line">				FQuat WarpedRotation = FQuat::<span class="built_in">FindBetween</span>(RootMotionDeltaDirection, LocomotionForward);</span><br><span class="line"></span><br><span class="line">				<span class="comment">// For interpolated warping, guarantee that PreviousOrientationAngle is relative to the current frame&#x27;s root motion direction </span></span><br><span class="line">				<span class="type">float</span> RootMotionDeltaAngleDifference = FMath::<span class="built_in">Acos</span>(RootMotionDeltaDirection.<span class="built_in">Dot</span>(PreviousRootMotionDeltaDirection));</span><br><span class="line">				RootMotionDeltaAngleDifference *= FMath::<span class="built_in">Sign</span>(RotationAxisVector.<span class="built_in">Dot</span>(RootMotionDeltaDirection.<span class="built_in">Cross</span>(PreviousRootMotionDeltaDirection)));</span><br><span class="line"></span><br><span class="line">				PreviousRootMotionDeltaDirection = RootMotionDeltaDirection;</span><br><span class="line">				PreviousOrientationAngle += RootMotionDeltaAngleDifference;</span><br><span class="line"></span><br><span class="line">				ActualOrientationAngle = WarpedRotation.<span class="built_in">GetTwistAngle</span>(RotationAxisVector);</span><br><span class="line">				<span class="comment">// Motion Matching may return an animation that deviates a lot from the movement direction (e.g movement direction going bwd and motion matching could return the fwd animation for a few frames)</span></span><br><span class="line">				<span class="comment">// When that happens, since we use the delta between root motion and movement direction, we would be over-rotating the lower body and breaking the pose during those frames</span></span><br><span class="line">				<span class="comment">// So, when that happens we use the inverse of the movement direction to calculate our target rotation. </span></span><br><span class="line">				<span class="comment">// This feels a bit &#x27;hacky&#x27; but its the only option I&#x27;ve found so far to mitigate the problem</span></span><br><span class="line">				<span class="keyword">if</span> (LocomotionAngleDeltaThreshold &gt; <span class="number">0.f</span>)</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="keyword">if</span> (FMath::<span class="built_in">Abs</span>(FMath::<span class="built_in">RadiansToDegrees</span>(ActualOrientationAngle)) &gt; LocomotionAngleDeltaThreshold)</span><br><span class="line">					&#123;</span><br><span class="line">						WarpedRotation = FQuat::<span class="built_in">FindBetween</span>(RootMotionDeltaDirection, -LocomotionForward);</span><br><span class="line">						ActualOrientationAngle = WarpedRotation.<span class="built_in">GetTwistAngle</span>(RotationAxisVector);</span><br><span class="line">					&#125;</span><br><span class="line">					</span><br><span class="line">					<span class="keyword">if</span> (FMath::<span class="built_in">Abs</span>(FMath::<span class="built_in">RadiansToDegrees</span>(PreviousOrientationAngle)) &gt; LocomotionAngleDeltaThreshold)</span><br><span class="line">					&#123;</span><br><span class="line">						<span class="comment">// Previous orientation angle might be using an opposite direction too, so flip it if it exceeds the threshold as well.</span></span><br><span class="line">						PreviousOrientationAngle = WarpedRotation.<span class="built_in">GetTwistAngle</span>(RotationAxisVector);</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				<span class="comment">// Rotate the root motion delta fully by the warped angle</span></span><br><span class="line">				<span class="type">const</span> FVector WarpedRootMotionTranslationDelta = WarpedRotation.<span class="built_in">RotateVector</span>(RootMotionDeltaTranslation);</span><br><span class="line">				RootMotionTransformDelta.<span class="built_in">SetTranslation</span>(WarpedRootMotionTranslationDelta);</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">			<span class="comment">// Forward the side effects of orientation warping on the root motion contribution for this sub-graph</span></span><br><span class="line">			<span class="type">const</span> <span class="type">bool</span> bRootMotionOverridden = RootMotionProvider-&gt;<span class="built_in">OverrideRootMotion</span>(RootMotionTransformDelta, Output.CustomAttributes);</span><br><span class="line">			<span class="built_in">ensureMsgf</span>(bRootMotionOverridden, <span class="built_in">TEXT</span>(<span class="string">&quot;Graph driven Orientation Warping expected a root motion delta to be present in the attribute stream prior to warping/overriding it.&quot;</span>));</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">// Early exit on missing root motion delta attribute</span></span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; </span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// Manual orientation warping will take the angle directly</span></span><br><span class="line">		ActualOrientationAngle = FRotator::<span class="built_in">NormalizeAxis</span>(ActualOrientationAngle);</span><br><span class="line">		ActualOrientationAngle = FMath::<span class="built_in">DegreesToRadians</span>(ActualOrientationAngle);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Optionally interpolate the effective orientation towards the target orientation angle</span></span><br><span class="line">	<span class="keyword">if</span> (RotationInterpSpeed &gt; <span class="number">0.f</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		ActualOrientationAngle = FMath::<span class="built_in">FInterpTo</span>(PreviousOrientationAngle, ActualOrientationAngle, DeltaSeconds, RotationInterpSpeed);</span><br><span class="line">		PreviousOrientationAngle = ActualOrientationAngle;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Allow the alpha value of the node to affect the final rotation</span></span><br><span class="line">	ActualOrientationAngle *= ActualAlpha * WarpingAlpha;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> ENABLE_ANIM_DEBUG</span></span><br><span class="line">	<span class="type">bool</span> bDebugging = <span class="literal">false</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> WITH_EDITORONLY_DATA</span></span><br><span class="line">	bDebugging = bDebugging || bEnableDebugDraw;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">	<span class="keyword">constexpr</span> <span class="type">float</span> DebugDrawScale = <span class="number">1.f</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">	<span class="type">const</span> int32 DebugIndex = CVarAnimNodeOrientationWarpingDebug.<span class="built_in">GetValueOnAnyThread</span>();</span><br><span class="line">	bDebugging = bDebugging || (DebugIndex &gt; <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (bDebugging)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="type">const</span> FTransform ComponentTransform = Output.AnimInstanceProxy-&gt;<span class="built_in">GetComponentTransform</span>();</span><br><span class="line">		<span class="type">const</span> FVector ActorForwardDirection = Output.AnimInstanceProxy-&gt;<span class="built_in">GetActorTransform</span>().<span class="built_in">GetRotation</span>().<span class="built_in">GetForwardVector</span>();</span><br><span class="line">		FVector DebugArrowOffset = FVector::ZAxisVector * DebugDrawScale;</span><br><span class="line"></span><br><span class="line">		<span class="type">const</span> <span class="type">bool</span> bDrawAll = DebugIndex == <span class="number">3</span>;</span><br><span class="line">		<span class="type">const</span> <span class="type">bool</span> bDrawOffset = (DebugIndex == <span class="number">2</span>) || bDrawAll;</span><br><span class="line">		<span class="type">const</span> <span class="type">bool</span> bDrawWarping = (DebugIndex == <span class="number">1</span>) || bDrawAll;</span><br><span class="line">		<span class="keyword">if</span> (bDrawWarping)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="type">const</span> FVector ForwardDirection = bGraphDrivenWarping</span><br><span class="line">				? ComponentTransform.<span class="built_in">GetRotation</span>().<span class="built_in">RotateVector</span>(LocomotionForward)</span><br><span class="line">				: ActorForwardDirection;</span><br><span class="line"></span><br><span class="line">			Output.AnimInstanceProxy-&gt;<span class="built_in">AnimDrawDebugDirectionalArrow</span>(</span><br><span class="line">				ComponentTransform.<span class="built_in">GetLocation</span>() + DebugArrowOffset,</span><br><span class="line">				ComponentTransform.<span class="built_in">GetLocation</span>() + DebugArrowOffset + ForwardDirection * <span class="number">100.f</span> * DebugDrawScale,</span><br><span class="line">				<span class="number">40.f</span> * DebugDrawScale, FColor::Red, <span class="literal">false</span>, <span class="number">0.f</span>, <span class="number">2.f</span> * DebugDrawScale);</span><br><span class="line"></span><br><span class="line">			<span class="type">const</span> FVector RotationDirection = bGraphDrivenWarping</span><br><span class="line">				? ComponentTransform.<span class="built_in">GetRotation</span>().<span class="built_in">RotateVector</span>(RootMotionDeltaDirection)</span><br><span class="line">				: ActorForwardDirection.<span class="built_in">RotateAngleAxis</span>(OrientationAngle, RotationAxisVector);</span><br><span class="line"></span><br><span class="line">			DebugArrowOffset += FVector::ZAxisVector * DebugDrawScale;</span><br><span class="line">			Output.AnimInstanceProxy-&gt;<span class="built_in">AnimDrawDebugDirectionalArrow</span>(</span><br><span class="line">				ComponentTransform.<span class="built_in">GetLocation</span>() + DebugArrowOffset,</span><br><span class="line">				ComponentTransform.<span class="built_in">GetLocation</span>() + DebugArrowOffset + RotationDirection * <span class="number">100.f</span> * DebugDrawScale,</span><br><span class="line">				<span class="number">40.f</span> * DebugDrawScale, FColor::Blue, <span class="literal">false</span>, <span class="number">0.f</span>, <span class="number">2.f</span> * DebugDrawScale);</span><br><span class="line"></span><br><span class="line">			<span class="type">const</span> <span class="type">float</span> ActualOrientationAngleDegrees = FMath::<span class="built_in">RadiansToDegrees</span>(ActualOrientationAngle);</span><br><span class="line">			<span class="type">const</span> FVector WarpedRotationDirection = bGraphDrivenWarping</span><br><span class="line">				? RotationDirection.<span class="built_in">RotateAngleAxis</span>(ActualOrientationAngleDegrees, RotationAxisVector)</span><br><span class="line">				: ActorForwardDirection.<span class="built_in">RotateAngleAxis</span>(ActualOrientationAngleDegrees, RotationAxisVector);</span><br><span class="line"></span><br><span class="line">			DebugArrowOffset += FVector::ZAxisVector * DebugDrawScale;</span><br><span class="line">			Output.AnimInstanceProxy-&gt;<span class="built_in">AnimDrawDebugDirectionalArrow</span>(</span><br><span class="line">				ComponentTransform.<span class="built_in">GetLocation</span>() + DebugArrowOffset,</span><br><span class="line">				ComponentTransform.<span class="built_in">GetLocation</span>() + DebugArrowOffset + WarpedRotationDirection * <span class="number">100.f</span> * DebugDrawScale,</span><br><span class="line">				<span class="number">40.f</span> * DebugDrawScale, FColor::Green, <span class="literal">false</span>, <span class="number">0.f</span>, <span class="number">2.f</span> * DebugDrawScale);</span><br><span class="line">			DebugArrowOffset += FVector::ZAxisVector * DebugDrawScale;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">if</span> (bDrawOffset)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="type">const</span> <span class="type">float</span> HeadingOffetDegrees = FMath::<span class="built_in">RadiansToDegrees</span>(HeadingOffset);</span><br><span class="line">			<span class="type">const</span> FVector OffsetDirection = ActorForwardDirection.<span class="built_in">RotateAngleAxis</span>(HeadingOffetDegrees, RotationAxisVector);</span><br><span class="line"></span><br><span class="line">			Output.AnimInstanceProxy-&gt;<span class="built_in">AnimDrawDebugDirectionalArrow</span>(</span><br><span class="line">				ComponentTransform.<span class="built_in">GetLocation</span>() + DebugArrowOffset,</span><br><span class="line">				ComponentTransform.<span class="built_in">GetLocation</span>() + DebugArrowOffset + OffsetDirection * <span class="number">100.f</span> * DebugDrawScale,</span><br><span class="line">				<span class="number">40.f</span> * DebugDrawScale, FColor::Purple, <span class="literal">false</span>, <span class="number">0.f</span>, <span class="number">2.f</span> * DebugDrawScale);</span><br><span class="line"></span><br><span class="line">			DebugArrowOffset += FVector::ZAxisVector * DebugDrawScale;</span><br><span class="line">			Output.AnimInstanceProxy-&gt;<span class="built_in">AnimDrawDebugDirectionalArrow</span>(</span><br><span class="line">				ComponentTransform.<span class="built_in">GetLocation</span>() + DebugArrowOffset,</span><br><span class="line">				ComponentTransform.<span class="built_in">GetLocation</span>() + DebugArrowOffset + ActorForwardDirection * <span class="number">100.f</span> * DebugDrawScale,</span><br><span class="line">				<span class="number">40.f</span> * DebugDrawScale, FColor::Black, <span class="literal">false</span>, <span class="number">0.f</span>, <span class="number">2.f</span> * DebugDrawScale);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// Combine our warping and heading offsets to rotate our root bone</span></span><br><span class="line">	<span class="type">const</span> <span class="type">float</span> CombinedRootOffset = FMath::<span class="built_in">UnwindRadians</span>(ActualOrientationAngle * DistributedBoneOrientationAlpha + HeadingOffset);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Rotate Root Bone first, as that cheaply rotates the whole pose with one transformation.</span></span><br><span class="line">	<span class="keyword">if</span> (!FMath::<span class="built_in">IsNearlyZero</span>(CombinedRootOffset, KINDA_SMALL_NUMBER))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="type">const</span> FQuat RootRotation = <span class="built_in">FQuat</span>(RotationAxisVector, CombinedRootOffset);</span><br><span class="line">		<span class="function"><span class="type">const</span> FCompactPoseBoneIndex <span class="title">RootBoneIndex</span><span class="params">(<span class="number">0</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">		<span class="function">FTransform <span class="title">RootBoneTransform</span><span class="params">(Output.Pose.GetComponentSpaceTransform(RootBoneIndex))</span></span>;</span><br><span class="line">		RootBoneTransform.<span class="built_in">SetRotation</span>(RootRotation * RootBoneTransform.<span class="built_in">GetRotation</span>());</span><br><span class="line">		RootBoneTransform.<span class="built_in">NormalizeRotation</span>();</span><br><span class="line">		Output.Pose.<span class="built_in">SetComponentSpaceTransform</span>(RootBoneIndex, RootBoneTransform);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="type">const</span> int32 NumSpineBones = SpineBoneDataArray.<span class="built_in">Num</span>();</span><br><span class="line">	<span class="type">const</span> <span class="type">bool</span> bSpineOrientationAlpha = !FMath::<span class="built_in">IsNearlyZero</span>(DistributedBoneOrientationAlpha, KINDA_SMALL_NUMBER);</span><br><span class="line">	<span class="type">const</span> <span class="type">bool</span> bUpdateSpineBones = (NumSpineBones &gt; <span class="number">0</span>) &amp;&amp; bSpineOrientationAlpha;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (bUpdateSpineBones)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// Spine bones counter rotate body orientation evenly across all bones.</span></span><br><span class="line">		<span class="keyword">for</span> (int32 ArrayIndex = <span class="number">0</span>; ArrayIndex &lt; NumSpineBones; ArrayIndex++)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="type">const</span> FOrientationWarpingSpineBoneData&amp; BoneData = SpineBoneDataArray[ArrayIndex];</span><br><span class="line">			<span class="type">const</span> FQuat SpineBoneCounterRotation = <span class="built_in">FQuat</span>(RotationAxisVector, -ActualOrientationAngle * DistributedBoneOrientationAlpha * BoneData.Weight);</span><br><span class="line">			<span class="built_in">check</span>(BoneData.Weight &gt; <span class="number">0.f</span>);</span><br><span class="line"></span><br><span class="line">			<span class="function">FTransform <span class="title">SpineBoneTransform</span><span class="params">(Output.Pose.GetComponentSpaceTransform(BoneData.BoneIndex))</span></span>;</span><br><span class="line">			SpineBoneTransform.<span class="built_in">SetRotation</span>((SpineBoneCounterRotation * SpineBoneTransform.<span class="built_in">GetRotation</span>()));</span><br><span class="line">			SpineBoneTransform.<span class="built_in">NormalizeRotation</span>();</span><br><span class="line">			Output.Pose.<span class="built_in">SetComponentSpaceTransform</span>(BoneData.BoneIndex, SpineBoneTransform);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="type">const</span> <span class="type">float</span> IKFootRootOrientationAlpha = <span class="number">1.f</span> - DistributedBoneOrientationAlpha;</span><br><span class="line">	<span class="type">const</span> <span class="type">bool</span> bUpdateIKFootRoot = (IKFootData.IKFootRootBoneIndex != <span class="built_in">FCompactPoseBoneIndex</span>(INDEX_NONE)) &amp;&amp; !FMath::<span class="built_in">IsNearlyZero</span>(IKFootRootOrientationAlpha, KINDA_SMALL_NUMBER);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Rotate IK Foot Root</span></span><br><span class="line">	<span class="keyword">if</span> (bUpdateIKFootRoot)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="type">const</span> FQuat BoneRotation = <span class="built_in">FQuat</span>(RotationAxisVector, ActualOrientationAngle * IKFootRootOrientationAlpha);</span><br><span class="line"></span><br><span class="line">		<span class="function">FTransform <span class="title">IKFootRootTransform</span><span class="params">(Output.Pose.GetComponentSpaceTransform(IKFootData.IKFootRootBoneIndex))</span></span>;</span><br><span class="line">		IKFootRootTransform.<span class="built_in">SetRotation</span>(BoneRotation * IKFootRootTransform.<span class="built_in">GetRotation</span>());</span><br><span class="line">		IKFootRootTransform.<span class="built_in">NormalizeRotation</span>();</span><br><span class="line">		Output.Pose.<span class="built_in">SetComponentSpaceTransform</span>(IKFootData.IKFootRootBoneIndex, IKFootRootTransform);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// IK Feet </span></span><br><span class="line">		<span class="comment">// These match the root orientation, so don&#x27;t rotate them. Just preserve root rotation. </span></span><br><span class="line">		<span class="comment">// We need to update their translation though, since we rotated their parent (the IK Foot Root bone).</span></span><br><span class="line">		<span class="type">const</span> int32 NumIKFootBones = IKFootData.IKFootBoneIndexArray.<span class="built_in">Num</span>();</span><br><span class="line">		<span class="type">const</span> <span class="type">bool</span> bUpdateIKFootBones = bUpdateIKFootRoot &amp;&amp; (NumIKFootBones &gt; <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (bUpdateIKFootBones)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="type">const</span> FQuat IKFootRotation = <span class="built_in">FQuat</span>(RotationAxisVector, -ActualOrientationAngle * IKFootRootOrientationAlpha);</span><br><span class="line"></span><br><span class="line">			<span class="keyword">for</span> (int32 ArrayIndex = <span class="number">0</span>; ArrayIndex &lt; NumIKFootBones; ArrayIndex++)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="type">const</span> FCompactPoseBoneIndex&amp; IKFootBoneIndex = IKFootData.IKFootBoneIndexArray[ArrayIndex];</span><br><span class="line"></span><br><span class="line">				<span class="function">FTransform <span class="title">IKFootBoneTransform</span><span class="params">(Output.Pose.GetComponentSpaceTransform(IKFootBoneIndex))</span></span>;</span><br><span class="line">				IKFootBoneTransform.<span class="built_in">SetRotation</span>(IKFootRotation * IKFootBoneTransform.<span class="built_in">GetRotation</span>());</span><br><span class="line">				IKFootBoneTransform.<span class="built_in">NormalizeRotation</span>();</span><br><span class="line">				Output.Pose.<span class="built_in">SetComponentSpaceTransform</span>(IKFootBoneIndex, IKFootBoneTransform);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	OutBoneTransforms.<span class="built_in">Sort</span>(<span class="built_in">FCompareBoneTransformIndex</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="Distance-Match-距离匹配"><a href="#Distance-Match-距离匹配" class="headerlink" title="Distance Match (距离匹配)"></a>Distance Match (距离匹配)</h3><p>通过移动输入的实际位移，调整动画，解决起步或者停步时的滑步问题。</p>
<p>与参考文章有所出入，有些函数已经被移除插件库。</p>
<p>注释中提到需要跟步幅扭曲有所配合，因为AdvanceTimeByDistanceMatching似乎仅仅是提供了播放速率的调整，并没有调整骨骼。</p>
<ul>
<li>Engine\Plugins\Animation\AnimationLocomotionLibrary\Source\Runtime\Private\AnimDistanceMatchingLibrary.cpp<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">FSequenceEvaluatorReference <span class="title">UAnimDistanceMatchingLibrary::AdvanceTimeByDistanceMatching</span><span class="params">(<span class="type">const</span> FAnimUpdateContext&amp; UpdateContext, <span class="type">const</span> FSequenceEvaluatorReference&amp; SequenceEvaluator, <span class="type">float</span> DistanceTraveled, FName DistanceCurveName, FVector2D PlayRateClamp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	SequenceEvaluator.<span class="built_in">CallAnimNodeFunction</span>&lt;FAnimNode_SequenceEvaluator&gt;(</span><br><span class="line">		<span class="built_in">TEXT</span>(<span class="string">&quot;AdvanceTimeByDistanceMatching&quot;</span>),</span><br><span class="line">		[&amp;UpdateContext, DistanceTraveled, DistanceCurveName, PlayRateClamp](FAnimNode_SequenceEvaluator&amp; InSequenceEvaluator)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span> (<span class="type">const</span> FAnimationUpdateContext* AnimationUpdateContext = UpdateContext.<span class="built_in">GetContext</span>())</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="type">const</span> <span class="type">float</span> DeltaTime = AnimationUpdateContext-&gt;<span class="built_in">GetDeltaTime</span>(); </span><br><span class="line"></span><br><span class="line">				<span class="keyword">if</span> (DeltaTime &gt; <span class="number">0</span> &amp;&amp; DistanceTraveled &gt; <span class="number">0</span>)</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="keyword">if</span> (<span class="type">const</span> UAnimSequenceBase* AnimSequence = <span class="built_in">Cast</span>&lt;UAnimSequence&gt;(InSequenceEvaluator.<span class="built_in">GetSequence</span>()))</span><br><span class="line">					&#123;</span><br><span class="line">						<span class="type">const</span> <span class="type">float</span> CurrentTime = InSequenceEvaluator.<span class="built_in">GetExplicitTime</span>();</span><br><span class="line">						<span class="type">const</span> <span class="type">float</span> CurrentAssetLength = InSequenceEvaluator.<span class="built_in">GetCurrentAssetLength</span>();</span><br><span class="line">						<span class="type">const</span> <span class="type">bool</span> bAllowLooping = InSequenceEvaluator.<span class="built_in">GetShouldLoop</span>();</span><br><span class="line"></span><br><span class="line">						<span class="type">const</span> USkeleton::AnimCurveUID CurveUID = UE::Anim::DistanceMatchingUtility::<span class="built_in">GetCurveUID</span>(AnimSequence, DistanceCurveName);</span><br><span class="line">						<span class="type">float</span> TimeAfterDistanceTraveled = UE::Anim::DistanceMatchingUtility::<span class="built_in">GetTimeAfterDistanceTraveled</span>(AnimSequence, CurrentTime, DistanceTraveled, CurveUID, bAllowLooping);</span><br><span class="line"></span><br><span class="line">						<span class="comment">// Calculate the effective playrate that would result from advancing the animation by the distance traveled.</span></span><br><span class="line">						<span class="comment">// Account for the animation looping.</span></span><br><span class="line">						<span class="keyword">if</span> (TimeAfterDistanceTraveled &lt; CurrentTime)</span><br><span class="line">						&#123;</span><br><span class="line">							TimeAfterDistanceTraveled += CurrentAssetLength;</span><br><span class="line">						&#125;</span><br><span class="line">						<span class="type">float</span> EffectivePlayRate = (TimeAfterDistanceTraveled - CurrentTime) / DeltaTime;</span><br><span class="line"></span><br><span class="line">						<span class="comment">// Clamp the effective play rate.</span></span><br><span class="line">						<span class="keyword">if</span> (PlayRateClamp.X &gt;= <span class="number">0.0f</span> &amp;&amp; PlayRateClamp.X &lt; PlayRateClamp.Y)</span><br><span class="line">						&#123;</span><br><span class="line">							EffectivePlayRate = FMath::<span class="built_in">Clamp</span>(EffectivePlayRate, PlayRateClamp.X, PlayRateClamp.Y);</span><br><span class="line">						&#125;</span><br><span class="line"></span><br><span class="line">						<span class="comment">// Advance animation time by the effective play rate.</span></span><br><span class="line">						<span class="type">float</span> NewTime = CurrentTime;</span><br><span class="line">						FAnimationRuntime::<span class="built_in">AdvanceTime</span>(bAllowLooping, EffectivePlayRate * DeltaTime, NewTime, CurrentAssetLength);</span><br><span class="line"></span><br><span class="line">						<span class="keyword">if</span> (!InSequenceEvaluator.<span class="built_in">SetExplicitTime</span>(NewTime))</span><br><span class="line">						&#123;</span><br><span class="line">							<span class="built_in">UE_LOG</span>(LogAnimDistanceMatchingLibrary, Warning, <span class="built_in">TEXT</span>(<span class="string">&quot;Could not set explicit time on sequence evaluator, value is not dynamic. Set it as Always Dynamic.&quot;</span>));</span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line">					<span class="keyword">else</span></span><br><span class="line">					&#123;</span><br><span class="line">						<span class="built_in">UE_LOG</span>(LogAnimDistanceMatchingLibrary, Warning, <span class="built_in">TEXT</span>(<span class="string">&quot;Sequence evaluator does not have an anim sequence to play.&quot;</span>));</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">			&#123;</span><br><span class="line">				<span class="built_in">UE_LOG</span>(LogAnimDistanceMatchingLibrary, Warning, <span class="built_in">TEXT</span>(<span class="string">&quot;AdvanceTimeByDistanceMatching called with invalid context&quot;</span>));</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> SequenceEvaluator;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">FSequenceEvaluatorReference <span class="title">UAnimDistanceMatchingLibrary::DistanceMatchToTarget</span><span class="params">(<span class="type">const</span> FSequenceEvaluatorReference&amp; SequenceEvaluator, <span class="type">float</span> DistanceToTarget, FName DistanceCurveName)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	SequenceEvaluator.<span class="built_in">CallAnimNodeFunction</span>&lt;FAnimNode_SequenceEvaluator&gt;(</span><br><span class="line">		<span class="built_in">TEXT</span>(<span class="string">&quot;DistanceMatchToTarget&quot;</span>),</span><br><span class="line">		[DistanceToTarget, DistanceCurveName](FAnimNode_SequenceEvaluator&amp; InSequenceEvaluator)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span> (<span class="type">const</span> UAnimSequenceBase* AnimSequence = <span class="built_in">Cast</span>&lt;UAnimSequence&gt;(InSequenceEvaluator.<span class="built_in">GetSequence</span>()))</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="type">const</span> USkeleton::AnimCurveUID CurveUID = UE::Anim::DistanceMatchingUtility::<span class="built_in">GetCurveUID</span>(AnimSequence, DistanceCurveName);</span><br><span class="line">				<span class="keyword">if</span> (AnimSequence-&gt;<span class="built_in">HasCurveData</span>(CurveUID))</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="comment">// By convention, distance curves store the distance to a target as a negative value.</span></span><br><span class="line">					<span class="type">const</span> <span class="type">float</span> NewTime = UE::Anim::DistanceMatchingUtility::<span class="built_in">GetAnimPositionFromDistance</span>(AnimSequence, -DistanceToTarget, CurveUID);</span><br><span class="line">					<span class="keyword">if</span> (!InSequenceEvaluator.<span class="built_in">SetExplicitTime</span>(NewTime))</span><br><span class="line">					&#123;</span><br><span class="line">						<span class="built_in">UE_LOG</span>(LogAnimDistanceMatchingLibrary, Warning, <span class="built_in">TEXT</span>(<span class="string">&quot;Could not set explicit time on sequence evaluator, value is not dynamic. Set it as Always Dynamic.&quot;</span>));</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">else</span></span><br><span class="line">				&#123;</span><br><span class="line">					<span class="built_in">UE_LOG</span>(LogAnimDistanceMatchingLibrary, Warning, <span class="built_in">TEXT</span>(<span class="string">&quot;DistanceMatchToTarget called with invalid DistanceCurveName or animation (%s) is missing a distance curve.&quot;</span>), *<span class="built_in">GetNameSafe</span>(AnimSequence));</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">			&#123;</span><br><span class="line">				<span class="built_in">UE_LOG</span>(LogAnimDistanceMatchingLibrary, Warning, <span class="built_in">TEXT</span>(<span class="string">&quot;Sequence evaluator does not have an anim sequence to play.&quot;</span>));</span><br><span class="line">			&#125;</span><br><span class="line">			</span><br><span class="line">		&#125;);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> SequenceEvaluator;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">FSequencePlayerReference <span class="title">UAnimDistanceMatchingLibrary::SetPlayrateToMatchSpeed</span><span class="params">(<span class="type">const</span> FSequencePlayerReference&amp; SequencePlayer, <span class="type">float</span> SpeedToMatch, FVector2D PlayRateClamp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	SequencePlayer.<span class="built_in">CallAnimNodeFunction</span>&lt;FAnimNode_SequencePlayer&gt;(</span><br><span class="line">		<span class="built_in">TEXT</span>(<span class="string">&quot;SetPlayrateToMatchSpeed&quot;</span>),</span><br><span class="line">		[SpeedToMatch, PlayRateClamp](FAnimNode_SequencePlayer&amp; InSequencePlayer)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span> (<span class="type">const</span> UAnimSequence* AnimSequence = <span class="built_in">Cast</span>&lt;UAnimSequence&gt;(InSequencePlayer.<span class="built_in">GetSequence</span>()))</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="type">const</span> <span class="type">float</span> AnimLength = AnimSequence-&gt;<span class="built_in">GetPlayLength</span>();</span><br><span class="line">				<span class="keyword">if</span> (!FMath::<span class="built_in">IsNearlyZero</span>(AnimLength))</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="comment">// Calculate the speed as: (distance traveled by the animation) / (length of the animation)</span></span><br><span class="line">					<span class="type">const</span> FVector RootMotionTranslation = AnimSequence-&gt;<span class="built_in">ExtractRootMotionFromRange</span>(<span class="number">0.0f</span>, AnimLength).<span class="built_in">GetTranslation</span>();</span><br><span class="line">					<span class="type">const</span> <span class="type">float</span> RootMotionDistance = RootMotionTranslation.<span class="built_in">Size2D</span>();</span><br><span class="line">					<span class="keyword">if</span> (!FMath::<span class="built_in">IsNearlyZero</span>(RootMotionDistance))</span><br><span class="line">					&#123;</span><br><span class="line">						<span class="type">const</span> <span class="type">float</span> AnimationSpeed = RootMotionDistance / AnimLength;</span><br><span class="line">						<span class="type">float</span> DesiredPlayRate = SpeedToMatch / AnimationSpeed;</span><br><span class="line">						<span class="keyword">if</span> (PlayRateClamp.X &gt;= <span class="number">0.0f</span> &amp;&amp; PlayRateClamp.X &lt; PlayRateClamp.Y)</span><br><span class="line">						&#123;</span><br><span class="line">							DesiredPlayRate = FMath::<span class="built_in">Clamp</span>(DesiredPlayRate, PlayRateClamp.X, PlayRateClamp.Y);</span><br><span class="line">						&#125;</span><br><span class="line"></span><br><span class="line">						<span class="keyword">if</span> (!InSequencePlayer.<span class="built_in">SetPlayRate</span>(DesiredPlayRate))</span><br><span class="line">						&#123;</span><br><span class="line">							<span class="built_in">UE_LOG</span>(LogAnimDistanceMatchingLibrary, Warning, <span class="built_in">TEXT</span>(<span class="string">&quot;Could not set play rate on sequence player, value is not dynamic. Set it as Always Dynamic.&quot;</span>));</span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line">					<span class="keyword">else</span></span><br><span class="line">					&#123;</span><br><span class="line">						<span class="built_in">UE_LOG</span>(LogAnimDistanceMatchingLibrary, Warning, <span class="built_in">TEXT</span>(<span class="string">&quot;Unable to adjust playrate for animation with no root motion delta (%s).&quot;</span>), *<span class="built_in">GetNameSafe</span>(AnimSequence));</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">else</span></span><br><span class="line">				&#123;</span><br><span class="line">					<span class="built_in">UE_LOG</span>(LogAnimDistanceMatchingLibrary, Warning, <span class="built_in">TEXT</span>(<span class="string">&quot;Unable to adjust playrate for zero length animation (%s).&quot;</span>), *<span class="built_in">GetNameSafe</span>(AnimSequence));</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">			&#123;</span><br><span class="line">				<span class="built_in">UE_LOG</span>(LogAnimDistanceMatchingLibrary, Warning, <span class="built_in">TEXT</span>(<span class="string">&quot;Sequence player does not have an anim sequence to play.&quot;</span>));</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> SequencePlayer;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="Pivot"><a href="#Pivot" class="headerlink" title="Pivot"></a>Pivot</h3><p>?回转运动?主要是指进行反方向移动时应该执行的动画，比如前进中收到后退的输入，以现实来说应该先做出减速的动作再往后加速</p>
<h3 id="Aim-Offset-瞄准偏移"><a href="#Aim-Offset-瞄准偏移" class="headerlink" title="Aim Offset (瞄准偏移)"></a>Aim Offset (瞄准偏移)</h3><h1 id="Lyra-Inventory-and-Lyra-Equipment"><a href="#Lyra-Inventory-and-Lyra-Equipment" class="headerlink" title="Lyra Inventory and Lyra Equipment"></a>Lyra Inventory and Lyra Equipment</h1><h2 id="Class-Diagram-1"><a href="#Class-Diagram-1" class="headerlink" title="Class Diagram"></a>Class Diagram</h2><img data-src="/2023/06/20/Lyra/Unreal%20Engine%205%20Lyra%20Starter%20Game%20Weapon%20Class%20Diagram.png" class="" title="Inventory and Equipment">

<h2 id="Key-Class-3"><a href="#Key-Class-3" class="headerlink" title="Key Class"></a>Key Class</h2><ul>
<li>ULyraInventoryManagerComponent</li>
</ul>
<h1 id="Lyra-Abilities"><a href="#Lyra-Abilities" class="headerlink" title="Lyra Abilities"></a>Lyra Abilities</h1><p>使用游戏技能系统来构建玩法内容，同时也会依赖Game Features来动态装卸玩法内容。</p>
<h2 id="Key-Class-4"><a href="#Key-Class-4" class="headerlink" title="Key Class"></a>Key Class</h2><ul>
<li>FLyraAbilityGrant</li>
</ul>
<p>Lyra技能结构体，有UGameplayAbility成员，意义大概是定义要赋予的技能。UInputAction成员目前被注释掉了，并且提到该成员可以留空。</p>
<ul>
<li>FLyraAttributeSetGrant</li>
</ul>
<p>Lyra属性集结构体，有UAtrributeSet成员和UDataTable成员，意义大概也是定义要赋予的属性集，UDatatable成员是用来存储初始化数据，可以留空。</p>
<ul>
<li>ULyraAbilitySet</li>
</ul>
<blockquote>
<p>Non-mutable data asset used to grant gameplay abilities and gameplay effects.</p>
</blockquote>
<p>继承UPrimaryDataAsset，用来赋予给Actor的技能和玩法效果的不可变数据资产。</p>
<ul>
<li>FGameFeatureAbilitiesEntry</li>
</ul>
<p>在Game Feature中使用的Gameplay Ability System的数据结构单位，包含有FLyraAbiltyGrant成员数组、FLyraAttributeSetGrant成员数组、ULyraAbilitySet成员数组，另外还有一个Actor成员，意义是该结构体的技能要添加到的Actor。</p>
<ul>
<li>UGameFeatureAction_AddAbilities</li>
</ul>
<blockquote>
<p>GameFeatureAction responsible for granting abilities (and attributes) to actors of a specified type.</p>
</blockquote>
<p>继承UGameFeatureAction_WorldActionBase，负责赋予Actor特定技能和激活技能相关的逻辑。Abilities相关的Game Feature激活时会调用此类定义的回调函数。</p>
<ul>
<li>ULyraGameplayAbility</li>
</ul>
<blockquote>
<p>The base gameplay ability class used by this project.</p>
</blockquote>
<p>继承UGameplayAbility，Lyra的游戏技能基类。</p>
<ul>
<li>ULyraGameplayAbility_FromEquipment</li>
</ul>
<blockquote>
<p>An ability granted by and associated with an equipment instance.</p>
</blockquote>
<p>继承ULyraGameplayAbility，一种与装备实例相关的技能类。</p>
<ul>
<li>ULyraGameplayAbility_RangedWeapon</li>
</ul>
<blockquote>
<p>An ability granted by and associated with a ranged weapon instance</p>
</blockquote>
<p>继承ULyraGameplayAbility_FromEquipment，一种与远程武器实例相关的技能类。</p>
<h2 id="Flow-Chart"><a href="#Flow-Chart" class="headerlink" title="Flow Chart"></a>Flow Chart</h2><p>需要结合游戏技能系统的工作流程来构造成一个Lyra项目下完整的技能工作流程。</p>


<h2 id="Implementation"><a href="#Implementation" class="headerlink" title="Implementation"></a>Implementation</h2><ul>
<li><p>LyraStarterGame\Source\LyraGame\GameFeatures\GameFeatureAciton_AddAbilities.cpp</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">UGameFeatureAction_AddAbilities::AddToWorld</span><span class="params">(<span class="type">const</span> FWorldContext&amp; WorldContext, <span class="type">const</span> FGameFeatureStateChangeContext&amp; ChangeContext)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	UWorld* World = WorldContext.<span class="built_in">World</span>();</span><br><span class="line">	UGameInstance* GameInstance = WorldContext.OwningGameInstance;</span><br><span class="line">	FPerContextData&amp; ActiveData = ContextData.<span class="built_in">FindOrAdd</span>(ChangeContext);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> ((GameInstance != <span class="literal">nullptr</span>) &amp;&amp; (World != <span class="literal">nullptr</span>) &amp;&amp; World-&gt;<span class="built_in">IsGameWorld</span>())</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (UGameFrameworkComponentManager* ComponentMan = UGameInstance::<span class="built_in">GetSubsystem</span>&lt;UGameFrameworkComponentManager&gt;(GameInstance))</span><br><span class="line">		&#123;			</span><br><span class="line">			int32 EntryIndex = <span class="number">0</span>;</span><br><span class="line">			<span class="keyword">for</span> (<span class="type">const</span> FGameFeatureAbilitiesEntry&amp; Entry : AbilitiesList)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">if</span> (!Entry.ActorClass.<span class="built_in">IsNull</span>())</span><br><span class="line">				&#123;</span><br><span class="line">					UGameFrameworkComponentManager::FExtensionHandlerDelegate AddAbilitiesDelegate = UGameFrameworkComponentManager::FExtensionHandlerDelegate::<span class="built_in">CreateUObject</span>(</span><br><span class="line">						<span class="keyword">this</span>, &amp;UGameFeatureAction_AddAbilities::HandleActorExtension, EntryIndex, ChangeContext);</span><br><span class="line">					TSharedPtr&lt;FComponentRequestHandle&gt; ExtensionRequestHandle = ComponentMan-&gt;<span class="built_in">AddExtensionHandler</span>(Entry.ActorClass, AddAbilitiesDelegate);</span><br><span class="line"></span><br><span class="line">					ActiveData.ComponentRequests.<span class="built_in">Add</span>(ExtensionRequestHandle);</span><br><span class="line">					EntryIndex++;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">UGameFeatureAction_AddAbilities::HandleActorExtension</span><span class="params">(AActor* Actor, FName EventName, int32 EntryIndex, FGameFeatureStateChangeContext ChangeContext)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	FPerContextData* ActiveData = ContextData.<span class="built_in">Find</span>(ChangeContext);</span><br><span class="line">	<span class="keyword">if</span> (AbilitiesList.<span class="built_in">IsValidIndex</span>(EntryIndex) &amp;&amp; ActiveData)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="type">const</span> FGameFeatureAbilitiesEntry&amp; Entry = AbilitiesList[EntryIndex];</span><br><span class="line">		<span class="keyword">if</span> ((EventName == UGameFrameworkComponentManager::NAME_ExtensionRemoved) || (EventName == UGameFrameworkComponentManager::NAME_ReceiverRemoved))</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">RemoveActorAbilities</span>(Actor, *ActiveData);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> ((EventName == UGameFrameworkComponentManager::NAME_ExtensionAdded) || (EventName == ALyraPlayerState::NAME_LyraAbilityReady))</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">AddActorAbilities</span>(Actor, Entry, *ActiveData);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">UGameFeatureAction_AddAbilities::AddActorAbilities</span><span class="params">(AActor* Actor, <span class="type">const</span> FGameFeatureAbilitiesEntry&amp; AbilitiesEntry, FPerContextData&amp; ActiveData)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">check</span>(Actor);</span><br><span class="line">	<span class="keyword">if</span> (!Actor-&gt;<span class="built_in">HasAuthority</span>())</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// early out if Actor already has ability extensions applied</span></span><br><span class="line">	<span class="keyword">if</span> (ActiveData.ActiveExtensions.<span class="built_in">Find</span>(Actor) != <span class="literal">nullptr</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span>;	</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (UAbilitySystemComponent* AbilitySystemComponent = <span class="built_in">FindOrAddComponentForActor</span>&lt;UAbilitySystemComponent&gt;(Actor, AbilitiesEntry, ActiveData))</span><br><span class="line">	&#123;</span><br><span class="line">		FActorExtensions AddedExtensions;</span><br><span class="line">		AddedExtensions.Abilities.<span class="built_in">Reserve</span>(AbilitiesEntry.GrantedAbilities.<span class="built_in">Num</span>());</span><br><span class="line">		AddedExtensions.Attributes.<span class="built_in">Reserve</span>(AbilitiesEntry.GrantedAttributes.<span class="built_in">Num</span>());</span><br><span class="line">		AddedExtensions.AbilitySetHandles.<span class="built_in">Reserve</span>(AbilitiesEntry.GrantedAbilitySets.<span class="built_in">Num</span>());</span><br><span class="line"></span><br><span class="line">		<span class="keyword">for</span> (<span class="type">const</span> FLyraAbilityGrant&amp; Ability : AbilitiesEntry.GrantedAbilities)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span> (!Ability.AbilityType.<span class="built_in">IsNull</span>())</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="function">FGameplayAbilitySpec <span class="title">NewAbilitySpec</span><span class="params">(Ability.AbilityType.LoadSynchronous())</span></span>;</span><br><span class="line">				FGameplayAbilitySpecHandle AbilityHandle = AbilitySystemComponent-&gt;<span class="built_in">GiveAbility</span>(NewAbilitySpec);</span><br><span class="line"></span><br><span class="line">				AddedExtensions.Abilities.<span class="built_in">Add</span>(AbilityHandle);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">for</span> (<span class="type">const</span> FLyraAttributeSetGrant&amp; Attributes : AbilitiesEntry.GrantedAttributes)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span> (!Attributes.AttributeSetType.<span class="built_in">IsNull</span>())</span><br><span class="line">			&#123;</span><br><span class="line">				TSubclassOf&lt;UAttributeSet&gt; SetType = Attributes.AttributeSetType.<span class="built_in">LoadSynchronous</span>();</span><br><span class="line">				<span class="keyword">if</span> (SetType)</span><br><span class="line">				&#123;</span><br><span class="line">					UAttributeSet* NewSet = <span class="built_in">NewObject</span>&lt;UAttributeSet&gt;(AbilitySystemComponent-&gt;<span class="built_in">GetOwner</span>(), SetType);</span><br><span class="line">					<span class="keyword">if</span> (!Attributes.InitializationData.<span class="built_in">IsNull</span>())</span><br><span class="line">					&#123;</span><br><span class="line">						UDataTable* InitData = Attributes.InitializationData.<span class="built_in">LoadSynchronous</span>();</span><br><span class="line">						<span class="keyword">if</span> (InitData)</span><br><span class="line">						&#123;</span><br><span class="line">							NewSet-&gt;<span class="built_in">InitFromMetaDataTable</span>(InitData);</span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line"></span><br><span class="line">					AddedExtensions.Attributes.<span class="built_in">Add</span>(NewSet);</span><br><span class="line">					AbilitySystemComponent-&gt;<span class="built_in">AddAttributeSetSubobject</span>(NewSet);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		ULyraAbilitySystemComponent* LyraASC = <span class="built_in">CastChecked</span>&lt;ULyraAbilitySystemComponent&gt;(AbilitySystemComponent);</span><br><span class="line">		<span class="keyword">for</span> (<span class="type">const</span> TSoftObjectPtr&lt;<span class="type">const</span> ULyraAbilitySet&gt;&amp; SetPtr : AbilitiesEntry.GrantedAbilitySets)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span> (<span class="type">const</span> ULyraAbilitySet* Set = SetPtr.<span class="built_in">Get</span>())</span><br><span class="line">			&#123;</span><br><span class="line">				Set-&gt;<span class="built_in">GiveToAbilitySystem</span>(LyraASC, &amp;AddedExtensions.AbilitySetHandles.<span class="built_in">AddDefaulted_GetRef</span>());</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		ActiveData.ActiveExtensions.<span class="built_in">Add</span>(Actor, AddedExtensions);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">UE_LOG</span>(LogGameFeatures, Error, <span class="built_in">TEXT</span>(<span class="string">&quot;Failed to find/add an ability component to &#x27;%s&#x27;. Abilities will not be granted.&quot;</span>), *Actor-&gt;<span class="built_in">GetPathName</span>());</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>LyraStarterGame\Source\LyraGame\AbilitySystem\LyraAbilitySet.cpp</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">ULyraAbilitySet::GiveToAbilitySystem</span><span class="params">(ULyraAbilitySystemComponent* LyraASC, FLyraAbilitySet_GrantedHandles* OutGrantedHandles, UObject* SourceObject)</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">check</span>(LyraASC);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!LyraASC-&gt;<span class="built_in">IsOwnerActorAuthoritative</span>())</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// Must be authoritative to give or take ability sets.</span></span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Grant the gameplay abilities.</span></span><br><span class="line">	<span class="keyword">for</span> (int32 AbilityIndex = <span class="number">0</span>; AbilityIndex &lt; GrantedGameplayAbilities.<span class="built_in">Num</span>(); ++AbilityIndex)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="type">const</span> FLyraAbilitySet_GameplayAbility&amp; AbilityToGrant = GrantedGameplayAbilities[AbilityIndex];</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (!<span class="built_in">IsValid</span>(AbilityToGrant.Ability))</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">UE_LOG</span>(LogLyraAbilitySystem, Error, <span class="built_in">TEXT</span>(<span class="string">&quot;GrantedGameplayAbilities[%d] on ability set [%s] is not valid.&quot;</span>), AbilityIndex, *<span class="built_in">GetNameSafe</span>(<span class="keyword">this</span>));</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		ULyraGameplayAbility* AbilityCDO = AbilityToGrant.Ability-&gt;<span class="built_in">GetDefaultObject</span>&lt;ULyraGameplayAbility&gt;();</span><br><span class="line"></span><br><span class="line">		<span class="function">FGameplayAbilitySpec <span class="title">AbilitySpec</span><span class="params">(AbilityCDO, AbilityToGrant.AbilityLevel)</span></span>;</span><br><span class="line">		AbilitySpec.SourceObject = SourceObject;</span><br><span class="line">		AbilitySpec.DynamicAbilityTags.<span class="built_in">AddTag</span>(AbilityToGrant.InputTag);</span><br><span class="line"></span><br><span class="line">		<span class="type">const</span> FGameplayAbilitySpecHandle AbilitySpecHandle = LyraASC-&gt;<span class="built_in">GiveAbility</span>(AbilitySpec);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (OutGrantedHandles)</span><br><span class="line">		&#123;</span><br><span class="line">			OutGrantedHandles-&gt;<span class="built_in">AddAbilitySpecHandle</span>(AbilitySpecHandle);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Grant the gameplay effects.</span></span><br><span class="line">	<span class="keyword">for</span> (int32 EffectIndex = <span class="number">0</span>; EffectIndex &lt; GrantedGameplayEffects.<span class="built_in">Num</span>(); ++EffectIndex)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="type">const</span> FLyraAbilitySet_GameplayEffect&amp; EffectToGrant = GrantedGameplayEffects[EffectIndex];</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (!<span class="built_in">IsValid</span>(EffectToGrant.GameplayEffect))</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">UE_LOG</span>(LogLyraAbilitySystem, Error, <span class="built_in">TEXT</span>(<span class="string">&quot;GrantedGameplayEffects[%d] on ability set [%s] is not valid&quot;</span>), EffectIndex, *<span class="built_in">GetNameSafe</span>(<span class="keyword">this</span>));</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="type">const</span> UGameplayEffect* GameplayEffect = EffectToGrant.GameplayEffect-&gt;<span class="built_in">GetDefaultObject</span>&lt;UGameplayEffect&gt;();</span><br><span class="line">		<span class="type">const</span> FActiveGameplayEffectHandle GameplayEffectHandle = LyraASC-&gt;<span class="built_in">ApplyGameplayEffectToSelf</span>(GameplayEffect, EffectToGrant.EffectLevel, LyraASC-&gt;<span class="built_in">MakeEffectContext</span>());</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (OutGrantedHandles)</span><br><span class="line">		&#123;</span><br><span class="line">			OutGrantedHandles-&gt;<span class="built_in">AddGameplayEffectHandle</span>(GameplayEffectHandle);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Grant the attribute sets.</span></span><br><span class="line">	<span class="keyword">for</span> (int32 SetIndex = <span class="number">0</span>; SetIndex &lt; GrantedAttributes.<span class="built_in">Num</span>(); ++SetIndex)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="type">const</span> FLyraAbilitySet_AttributeSet&amp; SetToGrant = GrantedAttributes[SetIndex];</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (!<span class="built_in">IsValid</span>(SetToGrant.AttributeSet))</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">UE_LOG</span>(LogLyraAbilitySystem, Error, <span class="built_in">TEXT</span>(<span class="string">&quot;GrantedAttributes[%d] on ability set [%s] is not valid&quot;</span>), SetIndex, *<span class="built_in">GetNameSafe</span>(<span class="keyword">this</span>));</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		UAttributeSet* NewSet = <span class="built_in">NewObject</span>&lt;UAttributeSet&gt;(LyraASC-&gt;<span class="built_in">GetOwner</span>(), SetToGrant.AttributeSet);</span><br><span class="line">		LyraASC-&gt;<span class="built_in">AddAttributeSetSubobject</span>(NewSet);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (OutGrantedHandles)</span><br><span class="line">		&#123;</span><br><span class="line">			OutGrantedHandles-&gt;<span class="built_in">AddAttributeSet</span>(NewSet);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="Class-Diagram-2"><a href="#Class-Diagram-2" class="headerlink" title="Class Diagram"></a>Class Diagram</h2><h2 id="Conclusion-for-myself"><a href="#Conclusion-for-myself" class="headerlink" title="Conclusion for myself"></a>Conclusion for myself</h2><p>在Actor初始化后，会触发委托，Game Feature会开始通过Actor的技能组件，把技能添加到所属的Actor。</p>
<h2 id="具体逻辑样例实现"><a href="#具体逻辑样例实现" class="headerlink" title="具体逻辑样例实现"></a>具体逻辑样例实现</h2><h3 id="武器开火到伤害应用"><a href="#武器开火到伤害应用" class="headerlink" title="武器开火到伤害应用"></a>武器开火到伤害应用</h3><h4 id="Flow-Chart-1"><a href="#Flow-Chart-1" class="headerlink" title="Flow Chart"></a>Flow Chart</h4><h4 id="Key-Implmentation"><a href="#Key-Implmentation" class="headerlink" title="Key Implmentation"></a>Key Implmentation</h4><ul>
<li><p>LyraStarterGame\Source\LyraGame\Weapons\LyraGameplayAbility_RangedWeapon.cpp</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">ULyraGameplayAbility_RangedWeapon::StartRangedWeaponTargeting</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">check</span>(CurrentActorInfo);</span><br><span class="line"></span><br><span class="line">	AActor* AvatarActor = CurrentActorInfo-&gt;AvatarActor.<span class="built_in">Get</span>();</span><br><span class="line">	<span class="built_in">check</span>(AvatarActor);</span><br><span class="line"></span><br><span class="line">	UAbilitySystemComponent* MyAbilityComponent = CurrentActorInfo-&gt;AbilitySystemComponent.<span class="built_in">Get</span>();</span><br><span class="line">	<span class="built_in">check</span>(MyAbilityComponent);</span><br><span class="line"></span><br><span class="line">	AController* Controller = <span class="built_in">GetControllerFromActorInfo</span>();</span><br><span class="line">	<span class="built_in">check</span>(Controller);</span><br><span class="line">	ULyraWeaponStateComponent* WeaponStateComponent = Controller-&gt;<span class="built_in">FindComponentByClass</span>&lt;ULyraWeaponStateComponent&gt;();</span><br><span class="line"></span><br><span class="line">	<span class="function">FScopedPredictionWindow <span class="title">ScopedPrediction</span><span class="params">(MyAbilityComponent, CurrentActivationInfo.GetActivationPredictionKey())</span></span>;</span><br><span class="line"></span><br><span class="line">	TArray&lt;FHitResult&gt; FoundHits;</span><br><span class="line">	<span class="built_in">PerformLocalTargeting</span>(<span class="comment">/*out*/</span> FoundHits);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Fill out the target data from the hit results</span></span><br><span class="line">	FGameplayAbilityTargetDataHandle TargetData;</span><br><span class="line">	TargetData.UniqueId = WeaponStateComponent ? WeaponStateComponent-&gt;<span class="built_in">GetUnconfirmedServerSideHitMarkerCount</span>() : <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (FoundHits.<span class="built_in">Num</span>() &gt; <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="type">const</span> int32 CartridgeID = FMath::<span class="built_in">Rand</span>();</span><br><span class="line"></span><br><span class="line">		<span class="keyword">for</span> (<span class="type">const</span> FHitResult&amp; FoundHit : FoundHits)</span><br><span class="line">		&#123;</span><br><span class="line">			FLyraGameplayAbilityTargetData_SingleTargetHit* NewTargetData = <span class="keyword">new</span> <span class="built_in">FLyraGameplayAbilityTargetData_SingleTargetHit</span>();</span><br><span class="line">			NewTargetData-&gt;HitResult = FoundHit;</span><br><span class="line">			NewTargetData-&gt;CartridgeID = CartridgeID;</span><br><span class="line"></span><br><span class="line">			TargetData.<span class="built_in">Add</span>(NewTargetData);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Send hit marker information</span></span><br><span class="line">	<span class="type">const</span> <span class="type">bool</span> bProjectileWeapon = <span class="literal">false</span>;</span><br><span class="line">	<span class="keyword">if</span> (!bProjectileWeapon &amp;&amp; (WeaponStateComponent != <span class="literal">nullptr</span>))</span><br><span class="line">	&#123;</span><br><span class="line">		WeaponStateComponent-&gt;<span class="built_in">AddUnconfirmedServerSideHitMarkers</span>(TargetData, FoundHits);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Process the target data immediately</span></span><br><span class="line">	<span class="built_in">OnTargetDataReadyCallback</span>(TargetData, <span class="built_in">FGameplayTag</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ULyraGameplayAbility_RangedWeapon::PerformLocalTargeting</span><span class="params">(OUT TArray&lt;FHitResult&gt;&amp; OutHits)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	APawn* <span class="type">const</span> AvatarPawn = <span class="built_in">Cast</span>&lt;APawn&gt;(<span class="built_in">GetAvatarActorFromActorInfo</span>());</span><br><span class="line"></span><br><span class="line">	ULyraRangedWeaponInstance* WeaponData = <span class="built_in">GetWeaponInstance</span>();</span><br><span class="line">	<span class="keyword">if</span> (AvatarPawn &amp;&amp; AvatarPawn-&gt;<span class="built_in">IsLocallyControlled</span>() &amp;&amp; WeaponData)</span><br><span class="line">	&#123;</span><br><span class="line">		FRangedWeaponFiringInput InputData;</span><br><span class="line">		InputData.WeaponData = WeaponData;</span><br><span class="line">		InputData.bCanPlayBulletFX = (AvatarPawn-&gt;<span class="built_in">GetNetMode</span>() != NM_DedicatedServer);</span><br><span class="line"></span><br><span class="line">		<span class="comment">//@<span class="doctag">TODO:</span> Should do more complicated logic here when the player is close to a wall, etc...</span></span><br><span class="line">		<span class="type">const</span> FTransform TargetTransform = <span class="built_in">GetTargetingTransform</span>(AvatarPawn, ELyraAbilityTargetingSource::CameraTowardsFocus);</span><br><span class="line">		InputData.AimDir = TargetTransform.<span class="built_in">GetUnitAxis</span>(EAxis::X);</span><br><span class="line">		InputData.StartTrace = TargetTransform.<span class="built_in">GetTranslation</span>();</span><br><span class="line"></span><br><span class="line">		InputData.EndAim = InputData.StartTrace + InputData.AimDir * WeaponData-&gt;<span class="built_in">GetMaxDamageRange</span>();</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> ENABLE_DRAW_DEBUG</span></span><br><span class="line">		<span class="keyword">if</span> (LyraConsoleVariables::DrawBulletTracesDuration &gt; <span class="number">0.0f</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="type">static</span> <span class="type">float</span> DebugThickness = <span class="number">2.0f</span>;</span><br><span class="line">			<span class="built_in">DrawDebugLine</span>(<span class="built_in">GetWorld</span>(), InputData.StartTrace, InputData.StartTrace + (InputData.AimDir * <span class="number">100.0f</span>), FColor::Yellow, <span class="literal">false</span>, LyraConsoleVariables::DrawBulletTracesDuration, <span class="number">0</span>, DebugThickness);</span><br><span class="line">		&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">		<span class="built_in">TraceBulletsInCartridge</span>(InputData, <span class="comment">/*out*/</span> OutHits);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ULyraGameplayAbility_RangedWeapon::TraceBulletsInCartridge</span><span class="params">(<span class="type">const</span> FRangedWeaponFiringInput&amp; InputData, OUT TArray&lt;FHitResult&gt;&amp; OutHits)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	ULyraRangedWeaponInstance* WeaponData = InputData.WeaponData;</span><br><span class="line">	<span class="built_in">check</span>(WeaponData);</span><br><span class="line"></span><br><span class="line">	<span class="type">const</span> int32 BulletsPerCartridge = WeaponData-&gt;<span class="built_in">GetBulletsPerCartridge</span>();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (int32 BulletIndex = <span class="number">0</span>; BulletIndex &lt; BulletsPerCartridge; ++BulletIndex)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="type">const</span> <span class="type">float</span> BaseSpreadAngle = WeaponData-&gt;<span class="built_in">GetCalculatedSpreadAngle</span>();</span><br><span class="line">		<span class="type">const</span> <span class="type">float</span> SpreadAngleMultiplier = WeaponData-&gt;<span class="built_in">GetCalculatedSpreadAngleMultiplier</span>();</span><br><span class="line">		<span class="type">const</span> <span class="type">float</span> ActualSpreadAngle = BaseSpreadAngle * SpreadAngleMultiplier;</span><br><span class="line"></span><br><span class="line">		<span class="type">const</span> <span class="type">float</span> HalfSpreadAngleInRadians = FMath::<span class="built_in">DegreesToRadians</span>(ActualSpreadAngle * <span class="number">0.5f</span>);</span><br><span class="line"></span><br><span class="line">		<span class="type">const</span> FVector BulletDir = <span class="built_in">VRandConeNormalDistribution</span>(InputData.AimDir, HalfSpreadAngleInRadians, WeaponData-&gt;<span class="built_in">GetSpreadExponent</span>());</span><br><span class="line"></span><br><span class="line">		<span class="type">const</span> FVector EndTrace = InputData.StartTrace + (BulletDir * WeaponData-&gt;<span class="built_in">GetMaxDamageRange</span>());</span><br><span class="line">		FVector HitLocation = EndTrace;</span><br><span class="line"></span><br><span class="line">		TArray&lt;FHitResult&gt; AllImpacts;</span><br><span class="line"></span><br><span class="line">		FHitResult Impact = <span class="built_in">DoSingleBulletTrace</span>(InputData.StartTrace, EndTrace, WeaponData-&gt;<span class="built_in">GetBulletTraceSweepRadius</span>(), <span class="comment">/*bIsSimulated=*/</span> <span class="literal">false</span>, <span class="comment">/*out*/</span> AllImpacts);</span><br><span class="line"></span><br><span class="line">		<span class="type">const</span> AActor* HitActor = Impact.<span class="built_in">GetActor</span>();</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (HitActor)</span><br><span class="line">		&#123;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> ENABLE_DRAW_DEBUG</span></span><br><span class="line">			<span class="keyword">if</span> (LyraConsoleVariables::DrawBulletHitDuration &gt; <span class="number">0.0f</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="built_in">DrawDebugPoint</span>(<span class="built_in">GetWorld</span>(), Impact.ImpactPoint, LyraConsoleVariables::DrawBulletHitRadius, FColor::Red, <span class="literal">false</span>, LyraConsoleVariables::DrawBulletHitRadius);</span><br><span class="line">			&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (AllImpacts.<span class="built_in">Num</span>() &gt; <span class="number">0</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				OutHits.<span class="built_in">Append</span>(AllImpacts);</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			HitLocation = Impact.ImpactPoint;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Make sure there&#x27;s always an entry in OutHits so the direction can be used for tracers, etc...</span></span><br><span class="line">		<span class="keyword">if</span> (OutHits.<span class="built_in">Num</span>() == <span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span> (!Impact.bBlockingHit)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="comment">// Locate the fake &#x27;impact&#x27; at the end of the trace</span></span><br><span class="line">				Impact.Location = EndTrace;</span><br><span class="line">				Impact.ImpactPoint = EndTrace;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			OutHits.<span class="built_in">Add</span>(Impact);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">FHitResult <span class="title">ULyraGameplayAbility_RangedWeapon::DoSingleBulletTrace</span><span class="params">(<span class="type">const</span> FVector&amp; StartTrace, <span class="type">const</span> FVector&amp; EndTrace, <span class="type">float</span> SweepRadius, <span class="type">bool</span> bIsSimulated, OUT TArray&lt;FHitResult&gt;&amp; OutHits)</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> ENABLE_DRAW_DEBUG</span></span><br><span class="line">	<span class="keyword">if</span> (LyraConsoleVariables::DrawBulletTracesDuration &gt; <span class="number">0.0f</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="type">static</span> <span class="type">float</span> DebugThickness = <span class="number">1.0f</span>;</span><br><span class="line">		<span class="built_in">DrawDebugLine</span>(<span class="built_in">GetWorld</span>(), StartTrace, EndTrace, FColor::Red, <span class="literal">false</span>, LyraConsoleVariables::DrawBulletTracesDuration, <span class="number">0</span>, DebugThickness);</span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// ENABLE_DRAW_DEBUG</span></span></span><br><span class="line"></span><br><span class="line">	FHitResult Impact;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Trace and process instant hit if something was hit</span></span><br><span class="line">	<span class="comment">// First trace without using sweep radius</span></span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">FindFirstPawnHitResult</span>(OutHits) == INDEX_NONE)</span><br><span class="line">	&#123;</span><br><span class="line">		Impact = <span class="built_in">WeaponTrace</span>(StartTrace, EndTrace, <span class="comment">/*SweepRadius=*/</span> <span class="number">0.0f</span>, bIsSimulated, <span class="comment">/*out*/</span> OutHits);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">FindFirstPawnHitResult</span>(OutHits) == INDEX_NONE)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// If this weapon didn&#x27;t hit anything with a line trace and supports a sweep radius, try that</span></span><br><span class="line">		<span class="keyword">if</span> (SweepRadius &gt; <span class="number">0.0f</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			TArray&lt;FHitResult&gt; SweepHits;</span><br><span class="line">			Impact = <span class="built_in">WeaponTrace</span>(StartTrace, EndTrace, SweepRadius, bIsSimulated, <span class="comment">/*out*/</span> SweepHits);</span><br><span class="line"></span><br><span class="line">			<span class="comment">// If the trace with sweep radius enabled hit a pawn, check if we should use its hit results</span></span><br><span class="line">			<span class="type">const</span> int32 FirstPawnIdx = <span class="built_in">FindFirstPawnHitResult</span>(SweepHits);</span><br><span class="line">			<span class="keyword">if</span> (SweepHits.<span class="built_in">IsValidIndex</span>(FirstPawnIdx))</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="comment">// If we had a blocking hit in our line trace that occurs in SweepHits before our</span></span><br><span class="line">				<span class="comment">// hit pawn, we should just use our initial hit results since the Pawn hit should be blocked</span></span><br><span class="line">				<span class="type">bool</span> bUseSweepHits = <span class="literal">true</span>;</span><br><span class="line">				<span class="keyword">for</span> (int32 Idx = <span class="number">0</span>; Idx &lt; FirstPawnIdx; ++Idx)</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="type">const</span> FHitResult&amp; CurHitResult = SweepHits[Idx];</span><br><span class="line"></span><br><span class="line">					<span class="keyword">auto</span> Pred = [&amp;CurHitResult](<span class="type">const</span> FHitResult&amp; Other)</span><br><span class="line">					&#123;</span><br><span class="line">						<span class="keyword">return</span> Other.HitObjectHandle == CurHitResult.HitObjectHandle;</span><br><span class="line">					&#125;;</span><br><span class="line">					<span class="keyword">if</span> (CurHitResult.bBlockingHit &amp;&amp; OutHits.<span class="built_in">ContainsByPredicate</span>(Pred))</span><br><span class="line">					&#123;</span><br><span class="line">						bUseSweepHits = <span class="literal">false</span>;</span><br><span class="line">						<span class="keyword">break</span>;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				<span class="keyword">if</span> (bUseSweepHits)</span><br><span class="line">				&#123;</span><br><span class="line">					OutHits = SweepHits;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> Impact;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">FHitResult <span class="title">ULyraGameplayAbility_RangedWeapon::WeaponTrace</span><span class="params">(<span class="type">const</span> FVector&amp; StartTrace, <span class="type">const</span> FVector&amp; EndTrace, <span class="type">float</span> SweepRadius, <span class="type">bool</span> bIsSimulated, OUT TArray&lt;FHitResult&gt;&amp; OutHitResults)</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	TArray&lt;FHitResult&gt; HitResults;</span><br><span class="line">	</span><br><span class="line">	<span class="function">FCollisionQueryParams <span class="title">TraceParams</span><span class="params">(SCENE_QUERY_STAT(WeaponTrace), <span class="comment">/*bTraceComplex=*/</span> <span class="literal">true</span>, <span class="comment">/*IgnoreActor=*/</span> GetAvatarActorFromActorInfo())</span></span>;</span><br><span class="line">	TraceParams.bReturnPhysicalMaterial = <span class="literal">true</span>;</span><br><span class="line">	<span class="built_in">AddAdditionalTraceIgnoreActors</span>(TraceParams);</span><br><span class="line">	<span class="comment">//TraceParams.bDebugQuery = true;</span></span><br><span class="line"></span><br><span class="line">	<span class="type">const</span> ECollisionChannel TraceChannel = <span class="built_in">DetermineTraceChannel</span>(TraceParams, bIsSimulated);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (SweepRadius &gt; <span class="number">0.0f</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">GetWorld</span>()-&gt;<span class="built_in">SweepMultiByChannel</span>(HitResults, StartTrace, EndTrace, FQuat::Identity, TraceChannel, FCollisionShape::<span class="built_in">MakeSphere</span>(SweepRadius), TraceParams);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">GetWorld</span>()-&gt;<span class="built_in">LineTraceMultiByChannel</span>(HitResults, StartTrace, EndTrace, TraceChannel, TraceParams);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function">FHitResult <span class="title">Hit</span><span class="params">(ForceInit)</span></span>;</span><br><span class="line">	<span class="keyword">if</span> (HitResults.<span class="built_in">Num</span>() &gt; <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// Filter the output list to prevent multiple hits on the same actor;</span></span><br><span class="line">		<span class="comment">// this is to prevent a single bullet dealing damage multiple times to</span></span><br><span class="line">		<span class="comment">// a single actor if using an overlap trace</span></span><br><span class="line">		<span class="keyword">for</span> (FHitResult&amp; CurHitResult : HitResults)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">auto</span> Pred = [&amp;CurHitResult](<span class="type">const</span> FHitResult&amp; Other)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">return</span> Other.HitObjectHandle == CurHitResult.HitObjectHandle;</span><br><span class="line">			&#125;;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (!OutHitResults.<span class="built_in">ContainsByPredicate</span>(Pred))</span><br><span class="line">			&#123;</span><br><span class="line">				OutHitResults.<span class="built_in">Add</span>(CurHitResult);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		Hit = OutHitResults.<span class="built_in">Last</span>();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		Hit.TraceStart = StartTrace;</span><br><span class="line">		Hit.TraceEnd = EndTrace;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> Hit;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ULyraGameplayAbility_RangedWeapon::OnTargetDataReadyCallback</span><span class="params">(<span class="type">const</span> FGameplayAbilityTargetDataHandle&amp; InData, FGameplayTag ApplicationTag)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	UAbilitySystemComponent* MyAbilityComponent = CurrentActorInfo-&gt;AbilitySystemComponent.<span class="built_in">Get</span>();</span><br><span class="line">	<span class="built_in">check</span>(MyAbilityComponent);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (<span class="type">const</span> FGameplayAbilitySpec* AbilitySpec = MyAbilityComponent-&gt;<span class="built_in">FindAbilitySpecFromHandle</span>(CurrentSpecHandle))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="function">FScopedPredictionWindow	<span class="title">ScopedPrediction</span><span class="params">(MyAbilityComponent)</span></span>;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Take ownership of the target data to make sure no callbacks into game code invalidate it out from under us</span></span><br><span class="line">		<span class="function">FGameplayAbilityTargetDataHandle <span class="title">LocalTargetDataHandle</span><span class="params">(MoveTemp(<span class="keyword">const_cast</span>&lt;FGameplayAbilityTargetDataHandle&amp;&gt;(InData)))</span></span>;</span><br><span class="line"></span><br><span class="line">		<span class="type">const</span> <span class="type">bool</span> bShouldNotifyServer = CurrentActorInfo-&gt;<span class="built_in">IsLocallyControlled</span>() &amp;&amp; !CurrentActorInfo-&gt;<span class="built_in">IsNetAuthority</span>();</span><br><span class="line">		<span class="keyword">if</span> (bShouldNotifyServer)</span><br><span class="line">		&#123;</span><br><span class="line">			MyAbilityComponent-&gt;<span class="built_in">CallServerSetReplicatedTargetData</span>(CurrentSpecHandle, CurrentActivationInfo.<span class="built_in">GetActivationPredictionKey</span>(), LocalTargetDataHandle, ApplicationTag, MyAbilityComponent-&gt;ScopedPredictionKey);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="type">const</span> <span class="type">bool</span> bIsTargetDataValid = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">		<span class="type">bool</span> bProjectileWeapon = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> WITH_SERVER_CODE</span></span><br><span class="line">		<span class="keyword">if</span> (!bProjectileWeapon)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span> (AController* Controller = <span class="built_in">GetControllerFromActorInfo</span>())</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">if</span> (Controller-&gt;<span class="built_in">GetLocalRole</span>() == ROLE_Authority)</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="comment">// Confirm hit markers</span></span><br><span class="line">					<span class="keyword">if</span> (ULyraWeaponStateComponent* WeaponStateComponent = Controller-&gt;<span class="built_in">FindComponentByClass</span>&lt;ULyraWeaponStateComponent&gt;())</span><br><span class="line">					&#123;</span><br><span class="line">						TArray&lt;uint8&gt; HitReplaces;</span><br><span class="line">						<span class="keyword">for</span> (uint8 i = <span class="number">0</span>; (i &lt; LocalTargetDataHandle.<span class="built_in">Num</span>()) &amp;&amp; (i &lt; <span class="number">255</span>); ++i)</span><br><span class="line">						&#123;</span><br><span class="line">							<span class="keyword">if</span> (FGameplayAbilityTargetData_SingleTargetHit* SingleTargetHit = <span class="built_in">static_cast</span>&lt;FGameplayAbilityTargetData_SingleTargetHit*&gt;(LocalTargetDataHandle.<span class="built_in">Get</span>(i)))</span><br><span class="line">							&#123;</span><br><span class="line">								<span class="keyword">if</span> (SingleTargetHit-&gt;bHitReplaced)</span><br><span class="line">								&#123;</span><br><span class="line">									HitReplaces.<span class="built_in">Add</span>(i);</span><br><span class="line">								&#125;</span><br><span class="line">							&#125;</span><br><span class="line">						&#125;</span><br><span class="line"></span><br><span class="line">						WeaponStateComponent-&gt;<span class="built_in">ClientConfirmTargetData</span>(LocalTargetDataHandle.UniqueId, bIsTargetDataValid, HitReplaces);</span><br><span class="line">					&#125;</span><br><span class="line"></span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">//WITH_SERVER_CODE</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">		<span class="comment">// See if we still have ammo</span></span><br><span class="line">		<span class="keyword">if</span> (bIsTargetDataValid &amp;&amp; <span class="built_in">CommitAbility</span>(CurrentSpecHandle, CurrentActorInfo, CurrentActivationInfo))</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">// We fired the weapon, add spread</span></span><br><span class="line">			ULyraRangedWeaponInstance* WeaponData = <span class="built_in">GetWeaponInstance</span>();</span><br><span class="line">			<span class="built_in">check</span>(WeaponData);</span><br><span class="line">			WeaponData-&gt;<span class="built_in">AddSpread</span>();</span><br><span class="line"></span><br><span class="line">			<span class="comment">// Let the blueprint do stuff like apply effects to the targets</span></span><br><span class="line">			<span class="built_in">OnRangedWeaponTargetDataReady</span>(LocalTargetDataHandle);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">UE_LOG</span>(LogLyraAbilitySystem, Warning, <span class="built_in">TEXT</span>(<span class="string">&quot;Weapon ability %s failed to commit (bIsTargetDataValid=%d)&quot;</span>), *<span class="built_in">GetPathName</span>(), bIsTargetDataValid ? <span class="number">1</span> : <span class="number">0</span>);</span><br><span class="line">			<span class="built_in">K2_EndAbility</span>();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// We&#x27;ve processed the data</span></span><br><span class="line">	MyAbilityComponent-&gt;<span class="built_in">ConsumeClientReplicatedTargetData</span>(CurrentSpecHandle, CurrentActivationInfo.<span class="built_in">GetActivationPredictionKey</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>LyraStarterGame\Source\LyraGame\AbilitySystem\Executions\LyraDamageExecution.cpp</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">ULyraDamageExecution::Execute_Implementation</span><span class="params">(<span class="type">const</span> FGameplayEffectCustomExecutionParameters&amp; ExecutionParams, FGameplayEffectCustomExecutionOutput&amp; OutExecutionOutput)</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> WITH_SERVER_CODE</span></span><br><span class="line">	<span class="type">const</span> FGameplayEffectSpec&amp; Spec = ExecutionParams.<span class="built_in">GetOwningSpec</span>();</span><br><span class="line">	FLyraGameplayEffectContext* TypedContext = FLyraGameplayEffectContext::<span class="built_in">ExtractEffectContext</span>(Spec.<span class="built_in">GetContext</span>());</span><br><span class="line">	<span class="built_in">check</span>(TypedContext);</span><br><span class="line"></span><br><span class="line">	<span class="type">const</span> FGameplayTagContainer* SourceTags = Spec.CapturedSourceTags.<span class="built_in">GetAggregatedTags</span>();</span><br><span class="line">	<span class="type">const</span> FGameplayTagContainer* TargetTags = Spec.CapturedTargetTags.<span class="built_in">GetAggregatedTags</span>();</span><br><span class="line"></span><br><span class="line">	FAggregatorEvaluateParameters EvaluateParameters;</span><br><span class="line">	EvaluateParameters.SourceTags = SourceTags;</span><br><span class="line">	EvaluateParameters.TargetTags = TargetTags;</span><br><span class="line"></span><br><span class="line">	<span class="type">float</span> BaseDamage = <span class="number">0.0f</span>;</span><br><span class="line">	ExecutionParams.<span class="built_in">AttemptCalculateCapturedAttributeMagnitude</span>(<span class="built_in">DamageStatics</span>().BaseDamageDef, EvaluateParameters, BaseDamage);</span><br><span class="line"></span><br><span class="line">	<span class="type">const</span> AActor* EffectCauser = TypedContext-&gt;<span class="built_in">GetEffectCauser</span>();</span><br><span class="line">	<span class="type">const</span> FHitResult* HitActorResult = TypedContext-&gt;<span class="built_in">GetHitResult</span>();</span><br><span class="line"></span><br><span class="line">	AActor* HitActor = <span class="literal">nullptr</span>;</span><br><span class="line">	FVector ImpactLocation = FVector::ZeroVector;</span><br><span class="line">	FVector ImpactNormal = FVector::ZeroVector;</span><br><span class="line">	FVector StartTrace = FVector::ZeroVector;</span><br><span class="line">	FVector EndTrace = FVector::ZeroVector;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Calculation of hit actor, surface, zone, and distance all rely on whether the calculation has a hit result or not.</span></span><br><span class="line">	<span class="comment">// Effects just being added directly w/o having been targeted will always come in without a hit result, which must default</span></span><br><span class="line">	<span class="comment">// to some fallback information.</span></span><br><span class="line">	<span class="keyword">if</span> (HitActorResult)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="type">const</span> FHitResult&amp; CurHitResult = *HitActorResult;</span><br><span class="line">		HitActor = CurHitResult.HitObjectHandle.<span class="built_in">FetchActor</span>();</span><br><span class="line">		<span class="keyword">if</span> (HitActor)</span><br><span class="line">		&#123;</span><br><span class="line">			ImpactLocation = CurHitResult.ImpactPoint;</span><br><span class="line">			ImpactNormal = CurHitResult.ImpactNormal;</span><br><span class="line">			StartTrace = CurHitResult.TraceStart;</span><br><span class="line">			EndTrace = CurHitResult.TraceEnd;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Handle case of no hit result or hit result not actually returning an actor</span></span><br><span class="line">	UAbilitySystemComponent* TargetAbilitySystemComponent = ExecutionParams.<span class="built_in">GetTargetAbilitySystemComponent</span>();</span><br><span class="line">	<span class="keyword">if</span> (!HitActor)</span><br><span class="line">	&#123;</span><br><span class="line">		HitActor = TargetAbilitySystemComponent ? TargetAbilitySystemComponent-&gt;<span class="built_in">GetAvatarActor_Direct</span>() : <span class="literal">nullptr</span>;</span><br><span class="line">		<span class="keyword">if</span> (HitActor)</span><br><span class="line">		&#123;</span><br><span class="line">			ImpactLocation = HitActor-&gt;<span class="built_in">GetActorLocation</span>();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Apply rules for team damage/self damage/etc...</span></span><br><span class="line">	<span class="type">float</span> DamageInteractionAllowedMultiplier = <span class="number">0.0f</span>;</span><br><span class="line">	<span class="keyword">if</span> (HitActor)</span><br><span class="line">	&#123;</span><br><span class="line">		ULyraTeamSubsystem* TeamSubsystem = HitActor-&gt;<span class="built_in">GetWorld</span>()-&gt;<span class="built_in">GetSubsystem</span>&lt;ULyraTeamSubsystem&gt;();</span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">ensure</span>(TeamSubsystem))</span><br><span class="line">		&#123;</span><br><span class="line">			DamageInteractionAllowedMultiplier = TeamSubsystem-&gt;<span class="built_in">CanCauseDamage</span>(EffectCauser, HitActor) ? <span class="number">1.0</span> : <span class="number">0.0</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Determine distance</span></span><br><span class="line">	<span class="type">double</span> Distance = WORLD_MAX;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (TypedContext-&gt;<span class="built_in">HasOrigin</span>())</span><br><span class="line">	&#123;</span><br><span class="line">		Distance = FVector::<span class="built_in">Dist</span>(TypedContext-&gt;<span class="built_in">GetOrigin</span>(), ImpactLocation);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (EffectCauser)</span><br><span class="line">	&#123;</span><br><span class="line">		Distance = FVector::<span class="built_in">Dist</span>(EffectCauser-&gt;<span class="built_in">GetActorLocation</span>(), ImpactLocation);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">ensureMsgf</span>(<span class="literal">false</span>, <span class="built_in">TEXT</span>(<span class="string">&quot;Damage Calculation cannot deduce a source location for damage coming from %s; Falling back to WORLD_MAX dist!&quot;</span>), *<span class="built_in">GetPathNameSafe</span>(Spec.Def));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Apply ability source modifiers</span></span><br><span class="line">	<span class="type">float</span> PhysicalMaterialAttenuation = <span class="number">1.0f</span>;</span><br><span class="line">	<span class="type">float</span> DistanceAttenuation = <span class="number">1.0f</span>;</span><br><span class="line">	<span class="keyword">if</span> (<span class="type">const</span> ILyraAbilitySourceInterface* AbilitySource = TypedContext-&gt;<span class="built_in">GetAbilitySource</span>())</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (<span class="type">const</span> UPhysicalMaterial* PhysMat = TypedContext-&gt;<span class="built_in">GetPhysicalMaterial</span>())</span><br><span class="line">		&#123;</span><br><span class="line">			PhysicalMaterialAttenuation = AbilitySource-&gt;<span class="built_in">GetPhysicalMaterialAttenuation</span>(PhysMat, SourceTags, TargetTags);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		DistanceAttenuation = AbilitySource-&gt;<span class="built_in">GetDistanceAttenuation</span>(Distance, SourceTags, TargetTags);</span><br><span class="line">	&#125;</span><br><span class="line">	DistanceAttenuation = FMath::<span class="built_in">Max</span>(DistanceAttenuation, <span class="number">0.0f</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Clamping is done when damage is converted to -health</span></span><br><span class="line">	<span class="type">const</span> <span class="type">float</span> DamageDone = FMath::<span class="built_in">Max</span>(BaseDamage * DistanceAttenuation * PhysicalMaterialAttenuation * DamageInteractionAllowedMultiplier, <span class="number">0.0f</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (DamageDone &gt; <span class="number">0.0f</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// Apply a damage modifier, this gets turned into - health on the target</span></span><br><span class="line">		OutExecutionOutput.<span class="built_in">AddOutputModifier</span>(<span class="built_in">FGameplayModifierEvaluatedData</span>(ULyraHealthSet::<span class="built_in">GetDamageAttribute</span>(), EGameplayModOp::Additive, DamageDone));</span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// #if WITH_SERVER_CODE</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="Conclusion-for-myself-1"><a href="#Conclusion-for-myself-1" class="headerlink" title="Conclusion for myself"></a>Conclusion for myself</h4><p>该方案是射线检测，根据瞄准和枪械的参数进行搜索，然后通过游戏技能系统和Game Feature去调用执行伤害计算，最终再通过游戏技能系统和Game Feature应用伤害至目标Actor。</p>
<p>Modifier让我有点熟悉，是Dota 2创意工坊的文档中有提过，并且有过编写，Modifier可以当作Buff或者Debuff对象，与这里遇到的Modifier有一定程度的相似。</p>
<h1 id="Lyra-Camera"><a href="#Lyra-Camera" class="headerlink" title="Lyra Camera"></a>Lyra Camera</h1><h1 id="Lyra-AI-Behavior-Tree"><a href="#Lyra-AI-Behavior-Tree" class="headerlink" title="Lyra AI Behavior Tree"></a>Lyra AI Behavior Tree</h1><h1 id="Conclusion-for-myself-2"><a href="#Conclusion-for-myself-2" class="headerlink" title="Conclusion for myself"></a>Conclusion for myself</h1><p>Lyra的代码设计大量采用ECS架构设计，能用来缓解AActor、ACharacter、AController在Gameplay代码设计上的臃肿问题。<br>相比Unreal Engine 4时期的ShooterGame样例，Lyra样例更加复杂，提供了更好的独立游戏模板，更好的功能模块细分思路可供参考，偏向一个AAA级游戏开发工业的细分方式。<br>动态装卸玩法的框架设计非常适合网游或者长期运营的游戏，但是可能不一定适用于一些大型单机游戏。用来做RPG为主的混合类型游戏相当合适，但是不代表做别的游戏类型不合适，因为其中的代码架构设计也可以用来做别的游戏。<br>EnhancedInput比旧版本的输入提供了更多的轮子，比如长按、点按等方式不用自己造了，但是将配置、输入方式、配置映射、游戏逻辑分开，用起来其实有一点麻烦，但是其可扩展性和灵活性相当的好。不单止可以做普通的角色射击，还可以加其他载具相关的。<br>第一次接触动画向开发相关的结构，Lyra动画方案提供了更优的模块化，争取了更高的实时性能。<br>数据驱动型的Gameplay框架，可将玩法设计完全交给了设计师。但是要求设计师有写蓝图脚本的能力，不太清楚国内的团队，国外成熟的开发团队确实可以采用这个方案，因为我了解到的国外成熟团队设计师确实具备写脚本的技能。</p>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><h2 id="Official-Documentation"><a href="#Official-Documentation" class="headerlink" title="Official Documentation"></a>Official Documentation</h2><ul>
<li><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLnVucmVhbGVuZ2luZS5jb20vNS4yL2VuLVVTL2VuaGFuY2VkLWlucHV0LWluLXVucmVhbC1lbmdpbmUv">Enhanced Input in Unreal Engine | Unreal Engine 5.2 Documentation</span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLnVucmVhbGVuZ2luZS5jb20vNS4yL2VuLVVTL2dhbWVwbGF5LWFiaWxpdHktc3lzdGVtLWZvci11bnJlYWwtZW5naW5lLw==">Gameplay Ability System for Unreal Engine | Unreal Engine 5.2 Documentation</span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLnVucmVhbGVuZ2luZS5jb20vNS4yL2VuLVVTL2x5cmEtaW5wdXQtc2V0dGluZ3MtaW4tdW5yZWFsLWVuZ2luZS8=">Lyra Input Settings in Unreal Engine | Unreal Engine 5.2 Documentation</span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLnVucmVhbGVuZ2luZS5jb20vNS4yL2VuLVVTL2FiaWxpdGllcy1pbi1seXJhLWluLXVucmVhbC1lbmdpbmUv">Abilities in Lyra in Unreal Engine | Unreal Engine 5.2 Documentation</span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLnVucmVhbGVuZ2luZS5jb20vNS4yL2VuLVVTL2x5cmEtaW52ZW50b3J5LWFuZC1lcXVpcG1lbnQtaW4tdW5yZWFsLWVuZ2luZS8=">Lyra Inventory and Equipment in Unreal Engine | Unreal Engine 5.2 Documentation</span></li>
</ul>
<h2 id="Third-Party-Articles"><a href="#Third-Party-Articles" class="headerlink" title="Third-Party Articles"></a>Third-Party Articles</h2><ul>
<li><span class="exturl" data-url="aHR0cHM6Ly93d3cuZ2RjdmF1bHQuY29tL3BsYXkvMTAyNDAwMS8tT3ZlcndhdGNoLUdhbWVwbGF5LUFyY2hpdGVjdHVyZS1hbmQ=">GDC Vault - ‘Overwatch’ Gameplay Architecture and Netcode</span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC8zMDUzODYyNg==">游戏开发中的ECS架构概述 – 知乎</span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC80NzM1MzU4NTQ=">《InsideUE5》GameFeatures架构（三）初始化 - 知乎</span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC80ODQ3NjM3MjI=">《InsideUE5》GameFeatures架构（四）状态机 - 知乎</span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC80OTI4OTMwMDI=">《InsideUE5》GameFeatures架构（五）AddComponents - 知乎</span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC80NDAxNjgyNjA=">UE的GAS原理深入探究一：ASC组件与GA - 知乎</span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC81Mzc5NDk4NzA=">UE5 – Lyra中的输入模块(Input) - 知乎</span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC80NzA5NDk0MjI=">UE5 – EnhancedInput(输入增强系统) - 知乎</span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC8zNzg5NDgyNzc=">UE5 Motion Warping(运动扭曲)原理剖析及UE4适配 – 知乎</span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC81NDU1NTk4MzQ=">UE5 Distance Matching插件应用与源码解析 - 知乎</span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC81NTU5ODQ3MTI=">上万字详解UE5动画新特性Pose Warping原理与应用 – 知乎</span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC81MTczNjgxODQ=">UE5的动画蓝图（Lyra工程）- 知乎</span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC82MTQ3MTgyODY=">UE5新项目Gameplay框架设计(以Lyra为例) - 知乎</span></li>
</ul>

  </div>

   <footer>

    <div class="meta">
  <span class="item">
    <span class="icon">
      <i class="ic i-calendar-check"></i>
    </span>
    <span class="text">更新于</span>
    <time title="修改时间：2023-08-26 11:18:11" itemprop="dateModified" datetime="2023-08-26T11:18:11+08:00">2023-08-26</time>
  </span>
</div>

      

<div id="copyright">
<ul>
  <li class="author">
    <strong>本文作者： </strong>asdlkjqpwoei <i class="ic i-at"><em>@</em></i>Jager的工地
  </li>
  <li class="link">
    <strong>本文链接：</strong>
    <a href="https://asdlkjqpwoei.github.io/2023/06/20/Lyra/" title="Lyra Sample">https://asdlkjqpwoei.github.io/2023/06/20/Lyra/</a>
  </li>
  <li class="license">
    <strong>版权声明： </strong>本站所有文章除特别声明外，均采用 <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

  </footer>

</article>

  </div>
  

<div class="post-nav">
    <div class="item left">
    </div>
    <div class="item right">
      

  <a href="/2023/06/21/Cpp/" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;tva4.sinaimg.cn&#x2F;mw690&#x2F;6833939bly1gipewkhf1zj20zk0m81kx.jpg" title="Cpp Basis">
  <span class="type">下一篇</span>
  <span class="category"><i class="ic i-flag"></i> Cpp</span>
  <h3>Cpp Basis</h3>
  </a>

    </div>
</div>

  
  <div class="wrap" id="comments"></div>


        </div>
        <div id="sidebar">
          

<div class="inner">

  <div class="panels">
    <div class="inner">
      <div class="contents panel pjax" data-title="文章目录">
          <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Version"><span class="toc-number">1.</span> <span class="toc-text">Version</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Game-Features"><span class="toc-number">2.</span> <span class="toc-text">Game Features</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Key-Class"><span class="toc-number">2.1.</span> <span class="toc-text">Key Class</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Flow-Diagram"><span class="toc-number">2.2.</span> <span class="toc-text">Flow Diagram</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#State-Machine"><span class="toc-number">2.3.</span> <span class="toc-text">State Machine</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Key-Implementation"><span class="toc-number">2.4.</span> <span class="toc-text">Key Implementation</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Game-Abilities-System"><span class="toc-number">3.</span> <span class="toc-text">Game Abilities System</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Key-Concept"><span class="toc-number">3.1.</span> <span class="toc-text">Key Concept</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Key-Class-1"><span class="toc-number">3.2.</span> <span class="toc-text">Key Class</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Flow-Diagram-1"><span class="toc-number">3.3.</span> <span class="toc-text">Flow Diagram</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Key-Implementation-1"><span class="toc-number">3.4.</span> <span class="toc-text">Key Implementation</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Questions-x2F-Unfinished-Part"><span class="toc-number">3.5.</span> <span class="toc-text">Questions&#x2F;Unfinished Part</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Enhanced-Input"><span class="toc-number">4.</span> <span class="toc-text">Enhanced Input</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Lyra-Input"><span class="toc-number">5.</span> <span class="toc-text">Lyra Input</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Key-Class-2"><span class="toc-number">5.1.</span> <span class="toc-text">Key Class</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Flow-Diagram-2"><span class="toc-number">5.2.</span> <span class="toc-text">Flow Diagram</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#PawnData-Data-Flow"><span class="toc-number">5.2.1.</span> <span class="toc-text">PawnData Data Flow</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Key-Implementation-2"><span class="toc-number">5.2.2.</span> <span class="toc-text">Key Implementation</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Class-Diagram"><span class="toc-number">5.2.3.</span> <span class="toc-text">Class Diagram</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Flow-Diagram-3"><span class="toc-number">5.2.4.</span> <span class="toc-text">Flow Diagram</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Note"><span class="toc-number">5.3.</span> <span class="toc-text">Note</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Lyra-Animation"><span class="toc-number">6.</span> <span class="toc-text">Lyra Animation</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Required-Plugin"><span class="toc-number">6.1.</span> <span class="toc-text">Required Plugin</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Solution-Design"><span class="toc-number">6.2.</span> <span class="toc-text">Solution Design</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Notice"><span class="toc-number">6.3.</span> <span class="toc-text">Notice</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#BlueprintThreadSafeUpdateAnimation"><span class="toc-number">6.3.1.</span> <span class="toc-text">BlueprintThreadSafeUpdateAnimation</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SelectCardinalDirectionFromAngle"><span class="toc-number">6.3.2.</span> <span class="toc-text">SelectCardinalDirectionFromAngle</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Root-Motion"><span class="toc-number">6.3.3.</span> <span class="toc-text">Root Motion</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Stride-Warping-%E6%AD%A5%E5%B9%85%E6%89%AD%E6%9B%B2"><span class="toc-number">6.3.4.</span> <span class="toc-text">Stride Warping (步幅扭曲)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Orientation-Warping-%E6%96%B9%E5%90%91%E6%89%AD%E6%9B%B2"><span class="toc-number">6.3.5.</span> <span class="toc-text">Orientation Warping (方向扭曲)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Distance-Match-%E8%B7%9D%E7%A6%BB%E5%8C%B9%E9%85%8D"><span class="toc-number">6.3.6.</span> <span class="toc-text">Distance Match (距离匹配)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Pivot"><span class="toc-number">6.3.7.</span> <span class="toc-text">Pivot</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Aim-Offset-%E7%9E%84%E5%87%86%E5%81%8F%E7%A7%BB"><span class="toc-number">6.3.8.</span> <span class="toc-text">Aim Offset (瞄准偏移)</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Lyra-Inventory-and-Lyra-Equipment"><span class="toc-number">7.</span> <span class="toc-text">Lyra Inventory and Lyra Equipment</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Class-Diagram-1"><span class="toc-number">7.1.</span> <span class="toc-text">Class Diagram</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Key-Class-3"><span class="toc-number">7.2.</span> <span class="toc-text">Key Class</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Lyra-Abilities"><span class="toc-number">8.</span> <span class="toc-text">Lyra Abilities</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Key-Class-4"><span class="toc-number">8.1.</span> <span class="toc-text">Key Class</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Flow-Chart"><span class="toc-number">8.2.</span> <span class="toc-text">Flow Chart</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Implementation"><span class="toc-number">8.3.</span> <span class="toc-text">Implementation</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Class-Diagram-2"><span class="toc-number">8.4.</span> <span class="toc-text">Class Diagram</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Conclusion-for-myself"><span class="toc-number">8.5.</span> <span class="toc-text">Conclusion for myself</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B7%E4%BD%93%E9%80%BB%E8%BE%91%E6%A0%B7%E4%BE%8B%E5%AE%9E%E7%8E%B0"><span class="toc-number">8.6.</span> <span class="toc-text">具体逻辑样例实现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%AD%A6%E5%99%A8%E5%BC%80%E7%81%AB%E5%88%B0%E4%BC%A4%E5%AE%B3%E5%BA%94%E7%94%A8"><span class="toc-number">8.6.1.</span> <span class="toc-text">武器开火到伤害应用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Flow-Chart-1"><span class="toc-number">8.6.1.1.</span> <span class="toc-text">Flow Chart</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Key-Implmentation"><span class="toc-number">8.6.1.2.</span> <span class="toc-text">Key Implmentation</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Conclusion-for-myself-1"><span class="toc-number">8.6.1.3.</span> <span class="toc-text">Conclusion for myself</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Lyra-Camera"><span class="toc-number">9.</span> <span class="toc-text">Lyra Camera</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Lyra-AI-Behavior-Tree"><span class="toc-number">10.</span> <span class="toc-text">Lyra AI Behavior Tree</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Conclusion-for-myself-2"><span class="toc-number">11.</span> <span class="toc-text">Conclusion for myself</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Reference"><span class="toc-number">12.</span> <span class="toc-text">Reference</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Official-Documentation"><span class="toc-number">12.1.</span> <span class="toc-text">Official Documentation</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Third-Party-Articles"><span class="toc-number">12.2.</span> <span class="toc-text">Third-Party Articles</span></a></li></ol></li></ol>
      </div>
      <div class="related panel pjax" data-title="系列文章">
        <ul>
          <li class="active"><a href="/2023/06/20/Lyra/" rel="bookmark" title="Lyra Sample">Lyra Sample</a></li><li><a href="/2023/06/21/UnrealEngineBasis/" rel="bookmark" title="Unreal Engine Basis">Unreal Engine Basis</a></li><li><a href="/2023/08/17/WarFirstPersonNote/" rel="bookmark" title="War First Person Development Note">War First Person Development Note</a></li>
        </ul>
      </div>
      <div class="overview panel" data-title="站点概览">
        <div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <img class="image" itemprop="image" alt="asdlkjqpwoei"
      data-src="/images/avatar.jpg">
  <p class="name" itemprop="name">asdlkjqpwoei</p>
  <div class="description" itemprop="description">游戏开发</div>
</div>

<nav class="state">
    <div class="item posts">
      <a href="/archives/">
        <span class="count">13</span>
        <span class="name">文章</span>
      </a>
    </div>
    <div class="item categories">
      <a href="/categories/">
        <span class="count">8</span>
        <span class="name">分类</span>
      </a>
    </div>
</nav>

<div class="social">
      <span class="exturl item github" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FzZGxranFwd29laQ==" title="https:&#x2F;&#x2F;github.com&#x2F;asdlkjqpwoei"><i class="ic i-github"></i></span>
      <a href="/1125050703@qq.com" title="1125050703@qq.com" class="item email"><i class="ic i-envelope"></i></a>
</div>

<ul class="menu">
  
    
  <li class="item">
    <a href="/" rel="section"><i class="ic i-home"></i>首页</a>
  </li>

    
  <li class="item">
    <a href="/about/" rel="section"><i class="ic i-user"></i>关于</a>
  </li>

        
  <li class="item dropdown">
      <a href="javascript:void(0);"><i class="ic i-feather"></i>文章</a>
    <ul class="submenu">

        
  <li class="item">
    <a href="/archives/" rel="section"><i class="ic i-list-alt"></i>归档</a>
  </li>

        
  <li class="item">
    <a href="/categories/" rel="section"><i class="ic i-th"></i>分类</a>
  </li>

        
  <li class="item">
    <a href="/tags/" rel="section"><i class="ic i-tags"></i>标签</a>
  </li>

  </ul>

</ul>

      </div>
    </div>
  </div>

  <ul id="quick">
    <li class="prev pjax">
    </li>
    <li class="up"><i class="ic i-arrow-up"></i></li>
    <li class="down"><i class="ic i-arrow-down"></i></li>
    <li class="next pjax">
    </li>
    <li class="percent"></li>
  </ul>
</div>


        </div>
        <div class="dimmer"></div>
      </div>
    </main>
    <footer id="footer">
      <div class="inner">
        <div class="widgets">
          
<div class="rpost pjax">
  <h2>随机文章</h2>
  <ul>
      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/Data-Structure-and-Algorithm/" title="分类于 Data Structure and Algorithm">Data Structure and Algorithm</a>
</div>

    <span><a href="/2023/06/21/DataStructrue/" title="Data Structrue">Data Structrue</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/Other/" title="分类于 Other">Other</a>
</div>

    <span><a href="/2023/08/18/Gossip/" title="杂谈&#x2F;碎碎念">杂谈/碎碎念</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/Unreal-Engine/" title="分类于 Unreal Engine">Unreal Engine</a>
</div>

    <span><a href="/2023/06/21/UnrealEngineBasis/" title="Unreal Engine Basis">Unreal Engine Basis</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/Cpp/" title="分类于 Cpp">Cpp</a>
</div>

    <span><a href="/2023/06/21/StandardTemplateLibrary/" title="Standard Template Library">Standard Template Library</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/Cpp/" title="分类于 Cpp">Cpp</a>
</div>

    <span><a href="/2023/06/21/Cpp11/" title="Cpp 11">Cpp 11</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/Computer-Graphics/" title="分类于 Computer Graphics">Computer Graphics</a>
</div>

    <span><a href="/2023/06/28/ComputerGraphics/" title="Computer Graphics Mathematics">Computer Graphics Mathematics</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/Cpp/" title="分类于 Cpp">Cpp</a>
</div>

    <span><a href="/2023/06/21/Cpp17/" title="Cpp 17">Cpp 17</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/Mathematics/" title="分类于 Mathematics">Mathematics</a>
</div>

    <span><a href="/2023/08/18/PrinciplesOfMathematicalAnalysis/" title="Principles of Mathematical Analysis">Principles of Mathematical Analysis</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/Game-Engine/" title="分类于 Game Engine">Game Engine</a>
</div>

    <span><a href="/2023/06/28/GameEngineArchitecture/" title="Game Engine Architecture">Game Engine Architecture</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/Computer-Network/" title="分类于 Computer Network">Computer Network</a>
</div>

    <span><a href="/2023/06/21/ComputerNetwork/" title="Computer Network Basis">Computer Network Basis</a></span>
  </li>

  </ul>
</div>
<div>
  <h2>最新评论</h2>
  <ul class="leancloud-recent-comment"></ul>
</div>

        </div>
        <div class="status">
  <div class="copyright">
    
    &copy; 2010 – 
    <span itemprop="copyrightYear">2023</span>
    <span class="with-love">
      <i class="ic i-sakura rotate"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">asdlkjqpwoei @ Heaven</span>
  </div>
  <div class="powered-by">
    基于 <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span>
  </div>
</div>

      </div>
    </footer>
  </div>
<script data-config type="text/javascript">
  var LOCAL = {
    path: '2023/06/20/Lyra/',
    favicon: {
      show: "（●´3｀●）やれやれだぜ",
      hide: "(´Д｀)大変だ！"
    },
    search : {
      placeholder: "文章搜索",
      empty: "关于 「 ${query} 」，什么也没搜到",
      stats: "${time} ms 内找到 ${hits} 条结果"
    },
    valine: true,fancybox: true,
    copyright: '复制成功，转载请遵守 <i class="ic i-creative-commons"></i>BY-NC-SA 协议。',
    ignores : [
      function(uri) {
        return uri.includes('#');
      },
      function(uri) {
        return new RegExp(LOCAL.path+"$").test(uri);
      }
    ]
  };
</script>

<script src="https://cdn.polyfill.io/v2/polyfill.js"></script>

<script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script>

<script src="/js/app.js?v=0.2.5"></script>




</body>
</html>
