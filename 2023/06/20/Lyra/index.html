<!DOCTYPE html>
<html lang=de>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="Version使用Unreal Engine 5.2的Lyra Game Features模块化玩法功能的框架，使玩法和功能成为一个个名为Game Feature插件，降低Pawn、Character等“热点”类的臃肿，降低维护的难度。 极度依赖Asset Manager。 Key Class UGameFeaturesSubsystemSettings   Settings for the Ga">
<meta property="og:type" content="article">
<meta property="og:title" content="Lyra Sample">
<meta property="og:url" content="https://asdlkjqpwoei.github.io/2023/06/20/Lyra/index.html">
<meta property="og:site_name" content="Jager的工地">
<meta property="og:description" content="Version使用Unreal Engine 5.2的Lyra Game Features模块化玩法功能的框架，使玩法和功能成为一个个名为Game Feature插件，降低Pawn、Character等“热点”类的臃肿，降低维护的难度。 极度依赖Asset Manager。 Key Class UGameFeaturesSubsystemSettings   Settings for the Ga">
<meta property="og:locale">
<meta property="og:image" content="https://asdlkjqpwoei.github.io/2023/06/20/Lyra/Unreal%20Engine%205%20Lyra%20Starter%20Game%20Pawn%20Data%20Flow.png">
<meta property="og:image" content="https://asdlkjqpwoei.github.io/2023/06/20/Lyra/Unreal%20Engine%205%20Lyra%20Starter%20Game%20Class%20Diagram.png">
<meta property="og:image" content="https://asdlkjqpwoei.github.io/2023/06/20/Lyra/Unreal%20Engine%205%20Lyra%20Starter%20Game%20Input.png">
<meta property="og:image" content="https://asdlkjqpwoei.github.io/2023/06/20/Lyra/Unreal%20Engine%205%20Lyra%20Starter%20Game%20Weapon%20Class%20Diagram.png">
<meta property="article:published_time" content="2023-06-20T07:25:08.856Z">
<meta property="article:modified_time" content="2023-06-24T11:17:42.914Z">
<meta property="article:author" content="asdlkjqpwoei">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://asdlkjqpwoei.github.io/2023/06/20/Lyra/Unreal%20Engine%205%20Lyra%20Starter%20Game%20Pawn%20Data%20Flow.png">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>Lyra Sample</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- rss -->
    
    
<meta name="generator" content="Hexo 6.3.0"></head>

<body>
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fa fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fa fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/posts/">Writing</a></li>
         
          <li><a target="_blank" rel="noopener" href="http://github.com/sergodeeva">Projects</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/2023/06/21/Cpp/"><i class="fa fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fa fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://asdlkjqpwoei.github.io/2023/06/20/Lyra/"><i class="fa fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://asdlkjqpwoei.github.io/2023/06/20/Lyra/&text=Lyra Sample"><i class="fa fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://asdlkjqpwoei.github.io/2023/06/20/Lyra/&title=Lyra Sample"><i class="fa fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://asdlkjqpwoei.github.io/2023/06/20/Lyra/&is_video=false&description=Lyra Sample"><i class="fa fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Lyra Sample&body=Check out this article: https://asdlkjqpwoei.github.io/2023/06/20/Lyra/"><i class="fa fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://asdlkjqpwoei.github.io/2023/06/20/Lyra/&title=Lyra Sample"><i class="fa fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://asdlkjqpwoei.github.io/2023/06/20/Lyra/&title=Lyra Sample"><i class="fa fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://asdlkjqpwoei.github.io/2023/06/20/Lyra/&title=Lyra Sample"><i class="fa fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://asdlkjqpwoei.github.io/2023/06/20/Lyra/&title=Lyra Sample"><i class="fa fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://asdlkjqpwoei.github.io/2023/06/20/Lyra/&name=Lyra Sample&description="><i class="fa fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Version"><span class="toc-number">1.</span> <span class="toc-text">Version</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Game-Features"><span class="toc-number">2.</span> <span class="toc-text">Game Features</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Key-Class"><span class="toc-number">2.1.</span> <span class="toc-text">Key Class</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Work-Flow"><span class="toc-number">2.2.</span> <span class="toc-text">Work Flow</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#State-Machine"><span class="toc-number">2.3.</span> <span class="toc-text">State Machine</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Key-Implementation"><span class="toc-number">2.4.</span> <span class="toc-text">Key Implementation</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Game-Abilities-System"><span class="toc-number">3.</span> <span class="toc-text">Game Abilities System</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Enhanced-Input"><span class="toc-number">4.</span> <span class="toc-text">Enhanced Input</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Lyra-Input"><span class="toc-number">5.</span> <span class="toc-text">Lyra Input</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Key-Class-1"><span class="toc-number">5.1.</span> <span class="toc-text">Key Class</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Work-Flow-1"><span class="toc-number">5.2.</span> <span class="toc-text">Work Flow</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#PawnData-Data-Flow"><span class="toc-number">5.2.1.</span> <span class="toc-text">PawnData Data Flow</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Key-Implementation-1"><span class="toc-number">5.2.2.</span> <span class="toc-text">Key Implementation</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Class-Diagram"><span class="toc-number">5.2.3.</span> <span class="toc-text">Class Diagram</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Flow-Diagram"><span class="toc-number">5.2.4.</span> <span class="toc-text">Flow Diagram</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Note"><span class="toc-number">5.3.</span> <span class="toc-text">Note</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Lyra-Animation"><span class="toc-number">6.</span> <span class="toc-text">Lyra Animation</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Required-Plugin"><span class="toc-number">6.1.</span> <span class="toc-text">Required Plugin</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Solution-Design"><span class="toc-number">6.2.</span> <span class="toc-text">Solution Design</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%83%A8%E5%88%86%E9%9C%80%E8%A6%81%E6%B3%A8%E6%84%8F%E6%88%96%E8%80%85%E8%BF%98%E6%9C%AA%E4%BA%86%E8%A7%A3%E6%B8%85%E6%A5%9A%E7%9A%84%E7%BB%86%E8%8A%82"><span class="toc-number">6.3.</span> <span class="toc-text">部分需要注意或者还未了解清楚的细节</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#BlueprintThreadSafeUpdateAnimation"><span class="toc-number">6.3.1.</span> <span class="toc-text">BlueprintThreadSafeUpdateAnimation</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SelectCardinalDirectionFromAngle"><span class="toc-number">6.3.2.</span> <span class="toc-text">SelectCardinalDirectionFromAngle</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Root-Motion"><span class="toc-number">6.3.3.</span> <span class="toc-text">Root Motion</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Stride-Warping-%E6%AD%A5%E5%B9%85%E6%89%AD%E6%9B%B2"><span class="toc-number">6.3.4.</span> <span class="toc-text">Stride Warping (步幅扭曲)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Orientation-Warping-%E6%96%B9%E5%90%91%E6%89%AD%E6%9B%B2"><span class="toc-number">6.3.5.</span> <span class="toc-text">Orientation Warping (方向扭曲)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Distance-Match-%E8%B7%9D%E7%A6%BB%E5%8C%B9%E9%85%8D"><span class="toc-number">6.3.6.</span> <span class="toc-text">Distance Match (距离匹配)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Pivot"><span class="toc-number">6.3.7.</span> <span class="toc-text">Pivot</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Aim-Offset-%E7%9E%84%E5%87%86%E5%81%8F%E7%A7%BB"><span class="toc-number">6.3.8.</span> <span class="toc-text">Aim Offset (瞄准偏移)</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Lyra-Inventory-and-Lyra-Equipment"><span class="toc-number">7.</span> <span class="toc-text">Lyra Inventory and Lyra Equipment</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Class-Diagram-1"><span class="toc-number">7.1.</span> <span class="toc-text">Class Diagram</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Key-Class-2"><span class="toc-number">7.2.</span> <span class="toc-text">Key Class</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Lyra-Abilities"><span class="toc-number">8.</span> <span class="toc-text">Lyra Abilities</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Key-Class-3"><span class="toc-number">8.1.</span> <span class="toc-text">Key Class</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Work-Flow-2"><span class="toc-number">8.2.</span> <span class="toc-text">Work Flow</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Implementation"><span class="toc-number">8.3.</span> <span class="toc-text">Implementation</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Class-Diagram-2"><span class="toc-number">8.4.</span> <span class="toc-text">Class Diagram</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Lyra-AI-Behavior-Tree"><span class="toc-number">9.</span> <span class="toc-text">Lyra AI Behavior Tree</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Conclusion"><span class="toc-number">10.</span> <span class="toc-text">Conclusion</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Reference"><span class="toc-number">11.</span> <span class="toc-text">Reference</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Official-Documentation"><span class="toc-number">11.1.</span> <span class="toc-text">Official Documentation</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Third-Party-Articles"><span class="toc-number">11.2.</span> <span class="toc-text">Third-Party Articles</span></a></li></ol></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index width mx-auto px2 my4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        Lyra Sample
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Jager的工地</span>
      </span>
      
    <div class="postdate">
        <time datetime="2023-06-20T07:25:08.856Z" itemprop="datePublished">2023-06-20</time>
    </div>


      

    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h1 id="Version"><a href="#Version" class="headerlink" title="Version"></a>Version</h1><p>使用Unreal Engine 5.2的Lyra</p>
<h1 id="Game-Features"><a href="#Game-Features" class="headerlink" title="Game Features"></a>Game Features</h1><p>模块化玩法功能的框架，使玩法和功能成为一个个名为Game Feature插件，降低Pawn、Character等“热点”类的臃肿，降低维护的难度。</p>
<p>极度依赖Asset Manager。</p>
<h2 id="Key-Class"><a href="#Key-Class" class="headerlink" title="Key Class"></a>Key Class</h2><ul>
<li>UGameFeaturesSubsystemSettings</li>
</ul>
<blockquote>
<p>Settings for the Game Features framework.</p>
</blockquote>
<p>继承UDeveloperSettings，Game Features框架的设置，可以在编辑器中或者配置文件中进行修改和配置。</p>
<ul>
<li>UGameFeaturesSubsystem</li>
</ul>
<blockquote>
<p>The manager subsystem for game features.</p>
</blockquote>
<p>继承UEngineSubsystem，负责初始化、加载或者卸载Game Feature的框架管理类。</p>
<ul>
<li>UGameFeatureData</li>
</ul>
<blockquote>
<p>Data related to a game feature, a collection of code and content that adds a separable discrete feature to the game.</p>
</blockquote>
<p>继承UPrimaryDataAsset，Game Feature数据，代码和内容的集合，可独立添加到游戏中的功能数据组件。</p>
<ul>
<li>UGameFeatureStateMachine</li>
</ul>
<blockquote>
<p>A state machine to manage transitioning a game feature plugin from just a URL into a fully loaded and active plugin, including registering its contents with other game systems.</p>
</blockquote>
<p>继承UObject，管理Game Feature从仅有URL已知到完全加载和激活的过程，包括将它的内容注册进其他的游戏系统。</p>
<ul>
<li>UGameFeatureAction</li>
</ul>
<blockquote>
<p>Represents an action to be taken when a game feature is activated.</p>
</blockquote>
<p>继承UObject，代表一个Game Feature被激活时要执行的动作。</p>
<ul>
<li>UGameFeatureAction_WorldActionBase</li>
</ul>
<blockquote>
<p>Base class for GameFeatureActions that wish to do something world specific.</p>
</blockquote>
<p>继承UGameFeatureAction，Lyra中的GameFeatureAcitons基类，在Game Feature流程中触发的激活回调都会调用此类定义的回调函数。</p>
<h2 id="Work-Flow"><a href="#Work-Flow" class="headerlink" title="Work Flow"></a>Work Flow</h2><p>{$ asset_img $}</p>
<h2 id="State-Machine"><a href="#State-Machine" class="headerlink" title="State Machine"></a>State Machine</h2><p>在<em>Engine\Plugins\Experimental\GameFeatures\Source\GameFeatures\Public\GameFeatureTypes.h</em>文件中查看所有状态的描述和定义。</p>
<p>在<em>Engine\Plugins\Experimental\GameFeatures\Source\GameFeatures\Private\GameFeaturePluginStateMachine.cpp</em>中有所有状态执行的动作逻辑（每个结构体都几乎会有个覆写的UpdateState函数）</p>
<ol>
<li>Uninitialized: 初始状态，未设置、还未被设置、未初始化。</li>
<li>UnknownStatus: 初始化后的状态，仅仅获取到该Game Feature的URL，其他信息均未知。（Game Feature信息有名称、是否确认启用、URL等，主要信息就是该Game Feature的URL。因为不知道URL到底是一个链接还是路径，所以未知）</li>
<li>CheckingStatus: 检查中的状态，一种从UnknownStatus到StatusKnown的过渡状态。</li>
<li>StatusKnown: 已经获取足够的Plugins信息后的状态，依据该信息进入Downloading或者Installed状态。(已经清楚该Game Feature的URL是链接或路径)</li>
<li>Downloading: 如果Game Feature的URL是一个链接，就会进入该状态尝试下载。</li>
<li>Installed: 处于该状态时，该Game Feature已经存在于硬盘。</li>
<li>Mounting: 一种从Installed到Regsitered的过渡状态之一，会把该Game Feature反序列化并进行预加载。（好像也是加载该Game Feature C++模块的状态）</li>
<li>WaitingForDependencies: 一种从Installed到Regsitered的过渡状态之一，如果该Game Feature有其他的依赖，并且未被加载，就会进入该状态。</li>
<li>Registering: 一种从Installed到Regsitered的过渡状态之一，读取设置并注册该Game Feature所有的UE资产。</li>
<li>Regsitered: 该Game Feature设置和资产已经被注册后所处的状态，可进入Loading状态。</li>
<li>Loading: 该状态就代表正式加载Game Feature的资产进入内存。</li>
<li>Loaded: Game Feature的所有相关数据和资产已经全部加载进入内存中，但没有与游戏系统一起注册，就会进入此状态，等待被激活。</li>
<li>Activating: 与游戏系统一起注册，正式进入激活。</li>
<li>Active: 全面激活，已经在游戏中产生影响和效果。</li>
</ol>
<h2 id="Key-Implementation"><a href="#Key-Implementation" class="headerlink" title="Key Implementation"></a>Key Implementation</h2><ul>
<li>Engine\Plugins\Experimental\GameFeatures\Source\GameFeatures\Private\GameFeaturesSubsystem.cpp</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">UGameFeaturesSubsystem::LoadBuiltInGameFeaturePlugin</span><span class="params">(<span class="type">const</span> TSharedRef&lt;IPlugin&gt;&amp; Plugin, FBuiltInPluginAdditionalFilters AdditionalFilter)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">UE_SCOPED_ENGINE_ACTIVITY</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;Loading GameFeaturePlugin %s&quot;</span>), *Plugin-&gt;<span class="built_in">GetName</span>());</span><br><span class="line"></span><br><span class="line">	UAssetManager::<span class="built_in">Get</span>().<span class="built_in">PushBulkScanning</span>();</span><br><span class="line"></span><br><span class="line">	<span class="type">const</span> FString&amp; PluginDescriptorFilename = Plugin-&gt;<span class="built_in">GetDescriptorFileName</span>();</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Make sure you are in a game feature plugins folder. All GameFeaturePlugins are rooted in a GameFeatures folder.</span></span><br><span class="line">	<span class="keyword">if</span> (!PluginDescriptorFilename.<span class="built_in">IsEmpty</span>() &amp;&amp; <span class="built_in">GetDefault</span>&lt;UGameFeaturesSubsystemSettings&gt;()-&gt;<span class="built_in">IsValidGameFeaturePlugin</span>(FPaths::<span class="built_in">ConvertRelativePathToFull</span>(PluginDescriptorFilename)) &amp;&amp; FPaths::<span class="built_in">FileExists</span>(PluginDescriptorFilename))</span><br><span class="line">	&#123;</span><br><span class="line">		FString PluginURL;</span><br><span class="line">		<span class="type">bool</span> bIsFileProtocol = <span class="literal">true</span>;</span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">GetPluginURLByName</span>(Plugin-&gt;<span class="built_in">GetName</span>(), PluginURL))</span><br><span class="line">		&#123;</span><br><span class="line">			bIsFileProtocol = UGameFeaturesSubsystem::<span class="built_in">IsPluginURLProtocol</span>(PluginURL, EGameFeaturePluginProtocol::File);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			PluginURL = <span class="built_in">GetPluginURL_FileProtocol</span>(PluginDescriptorFilename);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 检查该Game Feature是否存在及可否经过Game Feature加载策略的筛选</span></span><br><span class="line">		<span class="keyword">if</span> (bIsFileProtocol &amp;&amp; GameSpecificPolicies-&gt;<span class="built_in">IsPluginAllowed</span>(PluginURL))</span><br><span class="line">		&#123;</span><br><span class="line">			FGameFeaturePluginDetails PluginDetails;</span><br><span class="line">			<span class="keyword">if</span> (<span class="built_in">GetGameFeaturePluginDetails</span>(PluginDescriptorFilename, PluginDetails))</span><br><span class="line">			&#123;</span><br><span class="line">				FBuiltInGameFeaturePluginBehaviorOptions BehaviorOptions;</span><br><span class="line">				<span class="type">bool</span> bShouldProcess = <span class="built_in">AdditionalFilter</span>(PluginDescriptorFilename, PluginDetails, BehaviorOptions);</span><br><span class="line">				<span class="comment">// 给Game Feature建立状态机</span></span><br><span class="line">				<span class="keyword">if</span> (bShouldProcess)</span><br><span class="line">				&#123;</span><br><span class="line">					UGameFeaturePluginStateMachine* StateMachine = <span class="built_in">FindOrCreateGameFeaturePluginStateMachine</span>(PluginURL);</span><br><span class="line"></span><br><span class="line">					<span class="type">const</span> EBuiltInAutoState InitialAutoState = (BehaviorOptions.AutoStateOverride != EBuiltInAutoState::Invalid) ? BehaviorOptions.AutoStateOverride : PluginDetails.BuiltInAutoState;</span><br><span class="line">						</span><br><span class="line">					<span class="type">const</span> EGameFeaturePluginState DestinationState = <span class="built_in">ConvertInitialFeatureStateToTargetState</span>(InitialAutoState);</span><br><span class="line"></span><br><span class="line">					<span class="comment">// If we&#x27;re already at the destination or beyond, don&#x27;t transition back</span></span><br><span class="line">					<span class="function">FGameFeaturePluginStateRange <span class="title">Destination</span><span class="params">(DestinationState, EGameFeaturePluginState::Active)</span></span>;</span><br><span class="line">					<span class="comment">// 加载Game Feature插件，初始化状态机。</span></span><br><span class="line">					<span class="built_in">ChangeGameFeatureDestination</span>(StateMachine, Destination, </span><br><span class="line">						FGameFeaturePluginChangeStateComplete::<span class="built_in">CreateUObject</span>(<span class="keyword">this</span>, &amp;ThisClass::LoadBuiltInGameFeaturePluginComplete, StateMachine, Destination));</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	UAssetManager::<span class="built_in">Get</span>().<span class="built_in">PopBulkScanning</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">UGameFeaturesSubsystem::ChangeGameFeatureDestination</span><span class="params">(UGameFeaturePluginStateMachine* Machine, <span class="type">const</span> FGameFeaturePluginStateRange&amp; StateRange, FGameFeaturePluginChangeStateComplete CompleteDelegate)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	Machine-&gt;<span class="built_in">SetDestination</span>(StateRange, FGameFeatureStateTransitionComplete::<span class="built_in">CreateUObject</span>(<span class="keyword">this</span>, &amp;ThisClass::ChangeGameFeatureTargetStateComplete, CompleteDelegate));</span><br><span class="line">	<span class="comment">// ......</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 当Game Feature达到Registering状态时，Game Feature Action的Registering回调会被调用。</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">UGameFeaturesSubsystem::OnGameFeatureRegistering</span><span class="params">(<span class="type">const</span> UGameFeatureData* GameFeatureData, <span class="type">const</span> FString&amp; PluginName, <span class="type">const</span> FString&amp; PluginURL)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">CallbackObservers</span>(EObserverCallback::Registering, PluginURL, &amp;PluginName, GameFeatureData);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (UGameFeatureAction* Action : GameFeatureData-&gt;<span class="built_in">GetActions</span>())</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (Action != <span class="literal">nullptr</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			Action-&gt;<span class="built_in">OnGameFeatureRegistering</span>();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 当Game Feature达到Activating状态时，Game Feature Action的Activating回调会被调用。</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">UGameFeaturesSubsystem::OnGameFeatureActivating</span><span class="params">(<span class="type">const</span> UGameFeatureData* GameFeatureData, <span class="type">const</span> FString&amp; PluginName, FGameFeatureActivatingContext&amp; Context, <span class="type">const</span> FString&amp; PluginURL)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">CallbackObservers</span>(EObserverCallback::Activating, PluginURL, &amp;PluginName, GameFeatureData);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (UGameFeatureAction* Action : GameFeatureData-&gt;<span class="built_in">GetActions</span>())</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (Action != <span class="literal">nullptr</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			Action-&gt;<span class="built_in">OnGameFeatureActivating</span>(Context);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>Engine\Plugins\Experimental\GameFeatures\Private\GameFeaturePluginStateMachine.cpp</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">UGameFeaturePluginStateMachine::SetDestination</span><span class="params">(FGameFeaturePluginStateRange InDestination, FGameFeatureStateTransitionComplete OnFeatureStateTransitionComplete, FDelegateHandle* OutCallbackHandle <span class="comment">/*= nullptr*/</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">check</span>(<span class="built_in">IsValidDestinationState</span>(InDestination.MinState));</span><br><span class="line">	<span class="built_in">check</span>(<span class="built_in">IsValidDestinationState</span>(InDestination.MaxState));</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!InDestination.<span class="built_in">IsValid</span>())</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// Invalid range</span></span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (CurrentStateInfo.State == EGameFeaturePluginState::Terminal &amp;&amp; !InDestination.<span class="built_in">Contains</span>(EGameFeaturePluginState::Terminal))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// Can&#x27;t tranistion away from terminal state</span></span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!<span class="built_in">IsRunning</span>())</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// Not running so any new range is acceptable</span></span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (OutCallbackHandle)</span><br><span class="line">		&#123;</span><br><span class="line">			OutCallbackHandle-&gt;<span class="built_in">Reset</span>();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		FDestinationGameFeaturePluginState* CurrState = AllStates[CurrentStateInfo.State]-&gt;<span class="built_in">AsDestinationState</span>();</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (InDestination.<span class="built_in">Contains</span>(CurrentStateInfo.State))</span><br><span class="line">		&#123;</span><br><span class="line">			OnFeatureStateTransitionComplete.<span class="built_in">ExecuteIfBound</span>(<span class="keyword">this</span>, <span class="built_in">MakeValue</span>());</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">if</span> (CurrentStateInfo.State &lt; InDestination)</span><br><span class="line">		&#123;</span><br><span class="line">			FDestinationGameFeaturePluginState* MinDestState = AllStates[InDestination.MinState]-&gt;<span class="built_in">AsDestinationState</span>();</span><br><span class="line">			FDelegateHandle CallbackHandle = MinDestState-&gt;OnDestinationStateReached.<span class="built_in">Add</span>(<span class="built_in">MoveTemp</span>(OnFeatureStateTransitionComplete));</span><br><span class="line">			<span class="keyword">if</span> (OutCallbackHandle)</span><br><span class="line">			&#123;</span><br><span class="line">				*OutCallbackHandle = CallbackHandle;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (CurrentStateInfo.State &gt; InDestination)</span><br><span class="line">		&#123;</span><br><span class="line">			FDestinationGameFeaturePluginState* MaxDestState = AllStates[InDestination.MaxState]-&gt;<span class="built_in">AsDestinationState</span>();</span><br><span class="line">			FDelegateHandle CallbackHandle = MaxDestState-&gt;OnDestinationStateReached.<span class="built_in">Add</span>(<span class="built_in">MoveTemp</span>(OnFeatureStateTransitionComplete));</span><br><span class="line">			<span class="keyword">if</span> (OutCallbackHandle)</span><br><span class="line">			&#123;</span><br><span class="line">				*OutCallbackHandle = CallbackHandle;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		StateProperties.Destination = InDestination;</span><br><span class="line">		<span class="built_in">UpdateStateMachine</span>();</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (TOptional&lt;FGameFeaturePluginStateRange&gt; NewDestination = StateProperties.Destination.<span class="built_in">Intersect</span>(InDestination))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// The machine is already running so we can only transition to this range if it overlaps with our current range.</span></span><br><span class="line">		<span class="comment">// We can satisfy both ranges in this case.</span></span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (OutCallbackHandle)</span><br><span class="line">		&#123;</span><br><span class="line">			OutCallbackHandle-&gt;<span class="built_in">Reset</span>();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (CurrentStateInfo.State &lt; StateProperties.Destination)</span><br><span class="line">		&#123;</span><br><span class="line">			StateProperties.Destination = *NewDestination;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (InDestination.<span class="built_in">Contains</span>(CurrentStateInfo.State))</span><br><span class="line">			&#123;</span><br><span class="line">				OnFeatureStateTransitionComplete.<span class="built_in">ExecuteIfBound</span>(<span class="keyword">this</span>, <span class="built_in">MakeValue</span>());</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			FDestinationGameFeaturePluginState* MinDestState = AllStates[InDestination.MinState]-&gt;<span class="built_in">AsDestinationState</span>();</span><br><span class="line">			FDelegateHandle CallbackHandle = MinDestState-&gt;OnDestinationStateReached.<span class="built_in">Add</span>(<span class="built_in">MoveTemp</span>(OnFeatureStateTransitionComplete));</span><br><span class="line">			<span class="keyword">if</span> (OutCallbackHandle)</span><br><span class="line">			&#123;</span><br><span class="line">				*OutCallbackHandle = CallbackHandle;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span>(CurrentStateInfo.State &gt; StateProperties.Destination)</span><br><span class="line">		&#123;</span><br><span class="line">			StateProperties.Destination = *NewDestination;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (InDestination.<span class="built_in">Contains</span>(CurrentStateInfo.State))</span><br><span class="line">			&#123;</span><br><span class="line">				OnFeatureStateTransitionComplete.<span class="built_in">ExecuteIfBound</span>(<span class="keyword">this</span>, <span class="built_in">MakeValue</span>());</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			FDestinationGameFeaturePluginState* MaxDestState = AllStates[InDestination.MaxState]-&gt;<span class="built_in">AsDestinationState</span>();</span><br><span class="line">			FDelegateHandle CallbackHandle = MaxDestState-&gt;OnDestinationStateReached.<span class="built_in">Add</span>(<span class="built_in">MoveTemp</span>(OnFeatureStateTransitionComplete));</span><br><span class="line">			<span class="keyword">if</span> (OutCallbackHandle)</span><br><span class="line">			&#123;</span><br><span class="line">				*OutCallbackHandle = CallbackHandle;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">checkf</span>(<span class="literal">false</span>, <span class="built_in">TEXT</span>(<span class="string">&quot;IsRunning() returned true but state machine has reached destination!&quot;</span>));</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// The requested state range is completely outside the the current state range so reject the request</span></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">UGameFeaturePluginStateMachine::UpdateStateMachine</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	EGameFeaturePluginState CurrentState = <span class="built_in">GetCurrentState</span>();</span><br><span class="line">	<span class="keyword">if</span> (bInUpdateStateMachine)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">UE_LOG</span>(LogGameFeatures, Verbose, <span class="built_in">TEXT</span>(<span class="string">&quot;Game feature state machine skipping update for %s in ::UpdateStateMachine. Current State: %s&quot;</span>), *<span class="built_in">GetGameFeatureName</span>(), *UE::GameFeatures::<span class="built_in">ToString</span>(CurrentState));</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	TOptional&lt;TGuardValue&lt;<span class="type">bool</span>&gt;&gt; <span class="built_in">ScopeGuard</span>(InPlace, bInUpdateStateMachine, <span class="literal">true</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">using</span> StateIt = std::underlying_type&lt;EGameFeaturePluginState&gt;::type;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">auto</span> DoCallbacks = [<span class="keyword">this</span>](<span class="type">const</span> UE::GameFeatures::FResult&amp; Result, StateIt Begin, StateIt End)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">for</span> (StateIt iState = Begin; iState &lt; End; ++iState)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span> (FDestinationGameFeaturePluginState* DestState = AllStates[iState]-&gt;<span class="built_in">AsDestinationState</span>())</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="comment">// Use a local callback on the stack. If SetDestination() is called from the callback then we don&#x27;t want to stomp the callback</span></span><br><span class="line">				<span class="comment">// for the new state transition request.</span></span><br><span class="line">				<span class="comment">// Callback from terminal state could also trigger a GC that would destroy the state machine</span></span><br><span class="line">				FDestinationGameFeaturePluginState::FOnDestinationStateReached <span class="built_in">LocalOnDestinationStateReached</span>(<span class="built_in">MoveTemp</span>(DestState-&gt;OnDestinationStateReached));</span><br><span class="line">				DestState-&gt;OnDestinationStateReached.<span class="built_in">Clear</span>();</span><br><span class="line"></span><br><span class="line">				LocalOnDestinationStateReached.<span class="built_in">Broadcast</span>(<span class="keyword">this</span>, Result);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">auto</span> DoCallback = [&amp;DoCallbacks](<span class="type">const</span> UE::GameFeatures::FResult&amp; Result, StateIt InState)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">DoCallbacks</span>(Result, InState, InState + <span class="number">1</span>);</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="type">bool</span> bKeepProcessing = <span class="literal">false</span>;</span><br><span class="line">	int32 NumTransitions = <span class="number">0</span>;</span><br><span class="line">	<span class="type">const</span> int32 MaxTransitions = <span class="number">10000</span>;</span><br><span class="line">	<span class="keyword">do</span></span><br><span class="line">	&#123;</span><br><span class="line">		bKeepProcessing = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">		FGameFeaturePluginStateStatus StateStatus;</span><br><span class="line">		<span class="comment">// 达到注册状态才会开始加载Game Feature Data资产。</span></span><br><span class="line">		AllStates[CurrentState]-&gt;<span class="built_in">UpdateState</span>(StateStatus);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (StateStatus.TransitionToState == CurrentState)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">UE_LOG</span>(LogGameFeatures, Fatal, <span class="built_in">TEXT</span>(<span class="string">&quot;Game feature state %s transitioning to itself. GameFeature: %s&quot;</span>), *UE::GameFeatures::<span class="built_in">ToString</span>(CurrentState), *<span class="built_in">GetGameFeatureName</span>());</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (StateStatus.TransitionToState != EGameFeaturePluginState::Uninitialized)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">UE_LOG</span>(LogGameFeatures, Verbose, <span class="built_in">TEXT</span>(<span class="string">&quot;Game feature &#x27;%s&#x27; transitioning state (%s -&gt; %s)&quot;</span>), *<span class="built_in">GetGameFeatureName</span>(), *UE::GameFeatures::<span class="built_in">ToString</span>(CurrentState), *UE::GameFeatures::<span class="built_in">ToString</span>(StateStatus.TransitionToState));</span><br><span class="line">			AllStates[CurrentState]-&gt;<span class="built_in">EndState</span>();</span><br><span class="line">			CurrentStateInfo = <span class="built_in">FGameFeaturePluginStateInfo</span>(StateStatus.TransitionToState);</span><br><span class="line">			CurrentState = StateStatus.TransitionToState;</span><br><span class="line">			<span class="built_in">check</span>(CurrentState != EGameFeaturePluginState::MAX);</span><br><span class="line">			AllStates[CurrentState]-&gt;<span class="built_in">BeginState</span>();</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (CurrentState == EGameFeaturePluginState::Terminal)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="comment">// Remove from gamefeature subsystem before calling back in case this GFP is reloaded on callback,</span></span><br><span class="line">				<span class="comment">// but make sure we don&#x27;t get destroyed from a GC during a callback</span></span><br><span class="line">				UGameFeaturesSubsystem::<span class="built_in">Get</span>().<span class="built_in">BeginTermination</span>(<span class="keyword">this</span>);</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (StateProperties.bTryCancel &amp;&amp; AllStates[CurrentState]-&gt;<span class="built_in">GetStateType</span>() != EGameFeaturePluginStateType::Transition)</span><br><span class="line">			&#123;</span><br><span class="line">				StateProperties.Destination = <span class="built_in">FGameFeaturePluginStateRange</span>(CurrentState);</span><br><span class="line"></span><br><span class="line">				StateProperties.bTryCancel = <span class="literal">false</span>;</span><br><span class="line">				bKeepProcessing = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">				<span class="comment">// Make sure bInUpdateStateMachine is not set while processing callbacks if we are at our destination</span></span><br><span class="line">				ScopeGuard.<span class="built_in">Reset</span>();</span><br><span class="line"></span><br><span class="line">				<span class="comment">// For all callbacks, return the CanceledResult</span></span><br><span class="line">				<span class="built_in">DoCallbacks</span>(UE::GameFeatures::CanceledResult, <span class="number">0</span>, EGameFeaturePluginState::MAX);</span><br><span class="line"></span><br><span class="line">				<span class="comment">// Must be called after transtition callbacks, UGameFeaturesSubsystem::ChangeGameFeatureTargetStateComplete may remove the this machine from the subsystem</span></span><br><span class="line">				<span class="function">FGameFeaturePluginStateMachineProperties::FOnTransitionCanceled <span class="title">LocalOnTransitionCanceled</span><span class="params">(MoveTemp(StateProperties.OnTransitionCanceled))</span></span>;</span><br><span class="line">				StateProperties.OnTransitionCanceled.<span class="built_in">Clear</span>();</span><br><span class="line">				LocalOnTransitionCanceled.<span class="built_in">Broadcast</span>(<span class="keyword">this</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (<span class="type">const</span> <span class="type">bool</span> bError = !StateStatus.TransitionResult.<span class="built_in">HasValue</span>(); bError)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="built_in">check</span>(<span class="built_in">IsValidErrorState</span>(CurrentState));</span><br><span class="line">				StateProperties.Destination = <span class="built_in">FGameFeaturePluginStateRange</span>(CurrentState);</span><br><span class="line"></span><br><span class="line">				bKeepProcessing = <span class="literal">false</span>;</span><br><span class="line">				</span><br><span class="line">				<span class="comment">// Make sure bInUpdateStateMachine is not set while processing callbacks if we are at our destination</span></span><br><span class="line">				ScopeGuard.<span class="built_in">Reset</span>();</span><br><span class="line"></span><br><span class="line">				<span class="comment">// In case of an error, callback all possible callbacks</span></span><br><span class="line">				<span class="built_in">DoCallbacks</span>(StateStatus.TransitionResult, <span class="number">0</span>, EGameFeaturePluginState::MAX);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">			&#123;</span><br><span class="line">				bKeepProcessing = AllStates[CurrentState]-&gt;<span class="built_in">GetStateType</span>() == EGameFeaturePluginStateType::Transition || !StateProperties.Destination.<span class="built_in">Contains</span>(CurrentState);</span><br><span class="line">				<span class="keyword">if</span> (!bKeepProcessing)</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="comment">// Make sure bInUpdateStateMachine is not set while processing callbacks if we are at our destination</span></span><br><span class="line">					ScopeGuard.<span class="built_in">Reset</span>();</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				<span class="built_in">DoCallback</span>(StateStatus.TransitionResult, CurrentState);</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (CurrentState == EGameFeaturePluginState::Terminal)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="built_in">check</span>(bKeepProcessing == <span class="literal">false</span>);</span><br><span class="line">				<span class="comment">// Now that callbacks are done this machine can be cleaned up</span></span><br><span class="line">				UGameFeaturesSubsystem::<span class="built_in">Get</span>().<span class="built_in">FinishTermination</span>(<span class="keyword">this</span>);</span><br><span class="line">				<span class="built_in">MarkAsGarbage</span>();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (NumTransitions++ &gt; MaxTransitions)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">UE_LOG</span>(LogGameFeatures, Fatal, <span class="built_in">TEXT</span>(<span class="string">&quot;Infinite loop in game feature state machine transitions. Current state %s. GameFeature: %s&quot;</span>), *UE::GameFeatures::<span class="built_in">ToString</span>(CurrentState), *<span class="built_in">GetGameFeatureName</span>());</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; <span class="keyword">while</span> (bKeepProcessing);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>Engine\Plugins\Experimental\GameFeatures\Source\GameFeatures\Private\GameFeaturePluginStateMachine.cpp</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">FGameFeaturePluginState_Registering</span> : <span class="keyword">public</span> FGameFeaturePluginState</span><br><span class="line">&#123;</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">UpdateState</span><span class="params">(FGameFeaturePluginStateStatus&amp; StateStatus)</span> <span class="keyword">override</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="built_in">TRACE_CPUPROFILER_EVENT_SCOPE</span>(GFP_Registering);</span><br><span class="line">		<span class="type">const</span> FString PluginFolder = FPaths::<span class="built_in">GetPath</span>(StateProperties.PluginInstalledFilename);</span><br><span class="line">		UGameplayTagsManager::<span class="built_in">Get</span>().<span class="built_in">AddTagIniSearchPath</span>(PluginFolder / <span class="built_in">TEXT</span>(<span class="string">&quot;Config&quot;</span>) / <span class="built_in">TEXT</span>(<span class="string">&quot;Tags&quot;</span>));</span><br><span class="line"></span><br><span class="line">		<span class="type">const</span> FString BackupGameFeatureDataPath = FString::<span class="built_in">Printf</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;/%s/%s.%s&quot;</span>), *StateProperties.PluginName, *StateProperties.PluginName, *StateProperties.PluginName);</span><br><span class="line"></span><br><span class="line">		FString PreferredGameFeatureDataPath = <span class="built_in">TEXT</span>(<span class="string">&quot;/&quot;</span>) + StateProperties.PluginName + <span class="built_in">TEXT</span>(<span class="string">&quot;/GameFeatureData.GameFeatureData&quot;</span>);</span><br><span class="line">		<span class="comment">// Allow game feature location to be overriden globally and from within the plugin</span></span><br><span class="line">		FString OverrideIniPathName = StateProperties.PluginName + <span class="built_in">TEXT</span>(<span class="string">&quot;_Override&quot;</span>);</span><br><span class="line">		FString OverridePath = GConfig-&gt;<span class="built_in">GetStr</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;GameFeatureData&quot;</span>), *OverrideIniPathName, GGameIni);</span><br><span class="line">		<span class="keyword">if</span> (OverridePath.<span class="built_in">IsEmpty</span>())</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="type">const</span> FString SettingsOverride = PluginFolder / <span class="built_in">TEXT</span>(<span class="string">&quot;Config&quot;</span>) / <span class="built_in">TEXT</span>(<span class="string">&quot;Settings.ini&quot;</span>);</span><br><span class="line">			<span class="keyword">if</span> (FPaths::<span class="built_in">FileExists</span>(SettingsOverride))</span><br><span class="line">			&#123;</span><br><span class="line">				GConfig-&gt;<span class="built_in">LoadFile</span>(SettingsOverride);</span><br><span class="line">				OverridePath = GConfig-&gt;<span class="built_in">GetStr</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;GameFeatureData&quot;</span>), <span class="built_in">TEXT</span>(<span class="string">&quot;Override&quot;</span>), SettingsOverride);</span><br><span class="line">				GConfig-&gt;<span class="built_in">UnloadFile</span>(SettingsOverride);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (!OverridePath.<span class="built_in">IsEmpty</span>())</span><br><span class="line">		&#123;</span><br><span class="line">			PreferredGameFeatureDataPath = OverridePath;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">auto</span> LoadGameFeatureData = [](<span class="type">const</span> FString&amp; Path) -&gt; UGameFeatureData*</span><br><span class="line">		&#123;</span><br><span class="line">			TSharedPtr&lt;FStreamableHandle&gt; GameFeatureDataHandle;</span><br><span class="line">			<span class="keyword">if</span> (FPackageName::<span class="built_in">DoesPackageExist</span>(Path))</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="comment">//开始加载Game Feature Data资产。</span></span><br><span class="line">				GameFeatureDataHandle = UGameFeaturesSubsystem::<span class="built_in">LoadGameFeatureData</span>(Path);</span><br><span class="line">				<span class="comment">// @todo make this async. For now we just wait</span></span><br><span class="line">				<span class="keyword">if</span> (GameFeatureDataHandle.<span class="built_in">IsValid</span>())</span><br><span class="line">				&#123;</span><br><span class="line">					GameFeatureDataHandle-&gt;<span class="built_in">WaitUntilComplete</span>(<span class="number">0.0f</span>, <span class="literal">false</span>);</span><br><span class="line">					<span class="keyword">return</span> <span class="built_in">Cast</span>&lt;UGameFeatureData&gt;(GameFeatureDataHandle-&gt;<span class="built_in">GetLoadedAsset</span>());</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">		&#125;;</span><br><span class="line"></span><br><span class="line">		StateProperties.GameFeatureData = <span class="built_in">LoadGameFeatureData</span>(PreferredGameFeatureDataPath);</span><br><span class="line">		<span class="keyword">if</span> (!StateProperties.GameFeatureData)</span><br><span class="line">		&#123;</span><br><span class="line">			StateProperties.GameFeatureData = <span class="built_in">LoadGameFeatureData</span>(BackupGameFeatureDataPath);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (StateProperties.GameFeatureData)</span><br><span class="line">		&#123;</span><br><span class="line">			StateProperties.GameFeatureData-&gt;<span class="built_in">InitializeBasePluginIniFile</span>(StateProperties.PluginInstalledFilename);</span><br><span class="line">			StateStatus.<span class="built_in">SetTransition</span>(EGameFeaturePluginState::Registered);</span><br><span class="line"></span><br><span class="line">			<span class="built_in">check</span>(StateProperties.AddedPrimaryAssetTypes.<span class="built_in">Num</span>() == <span class="number">0</span>);</span><br><span class="line">			UGameFeaturesSubsystem::<span class="built_in">Get</span>().<span class="built_in">AddGameFeatureToAssetManager</span>(StateProperties.GameFeatureData, StateProperties.PluginName, StateProperties.AddedPrimaryAssetTypes);</span><br><span class="line">			<span class="comment">// 触发Game Feature Registering回调委托</span></span><br><span class="line">			UGameFeaturesSubsystem::<span class="built_in">Get</span>().<span class="built_in">OnGameFeatureRegistering</span>(StateProperties.GameFeatureData, StateProperties.PluginName, StateProperties.PluginIdentifier.<span class="built_in">GetFullPluginURL</span>());</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">// The gamefeaturedata does not exist. The pak file may not be openable or this is a builtin plugin where the pak file does not exist.</span></span><br><span class="line">			StateStatus.<span class="built_in">SetTransitionError</span>(EGameFeaturePluginState::ErrorRegistering, <span class="built_in">GetErrorResult</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;Plugin_Missing_GameFeatureData&quot;</span>)));</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h1 id="Game-Abilities-System"><a href="#Game-Abilities-System" class="headerlink" title="Game Abilities System"></a>Game Abilities System</h1><h1 id="Enhanced-Input"><a href="#Enhanced-Input" class="headerlink" title="Enhanced Input"></a>Enhanced Input</h1><h1 id="Lyra-Input"><a href="#Lyra-Input" class="headerlink" title="Lyra Input"></a>Lyra Input</h1><p>Lyra的输入处理是基于Enhanced Input的</p>
<h2 id="Key-Class-1"><a href="#Key-Class-1" class="headerlink" title="Key Class"></a>Key Class</h2><ul>
<li>UGameFeatureAction_AddInputConfig</li>
</ul>
<blockquote>
<p>Registers a Player Mappable Input config to the Game User Settings<br>Expects that local players are set up to use the EnhancedInput system.</p>
</blockquote>
<p>继承UGameFeatureAction_WorldActionBase，将玩家输入映射配置注册进Game User Settings。</p>
<ul>
<li>UGameFeatureAction_AddInputBinding</li>
</ul>
<blockquote>
<p>Adds InputMappingContext to local players’ EnhancedInput system.<br>Expects that local players are set up to use the EnhancedInput system.</p>
</blockquote>
<p>继承UGameFeatureAction_WorldActionBase，将InputMappingContext加入到本地玩家增强输入系统中。</p>
<ul>
<li>ULyraAssetManager</li>
</ul>
<blockquote>
<p>Game implementation of the asset manager that override functionality and store game-specific types.<br>It is expected that most game will want to override AssetManager as it provides a good place for game-specific loading logic.<br>This class is used by setting ‘AssetManagerClassName’ in DefaultEngine.ini</p>
</blockquote>
<p>继承UAssetManager，Lyra的资产管理类，扩展资产管理的功能，并且可以存储一些特定游戏类型的资源。</p>
<ul>
<li>ULyraHeroComponent</li>
</ul>
<blockquote>
<p>Component that sets up input and camera handling for player controlled pawns (or bots that simulate players).<br>This depends on a PawnExtensionComponent to coordinate initialization.</p>
</blockquote>
<p>继承UPawnComponent和IGameFrameworkInitStateInterface，设置和初始化玩家角色输入（或者模拟玩家的AI输入）、控制摄像机的角色组件。与PawnExtensionComponent角色组件进行协同初始化。</p>
<p>玩家输入初始化的关键函数<code>InitializaPlayerInput(UInputComponent* PlayerInputComponent)</code>。</p>
<ul>
<li><p>ULyraInputConfig</p>
</li>
<li><p>ULyraInputComponent</p>
</li>
<li><p>ULyraGameplayTags</p>
</li>
<li><p>ULyraPawnData</p>
</li>
<li><p>ULyraPawnExtension</p>
</li>
<li><p>ULyraSettingsLocal</p>
</li>
</ul>
<h2 id="Work-Flow-1"><a href="#Work-Flow-1" class="headerlink" title="Work Flow"></a>Work Flow</h2><p>由于输入配置存在PawnData中，而PawnData又是一种资产，会被GameFeature加载。所以先理清楚PawnData的来源</p>
<h3 id="PawnData-Data-Flow"><a href="#PawnData-Data-Flow" class="headerlink" title="PawnData Data Flow"></a>PawnData Data Flow</h3><img src="/2023/06/20/Lyra/Unreal%20Engine%205%20Lyra%20Starter%20Game%20Pawn%20Data%20Flow.png" class="" title="Lyra Pawn Data Flow">

<h3 id="Key-Implementation-1"><a href="#Key-Implementation-1" class="headerlink" title="Key Implementation"></a>Key Implementation</h3><ul>
<li>LyraHeroComponent.cpp: virtual void InitializaPlayerInput(UInputComponent* PlayerInputComponent)<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="type">const</span> ULyraPawnExtensionComponent* PawnExtComp = ULyraPawnExtensionComponent::<span class="built_in">FindPawnExtensionComponent</span>(Pawn))</span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">// 从PawnExetension组件获取PawnData</span></span><br><span class="line">	<span class="keyword">if</span> (<span class="type">const</span> ULyraPawnData* PawnData = PawnExtComp-&gt;<span class="built_in">GetPawnData</span>&lt;ULyraPawnData&gt;())</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// 在PawnData中获取应该激活的输入配置</span></span><br><span class="line">		<span class="keyword">if</span> (<span class="type">const</span> ULyraInputConfig* InputConfig = PawnData-&gt;InputConfig)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">// Register any default input configs with the settings so that they will be applied to the player during AddInputMappings</span></span><br><span class="line">			<span class="keyword">for</span> (<span class="type">const</span> FMappableConfigPair&amp; Pair : DefaultInputConfigs)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">if</span> (Pair.bShouldActivateAutomatically &amp;&amp; Pair.<span class="built_in">CanBeActivated</span>())</span><br><span class="line">				&#123;</span><br><span class="line">					FModifyContextOptions Options = &#123;&#125;;</span><br><span class="line">					Options.bIgnoreAllPressedKeysUntilRelease = <span class="literal">false</span>;</span><br><span class="line">					<span class="comment">// 将获取到的输入映射加入EnhancedInput实例中进行注册</span></span><br><span class="line">					<span class="comment">// Actually add the config to the local player							</span></span><br><span class="line">					Subsystem-&gt;<span class="built_in">AddPlayerMappableConfig</span>(Pair.Config.<span class="built_in">LoadSynchronous</span>(), Options);	</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// The Lyra Input Component has some additional functions to map Gameplay Tags to an Input Action.</span></span><br><span class="line">			<span class="comment">// If you want this functionality but still want to change your input component class, make it a subclass</span></span><br><span class="line">			<span class="comment">// of the ULyraInputComponent or modify this component accordingly.</span></span><br><span class="line">			ULyraInputComponent* LyraIC = <span class="built_in">Cast</span>&lt;ULyraInputComponent&gt;(PlayerInputComponent);</span><br><span class="line">			<span class="keyword">if</span> (<span class="built_in">ensureMsgf</span>(LyraIC, <span class="built_in">TEXT</span>(<span class="string">&quot;Unexpected Input Component class! The Gameplay Abilities will not be bound to their inputs. Change the input component to ULyraInputComponent or a subclass of it.&quot;</span>)))</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="comment">// Add the key mappings that may have been set by the player</span></span><br><span class="line">				<span class="comment">// 输入配置</span></span><br><span class="line">				LyraIC-&gt;<span class="built_in">AddInputMappings</span>(InputConfig, Subsystem);</span><br><span class="line"></span><br><span class="line">				<span class="comment">// This is where we actually bind and input action to a gameplay tag, which means that Gameplay Ability Blueprints will</span></span><br><span class="line">				<span class="comment">// be triggered directly by these input actions Triggered events. </span></span><br><span class="line">				TArray&lt;uint32&gt; BindHandles;</span><br><span class="line">				</span><br><span class="line">				<span class="comment">// </span></span><br><span class="line">				LyraIC-&gt;<span class="built_in">BindAbilityActions</span>(InputConfig, <span class="keyword">this</span>, &amp;ThisClass::Input_AbilityInputTagPressed, &amp;ThisClass::Input_AbilityInputTagReleased, <span class="comment">/*out*/</span> BindHandles);</span><br><span class="line"></span><br><span class="line">				<span class="comment">// 将输入配置、标签、输入触发事件、具体逻辑进行绑定</span></span><br><span class="line">				LyraIC-&gt;<span class="built_in">BindNativeAction</span>(InputConfig, LyraGameplayTags::InputTag_Move, ETriggerEvent::Triggered, <span class="keyword">this</span>, &amp;ThisClass::Input_Move, <span class="comment">/*bLogIfNotFound=*/</span> <span class="literal">false</span>);</span><br><span class="line">				LyraIC-&gt;<span class="built_in">BindNativeAction</span>(InputConfig, LyraGameplayTags::InputTag_Look_Mouse, ETriggerEvent::Triggered, <span class="keyword">this</span>, &amp;ThisClass::Input_LookMouse, <span class="comment">/*bLogIfNotFound=*/</span> <span class="literal">false</span>);</span><br><span class="line">				LyraIC-&gt;<span class="built_in">BindNativeAction</span>(InputConfig, LyraGameplayTags::InputTag_Look_Stick, ETriggerEvent::Triggered, <span class="keyword">this</span>, &amp;ThisClass::Input_LookStick, <span class="comment">/*bLogIfNotFound=*/</span> <span class="literal">false</span>);</span><br><span class="line">				LyraIC-&gt;<span class="built_in">BindNativeAction</span>(InputConfig, LyraGameplayTags::InputTag_Crouch, ETriggerEvent::Triggered, <span class="keyword">this</span>, &amp;ThisClass::Input_Crouch, <span class="comment">/*bLogIfNotFound=*/</span> <span class="literal">false</span>);</span><br><span class="line">				LyraIC-&gt;<span class="built_in">BindNativeAction</span>(InputConfig, LyraGameplayTags::InputTag_AutoRun, ETriggerEvent::Triggered, <span class="keyword">this</span>, &amp;ThisClass::Input_AutoRun, <span class="comment">/*bLogIfNotFound=*/</span> <span class="literal">false</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="Class-Diagram"><a href="#Class-Diagram" class="headerlink" title="Class Diagram"></a>Class Diagram</h3><img src="/2023/06/20/Lyra/Unreal%20Engine%205%20Lyra%20Starter%20Game%20Class%20Diagram.png" class="" title="Lyra Input Class Diagram">

<h3 id="Flow-Diagram"><a href="#Flow-Diagram" class="headerlink" title="Flow Diagram"></a>Flow Diagram</h3><img src="/2023/06/20/Lyra/Unreal%20Engine%205%20Lyra%20Starter%20Game%20Input.png" class="" title="Lyra Input Work Flow">

<h2 id="Note"><a href="#Note" class="headerlink" title="Note"></a>Note</h2><p>不使用除Enhanced Input之外的插件时，需要关注代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> ULyraAssetManager::<span class="built_in">Get</span>().<span class="built_in">GetDefaultPawnData</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="built_in">GetAsset</span>(DefaultPawnData);</span><br><span class="line"></span><br><span class="line"><span class="built_in">UPROPERTY</span>(Config)</span><br><span class="line">TSoftObjectPtr&lt;ULyraPawnData&gt; DefaultPawnData;</span><br></pre></td></tr></table></figure>

<p>可在Character蓝图类中指定默认值。</p>
<h1 id="Lyra-Animation"><a href="#Lyra-Animation" class="headerlink" title="Lyra Animation"></a>Lyra Animation</h1><h2 id="Required-Plugin"><a href="#Required-Plugin" class="headerlink" title="Required Plugin"></a>Required Plugin</h2><ul>
<li>Animation Locomotion Library</li>
</ul>
<blockquote>
<p>Collection of techniques for driving locomotion animations.</p>
</blockquote>
<p>运动动画后期处理技术的代码库。</p>
<ul>
<li>Animation Warping</li>
</ul>
<blockquote>
<p>Framework for animation and pose warping. This plugin includes Stride, Orientation, and Slope Warping alongside the Root Motion Delta animation attribute.</p>
</blockquote>
<p>姿势扭曲的动画框架，可提供步幅扭曲、方向扭曲、根运动Delta动画属性等功能。</p>
<h2 id="Solution-Design"><a href="#Solution-Design" class="headerlink" title="Solution Design"></a>Solution Design</h2><p>ABP_Mannequin_Base-&gt;ALI_ItemAnimLayers-&gt;ABP_ItemAnimLayersBase-&gt;ABP_&lt;定义了要使用的具体动画的蓝图&gt;</p>
<p>ABP_Mannequine_Base负责角色动画状态机、上下半身动画分离处理再合并、线程安全更新动画所需要的数据、一部分后期处理。</p>
<p>ALI_ItemAnimLayers是纯接口层。</p>
<p>ABP_ItemAnimLayersBase负责实现具体的接口和大多数动画后期处理，例如瞄准偏移(Aim Offset)、步幅扭曲(Stride Warping)、距离匹配(Distance Match)等。</p>
<p>可使用Unreal Engine中的Reference View了解大致的</p>
<h2 id="部分需要注意或者还未了解清楚的细节"><a href="#部分需要注意或者还未了解清楚的细节" class="headerlink" title="部分需要注意或者还未了解清楚的细节"></a>部分需要注意或者还未了解清楚的细节</h2><h3 id="BlueprintThreadSafeUpdateAnimation"><a href="#BlueprintThreadSafeUpdateAnimation" class="headerlink" title="BlueprintThreadSafeUpdateAnimation"></a>BlueprintThreadSafeUpdateAnimation</h3><p>?线程安全更新动画数据，将这部分工作交给工作线程而不是游戏线程以提升性能，但是可能在C++中的NativeUpdateAnimation中进行该部分工作可能可以获得更好的性能?</p>
<h3 id="SelectCardinalDirectionFromAngle"><a href="#SelectCardinalDirectionFromAngle" class="headerlink" title="SelectCardinalDirectionFromAngle"></a>SelectCardinalDirectionFromAngle</h3><p>从字面意义和函数具体实现来看，是从得到的角色面向方向与速度的夹角推算出角色朝向的主要方向(Cardinal Direction)，主要方向有四个：前方(Forward)、后方(Backward)、左方(Left)、右方(Right)。</p>
<p>比如人物面朝前方往右偏前方移动，那么该函数的结果，主要方向为前方(Forward)。</p>
<p>?DeadZone意义位置，推测为摄像机的视野盲区，可能跟FOV有关系?</p>
<p>其他获取到的参数值是为了得到角色的面向方向与速度方向的夹角，根据四个主要方向的定义范围，判断该夹角的值是否位于某个方向的范围内，最后返回。</p>
<p>?八向移动?</p>
<h3 id="Root-Motion"><a href="#Root-Motion" class="headerlink" title="Root Motion"></a>Root Motion</h3><p>不启用根运动时，如果动画有运动数据，那么骨骼网格和角色会分离，动画播放结束以后骨骼网格会回到原点。启用以后骨骼会驱动角色动作，随着角色驱动动作。</p>
<p>用Miaximo的前进动画时，因为本身带有运动数据，然后根运动应该是默认关闭的，出现角色循环前进一段距离然后回到原点的情况。解决的办法应该是把胶囊体移速设置为0然后开启跟运动，但是估计效果仍然不好。</p>
<h3 id="Stride-Warping-步幅扭曲"><a href="#Stride-Warping-步幅扭曲" class="headerlink" title="Stride Warping (步幅扭曲)"></a>Stride Warping (步幅扭曲)</h3><p>动态调整角色的动画步幅来匹配胶囊体的移动速度。与距离匹配函数库配合来减少滑步的负面视觉影响。</p>
<p>在蓝图中，还提供了贴墙情况下的处理实现(UpdateCycleAnim)。</p>
<ul>
<li>Engine\Plugins\Animation\AnimationWarping\Source\Runtime\Private\BoneControllers\AnimNode_StrideWarping.cpp</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">FAnimNode_StrideWarping::EvaluateSkeletalControl_AnyThread</span><span class="params">(FComponentSpacePostContext&amp; Output, Tarray&lt;FboneTransform&gt;&amp; OutBoneTransforms)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">SCOPE_CYCLE_COUNTER</span>(STAT_StrideWarping_Eval);</span><br><span class="line">	<span class="built_in">check</span>(OutBoneTransforms.<span class="built_in">IsEmpty</span>());</span><br><span class="line"></span><br><span class="line">	<span class="type">const</span> FVector PreviousStrideDirection = ActualStrideDirection;</span><br><span class="line">	ActualStrideDirection = StrideDirection;</span><br><span class="line">	ActualStrideScale = StrideScale;</span><br><span class="line"></span><br><span class="line">	<span class="type">bool</span> bGraphDrivenWarping = <span class="literal">false</span>;</span><br><span class="line">	<span class="type">const</span> UE::Anim::IAnimRootMotionProvider* RootMotionProvider = UE::Anim::IAnimRootMotionProvider::<span class="built_in">Get</span>();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (Mode == EWarpingEvaluationMode::Graph)</span><br><span class="line">	&#123;</span><br><span class="line">		bGraphDrivenWarping = !!RootMotionProvider;</span><br><span class="line">		<span class="built_in">ensureMsgf</span>(bGraphDrivenWarping, <span class="built_in">TEXT</span>(<span class="string">&quot;Graph driven Stride Warping expected a valid root motion delta provider interface.&quot;</span>));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	FTransform RootMotionTransformDelta = FTransform::Identity;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (bGraphDrivenWarping)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// Graph driven stride warping will override the manual stride direction with the intent of the current animation sub-graph&#x27;s accumulated root motion</span></span><br><span class="line">		bGraphDrivenWarping = RootMotionProvider-&gt;<span class="built_in">ExtractRootMotion</span>(Output.CustomAttributes, RootMotionTransformDelta);</span><br><span class="line">		<span class="keyword">if</span> (bGraphDrivenWarping)</span><br><span class="line">		&#123;</span><br><span class="line">			CachedRootMotionDeltaTranslation = RootMotionTransformDelta.<span class="built_in">GetTranslation</span>();</span><br><span class="line">			<span class="comment">// If there&#x27;s no root motion delta, keep the previous stride direction</span></span><br><span class="line">			ActualStrideDirection = CachedRootMotionDeltaTranslation.<span class="built_in">GetSafeNormal</span>(UE_SMALL_NUMBER, PreviousStrideDirection);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">// Early exit on missing root motion delta attribute</span></span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="type">const</span> FBoneContainer&amp; RequiredBones = Output.Pose.<span class="built_in">GetPose</span>().<span class="built_in">GetBoneContainer</span>();</span><br><span class="line">	<span class="type">const</span> FTransform IKFootRootTransform = Output.Pose.<span class="built_in">GetComponentSpaceTransform</span>(IKFootRootBone.<span class="built_in">GetCompactPoseIndex</span>(RequiredBones));</span><br><span class="line">	<span class="type">const</span> FVector ResolvedFloorNormal = FloorNormalDirection.<span class="built_in">AsComponentSpaceDirection</span>(AnimInstanceProxy, IKFootRootTransform);</span><br><span class="line">	<span class="type">const</span> FVector ResolvedGravityDirection = GravityDirection.<span class="built_in">AsComponentSpaceDirection</span>(AnimInstanceProxy, IKFootRootTransform);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (bOrientStrideDirectionUsingFloorNormal)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="type">const</span> FVector StrideWarpingAxis = ResolvedFloorNormal ^ ActualStrideDirection;</span><br><span class="line">		ActualStrideDirection = StrideWarpingAxis ^ ResolvedFloorNormal;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// Get all foot IK Transforms</span></span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">auto</span>&amp; Foot : FootData)</span><br><span class="line">	&#123;</span><br><span class="line">		Foot.IKFootBoneTransform = Output.Pose.<span class="built_in">GetComponentSpaceTransform</span>(Foot.IKFootBoneIndex);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (bGraphDrivenWarping)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (CachedRootMotionDeltaSpeed &lt;= MinRootMotionSpeedThreshold)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">// If root motion speed is under the threshold, snap back to no stride adjustment.</span></span><br><span class="line">			<span class="comment">// If interpolation is on, it will blend the result</span></span><br><span class="line">			ActualStrideScale = <span class="number">1.0f</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">// Graph driven stride scale factor will be determined by the ratio of the</span></span><br><span class="line">			<span class="comment">// locomotion (capsule/physics) speed against the animation root motion speed</span></span><br><span class="line">			ActualStrideScale = LocomotionSpeed / CachedRootMotionDeltaSpeed;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Allow the opportunity for stride scale clamping and interpolation regardless of evaluation mode</span></span><br><span class="line">	ActualStrideScale = StrideScaleModifierState.<span class="built_in">ApplyTo</span>(StrideScaleModifier, ActualStrideScale, CachedDeltaTime);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (bGraphDrivenWarping)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// Forward the side effects of stride warping on the root motion contribution for this sub-graph</span></span><br><span class="line">		RootMotionTransformDelta.<span class="built_in">ScaleTranslation</span>(ActualStrideScale);</span><br><span class="line">		<span class="type">const</span> <span class="type">bool</span> bRootMotionOverridden = RootMotionProvider-&gt;<span class="built_in">OverrideRootMotion</span>(RootMotionTransformDelta, Output.CustomAttributes);</span><br><span class="line">		<span class="built_in">ensureMsgf</span>(bRootMotionOverridden, <span class="built_in">TEXT</span>(<span class="string">&quot;Graph driven Stride Warping expected a root motion delta to be present in the attribute stream prior to warping/overriding it.&quot;</span>));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Scale IK feet bones along Stride Warping Axis, from the Thigh bone location.</span></span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">auto</span>&amp; Foot : FootData)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// Stride Warping along Stride Warping Axis</span></span><br><span class="line">		<span class="type">const</span> FVector IKFootLocation = Foot.IKFootBoneTransform.<span class="built_in">GetLocation</span>();</span><br><span class="line">		<span class="type">const</span> FVector ThighBoneLocation = Output.Pose.<span class="built_in">GetComponentSpaceTransform</span>(Foot.ThighBoneIndex).<span class="built_in">GetLocation</span>();</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Project Thigh Bone Location on plane made of FootIKLocation and FloorPlaneNormal, along Gravity Dir.</span></span><br><span class="line">		<span class="comment">// This will be the StrideWarpingPlaneOrigin</span></span><br><span class="line">		<span class="type">const</span> FVector StrideWarpingPlaneOrigin = (FMath::<span class="built_in">Abs</span>(ResolvedGravityDirection | ResolvedFloorNormal) &gt; DELTA) ? FMath::<span class="built_in">LinePlaneIntersection</span>(ThighBoneLocation, ThighBoneLocation + ResolvedGravityDirection, IKFootLocation, ResolvedFloorNormal) : IKFootLocation;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Project FK Foot along StrideWarping Plane, this will be our Scale Origin</span></span><br><span class="line">		<span class="type">const</span> FVector ScaleOrigin = FVector::<span class="built_in">PointPlaneProject</span>(IKFootLocation, StrideWarpingPlaneOrigin, ActualStrideDirection);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Now the ScaleOrigin and IKFootLocation are forming a line parallel to the floor, and we can scale the IK foot.</span></span><br><span class="line">		<span class="type">const</span> FVector WarpedLocation = ScaleOrigin + (IKFootLocation - ScaleOrigin) * ActualStrideScale;</span><br><span class="line">		Foot.IKFootBoneTransform.<span class="built_in">SetLocation</span>(WarpedLocation);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	FVector PelvisOffset = FVector::ZeroVector;</span><br><span class="line">	<span class="type">const</span> FCompactPoseBoneIndex PelvisBoneIndex = PelvisBone.<span class="built_in">GetCompactPoseIndex</span>(RequiredBones);</span><br><span class="line"></span><br><span class="line">	FTransform PelvisTransform = Output.Pose.<span class="built_in">GetComponentSpaceTransform</span>(PelvisBoneIndex);</span><br><span class="line">	<span class="type">const</span> FVector InitialPelvisLocation = PelvisTransform.<span class="built_in">GetLocation</span>();</span><br><span class="line"></span><br><span class="line">	TArray&lt;<span class="type">float</span>, TInlineAllocator&lt;<span class="number">10</span>&gt;&gt; FKFootDistancesToPelvis;</span><br><span class="line">	FKFootDistancesToPelvis.<span class="built_in">Reserve</span>(FootData.<span class="built_in">Num</span>());</span><br><span class="line"></span><br><span class="line">	TArray&lt;FVector, TInlineAllocator&lt;<span class="number">10</span>&gt;&gt; IKFootLocations;</span><br><span class="line">	IKFootLocations.<span class="built_in">Reserve</span>(FootData.<span class="built_in">Num</span>());</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">auto</span>&amp; Foot : FootData)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="type">const</span> FVector FKFootLocation = Output.Pose.<span class="built_in">GetComponentSpaceTransform</span>(Foot.FKFootBoneIndex).<span class="built_in">GetLocation</span>();</span><br><span class="line">		FKFootDistancesToPelvis.<span class="built_in">Add</span>(FVector::<span class="built_in">Dist</span>(FKFootLocation, InitialPelvisLocation));</span><br><span class="line"></span><br><span class="line">		<span class="type">const</span> FVector IKFootLocation = Foot.IKFootBoneTransform.<span class="built_in">GetLocation</span>();</span><br><span class="line">		IKFootLocations.<span class="built_in">Add</span>(IKFootLocation);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Adjust Pelvis down if needed to keep foot contact with the ground and prevent over-extension</span></span><br><span class="line">	PelvisTransform = PelvisIKFootSolver.<span class="built_in">Solve</span>(PelvisTransform, FKFootDistancesToPelvis, IKFootLocations, CachedDeltaTime);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Add adjusted pelvis transform</span></span><br><span class="line">	<span class="built_in">check</span>(!PelvisTransform.<span class="built_in">ContainsNaN</span>());</span><br><span class="line">	OutBoneTransforms.<span class="built_in">Add</span>(<span class="built_in">FBoneTransform</span>(PelvisBoneIndex, PelvisTransform));</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Compute final offset to use below</span></span><br><span class="line">	PelvisOffset = (PelvisTransform.<span class="built_in">GetLocation</span>() - InitialPelvisLocation);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Rotate Thigh bones to help IK, and maintain leg shape.</span></span><br><span class="line">	<span class="keyword">if</span> (bCompensateIKUsingFKThighRotation)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">auto</span>&amp; Foot : FootData)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="type">const</span> FTransform ThighTransform = Output.Pose.<span class="built_in">GetComponentSpaceTransform</span>(Foot.ThighBoneIndex);</span><br><span class="line">			<span class="type">const</span> FTransform FKFootTransform = Output.Pose.<span class="built_in">GetComponentSpaceTransform</span>(Foot.FKFootBoneIndex);</span><br><span class="line">			</span><br><span class="line">			FTransform AdjustedThighTransform = ThighTransform;</span><br><span class="line">			AdjustedThighTransform.<span class="built_in">AddToTranslation</span>(PelvisOffset);</span><br><span class="line"></span><br><span class="line">			<span class="type">const</span> FVector InitialDir = (FKFootTransform.<span class="built_in">GetLocation</span>() - ThighTransform.<span class="built_in">GetLocation</span>()).<span class="built_in">GetSafeNormal</span>();</span><br><span class="line">			<span class="type">const</span> FVector TargetDir = (Foot.IKFootBoneTransform.<span class="built_in">GetLocation</span>() - AdjustedThighTransform.<span class="built_in">GetLocation</span>()).<span class="built_in">GetSafeNormal</span>();</span><br><span class="line">			</span><br><span class="line">			<span class="comment">// Find Delta Rotation take takes us from Old to New dir</span></span><br><span class="line">			<span class="type">const</span> FQuat DeltaRotation = FQuat::<span class="built_in">FindBetweenNormals</span>(InitialDir, TargetDir);</span><br><span class="line"></span><br><span class="line">			<span class="comment">// Rotate our Joint quaternion by this delta rotation</span></span><br><span class="line">			AdjustedThighTransform.<span class="built_in">SetRotation</span>(DeltaRotation * AdjustedThighTransform.<span class="built_in">GetRotation</span>());</span><br><span class="line"></span><br><span class="line">			<span class="comment">// Add adjusted thigh transform</span></span><br><span class="line">			<span class="built_in">check</span>(!AdjustedThighTransform.<span class="built_in">ContainsNaN</span>());</span><br><span class="line">			OutBoneTransforms.<span class="built_in">Add</span>(<span class="built_in">FBoneTransform</span>(Foot.ThighBoneIndex, AdjustedThighTransform));</span><br><span class="line"></span><br><span class="line">			<span class="comment">// Clamp IK Feet bone based on FK leg. To prevent over-extension and preserve animated motion.</span></span><br><span class="line">			<span class="keyword">if</span> (bClampIKUsingFKLimits)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="type">const</span> <span class="type">float</span> FKLength = FVector::<span class="built_in">Dist</span>(FKFootTransform.<span class="built_in">GetLocation</span>(), ThighTransform.<span class="built_in">GetLocation</span>());</span><br><span class="line">				<span class="type">const</span> <span class="type">float</span> IKLength = FVector::<span class="built_in">Dist</span>(Foot.IKFootBoneTransform.<span class="built_in">GetLocation</span>(), AdjustedThighTransform.<span class="built_in">GetLocation</span>());</span><br><span class="line">				<span class="keyword">if</span> (IKLength &gt; FKLength)</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="type">const</span> FVector ClampedFootLocation = AdjustedThighTransform.<span class="built_in">GetLocation</span>() + TargetDir * FKLength;</span><br><span class="line">					Foot.IKFootBoneTransform.<span class="built_in">SetLocation</span>(ClampedFootLocation);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Add final IK feet transforms</span></span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">auto</span>&amp; Foot : FootData)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">check</span>(!Foot.IKFootBoneTransform.<span class="built_in">ContainsNaN</span>());</span><br><span class="line">		OutBoneTransforms.<span class="built_in">Add</span>(<span class="built_in">FBoneTransform</span>(Foot.IKFootBoneIndex, Foot.IKFootBoneTransform));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Sort OutBoneTransforms so indices are in increasing order.</span></span><br><span class="line">	OutBoneTransforms.<span class="built_in">Sort</span>(<span class="built_in">FCompareBoneTransformIndex</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Orientation-Warping-方向扭曲"><a href="#Orientation-Warping-方向扭曲" class="headerlink" title="Orientation Warping (方向扭曲)"></a>Orientation Warping (方向扭曲)</h3><p>隔离并扭曲动画姿势的腿部IK骨骼，契合根骨骼运动的动态更新移动方向。<br>用于填充动画序列中的覆盖缺口，减少手动创建间隙动画或创建过多混合空间过度的必要性。<br>上下半身分离、锁定瞄准、八向移动会有比较直观的效果。</p>
<ul>
<li>Engine\Plugins\Animation\AnimationWarping\Source\Runtime\Public\BoneControllers\AnimNode_OrientationWarping.cpp</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">FAnimNode_OrientationWarping::EvaluateSkeletalControl_AnyThread</span><span class="params">(FComponentSpacePoseContext&amp; Output, TArray&lt;FBoneTransform&gt;&amp; OutBoneTransforms)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">SCOPE_CYCLE_COUNTER</span>(STAT_OrientationWarping_Eval);</span><br><span class="line">	<span class="built_in">check</span>(OutBoneTransforms.<span class="built_in">Num</span>() == <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">	ActualOrientationAngle = OrientationAngle;</span><br><span class="line"></span><br><span class="line">	<span class="type">const</span> <span class="type">float</span> DeltaSeconds = Output.AnimInstanceProxy-&gt;<span class="built_in">GetDeltaSeconds</span>();</span><br><span class="line">	<span class="type">const</span> FVector RotationAxisVector = UE::Anim::<span class="built_in">GetAxisVector</span>(RotationAxis);</span><br><span class="line">	FVector RootMotionDeltaDirection = FVector::ZeroVector;</span><br><span class="line">	FVector LocomotionForward = FVector::ZeroVector;</span><br><span class="line"></span><br><span class="line">	<span class="type">bool</span> bGraphDrivenWarping = <span class="literal">false</span>;</span><br><span class="line">	<span class="type">const</span> UE::Anim::IAnimRootMotionProvider* RootMotionProvider = UE::Anim::IAnimRootMotionProvider::<span class="built_in">Get</span>();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (Mode == EWarpingEvaluationMode::Graph)</span><br><span class="line">	&#123;</span><br><span class="line">		bGraphDrivenWarping = !!RootMotionProvider;</span><br><span class="line">		<span class="built_in">ensureMsgf</span>(bGraphDrivenWarping, <span class="built_in">TEXT</span>(<span class="string">&quot;Graph driven Orientation Warping expected a valid root motion delta provider interface.&quot;</span>));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> WITH_EDITORONLY_DATA</span></span><br><span class="line">	bFoundRootMotionAttribute = <span class="literal">false</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// We will likely need to revisit LocomotionAngle participating as an input to orientation warping.</span></span><br><span class="line">	<span class="comment">// Without velocity information from the motion model (such as the capsule), LocomotionAngle isn&#x27;t enough</span></span><br><span class="line">	<span class="comment">// information in isolation for all cases when deciding to warp.</span></span><br><span class="line">	<span class="comment">//</span></span><br><span class="line">	<span class="comment">// For example imagine that the motion model has stopped moving with zero velocity due to a</span></span><br><span class="line">	<span class="comment">// transition into a strafing stop. During that transition we may play an animation with non-zero </span></span><br><span class="line">	<span class="comment">// velocity for an arbitrary number of frames. In this scenario the concept of direction is meaningless </span></span><br><span class="line">	<span class="comment">// since we cannot orient the animation to match a zero velocity and consequently a zero direction, </span></span><br><span class="line">	<span class="comment">// since that would break the pose. For those frames, we would incorrectly over-orient the strafe.</span></span><br><span class="line">	<span class="comment">//</span></span><br><span class="line">	<span class="comment">// The solution may be instead to pass velocity with the actor base rotation, allowing us to retain</span></span><br><span class="line">	<span class="comment">// speed information about the motion. It may also allow us to do more complex orienting behavior </span></span><br><span class="line">	<span class="comment">// when multiple degrees of freedom can be considered.</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (bGraphDrivenWarping)</span><br><span class="line">	&#123;</span><br><span class="line">		FTransform RootMotionTransformDelta = FTransform::Identity;</span><br><span class="line">		bGraphDrivenWarping = RootMotionProvider-&gt;<span class="built_in">ExtractRootMotion</span>(Output.CustomAttributes, RootMotionTransformDelta);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Graph driven orientation warping will modify the incoming root motion to orient towards the intended locomotion angle</span></span><br><span class="line">		<span class="keyword">if</span> (bGraphDrivenWarping)</span><br><span class="line">		&#123;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> WITH_EDITORONLY_DATA</span></span><br><span class="line">			<span class="comment">// Graph driven Orientation Warping expects a root motion delta to be present in the attribute stream.</span></span><br><span class="line">			bFoundRootMotionAttribute = <span class="literal">true</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">			<span class="comment">// In UE, forward is defined as +x; consequently this is also true when sampling an actor&#x27;s velocity. Historically the skeletal </span></span><br><span class="line">			<span class="comment">// mesh component forward will not match the actor, requiring us to correct the rotation before sampling the LocomotionForward.</span></span><br><span class="line">			<span class="comment">// In order to make orientation warping &#x27;pure&#x27; in the future we will need to provide more context about the intent of</span></span><br><span class="line">			<span class="comment">// the actor vs the intent of the animation in their respective spaces. Specifically, we will need some form the following information:</span></span><br><span class="line">			<span class="comment">//</span></span><br><span class="line">			<span class="comment">// 1. Actor Forward</span></span><br><span class="line">			<span class="comment">// 2. Actor Velocity</span></span><br><span class="line">			<span class="comment">// 3. Skeletal Mesh Relative Rotation</span></span><br><span class="line"></span><br><span class="line">			LocomotionAngle = FRotator::<span class="built_in">NormalizeAxis</span>(LocomotionAngle);</span><br><span class="line">			LocomotionAngle = FMath::<span class="built_in">DegreesToRadians</span>(LocomotionAngle);</span><br><span class="line">			<span class="type">const</span> FQuat LocomotionRotation = <span class="built_in">FQuat</span>(RotationAxisVector, LocomotionAngle);</span><br><span class="line"></span><br><span class="line">			<span class="type">const</span> FTransform SkeletalMeshRelativeTransform = Output.AnimInstanceProxy-&gt;<span class="built_in">GetComponentRelativeTransform</span>();</span><br><span class="line">			<span class="type">const</span> FQuat SkeletalMeshRelativeRotation = SkeletalMeshRelativeTransform.<span class="built_in">GetRotation</span>();</span><br><span class="line">			LocomotionForward = SkeletalMeshRelativeRotation.<span class="built_in">UnrotateVector</span>(LocomotionRotation.<span class="built_in">GetForwardVector</span>()).<span class="built_in">GetSafeNormal</span>();</span><br><span class="line">			</span><br><span class="line">			<span class="keyword">if</span> (OffsetAlpha == <span class="number">0.0</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="comment">// No alpha. Reset our heading offset.</span></span><br><span class="line">				HeadingOffset = <span class="number">0.0f</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">			&#123;</span><br><span class="line">				<span class="comment">// Accumulate a percentage of our component&#x27;s frame delta, based on offset alpha</span></span><br><span class="line">				<span class="type">const</span> <span class="type">float</span> LastComponentHeading = ComponentHeading;</span><br><span class="line">				ComponentHeading = Output.AnimInstanceProxy-&gt;<span class="built_in">GetComponentTransform</span>().<span class="built_in">GetRotation</span>().<span class="built_in">GetTwistAngle</span>(RotationAxisVector);</span><br><span class="line">				HeadingOffset += FMath::<span class="built_in">UnwindRadians</span>(LastComponentHeading - ComponentHeading) * OffsetAlpha;</span><br><span class="line"></span><br><span class="line">				<span class="comment">// Accumulate a percentage of our root motion&#x27;s heading, based on offset alpha</span></span><br><span class="line">				<span class="type">float</span> RootMotionDeltaHeading = RootMotionTransformDelta.<span class="built_in">GetRotation</span>().<span class="built_in">GetTwistAngle</span>(RotationAxisVector);</span><br><span class="line">				HeadingOffset += RootMotionDeltaHeading * OffsetAlpha;</span><br><span class="line"></span><br><span class="line">				<span class="comment">// If our alpha is decreasing, we&#x27;re blending out the offset.</span></span><br><span class="line">				<span class="comment">// We don&#x27;t need to do this when blending in because we&#x27;re just accumulating partial component offset and root motion.</span></span><br><span class="line">				<span class="type">const</span> <span class="type">float</span> OffsetAlphaStep = LastOffsetAlpha - OffsetAlpha;</span><br><span class="line">				<span class="keyword">if</span> (OffsetAlphaStep &gt; <span class="number">0.0f</span>)</span><br><span class="line">				&#123;</span><br><span class="line">					HeadingOffset -= OffsetAlphaStep * HeadingOffset / LastOffsetAlpha;</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				<span class="type">const</span> <span class="type">float</span> MaxOffsetRadians = FMath::<span class="built_in">DegreesToRadians</span>(MaxOffsetAngle);</span><br><span class="line">				HeadingOffset = FMath::<span class="built_in">Clamp</span>(HeadingOffset, -MaxOffsetAngle, MaxOffsetAngle);</span><br><span class="line">			&#125;</span><br><span class="line">			LastOffsetAlpha = OffsetAlpha;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// Rotate the root motion direction by our effective offset.</span></span><br><span class="line">			<span class="comment">// This means we will warp our pose based on the adjusted offset, and correct accordingly.</span></span><br><span class="line">			FQuat RootOffsetRotation = <span class="built_in">FQuat</span>(RotationAxisVector, HeadingOffset);</span><br><span class="line">			<span class="type">const</span> FVector RootMotionDeltaTranslation = RootOffsetRotation.<span class="built_in">RotateVector</span>(RootMotionTransformDelta.<span class="built_in">GetTranslation</span>());</span><br><span class="line"></span><br><span class="line">			<span class="comment">// Hold previous direction if we can&#x27;t calculate it from current move delta, because the root is no longer moving</span></span><br><span class="line">			RootMotionDeltaDirection = RootMotionDeltaTranslation.<span class="built_in">GetSafeNormal</span>(UE_SMALL_NUMBER, PreviousRootMotionDeltaDirection);</span><br><span class="line"></span><br><span class="line">			<span class="type">const</span> <span class="type">float</span> RootMotionDeltaSpeed = RootMotionDeltaTranslation.<span class="built_in">Size</span>() / DeltaSeconds;</span><br><span class="line">			<span class="keyword">if</span> (RootMotionDeltaSpeed &lt; MinRootMotionSpeedThreshold)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="comment">// If we&#x27;re under the threshold, snap orientation angle to 0, and let interpolation handle the delta</span></span><br><span class="line">				ActualOrientationAngle = <span class="number">0.0f</span>;</span><br><span class="line">				PreviousRootMotionDeltaDirection = RootMotionDeltaDirection;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">			&#123;</span><br><span class="line">				<span class="comment">// Capture the delta rotation from the axis of motion we care about</span></span><br><span class="line">				FQuat WarpedRotation = FQuat::<span class="built_in">FindBetween</span>(RootMotionDeltaDirection, LocomotionForward);</span><br><span class="line"></span><br><span class="line">				<span class="comment">// For interpolated warping, guarantee that PreviousOrientationAngle is relative to the current frame&#x27;s root motion direction </span></span><br><span class="line">				<span class="type">float</span> RootMotionDeltaAngleDifference = FMath::<span class="built_in">Acos</span>(RootMotionDeltaDirection.<span class="built_in">Dot</span>(PreviousRootMotionDeltaDirection));</span><br><span class="line">				RootMotionDeltaAngleDifference *= FMath::<span class="built_in">Sign</span>(RotationAxisVector.<span class="built_in">Dot</span>(RootMotionDeltaDirection.<span class="built_in">Cross</span>(PreviousRootMotionDeltaDirection)));</span><br><span class="line"></span><br><span class="line">				PreviousRootMotionDeltaDirection = RootMotionDeltaDirection;</span><br><span class="line">				PreviousOrientationAngle += RootMotionDeltaAngleDifference;</span><br><span class="line"></span><br><span class="line">				ActualOrientationAngle = WarpedRotation.<span class="built_in">GetTwistAngle</span>(RotationAxisVector);</span><br><span class="line">				<span class="comment">// Motion Matching may return an animation that deviates a lot from the movement direction (e.g movement direction going bwd and motion matching could return the fwd animation for a few frames)</span></span><br><span class="line">				<span class="comment">// When that happens, since we use the delta between root motion and movement direction, we would be over-rotating the lower body and breaking the pose during those frames</span></span><br><span class="line">				<span class="comment">// So, when that happens we use the inverse of the movement direction to calculate our target rotation. </span></span><br><span class="line">				<span class="comment">// This feels a bit &#x27;hacky&#x27; but its the only option I&#x27;ve found so far to mitigate the problem</span></span><br><span class="line">				<span class="keyword">if</span> (LocomotionAngleDeltaThreshold &gt; <span class="number">0.f</span>)</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="keyword">if</span> (FMath::<span class="built_in">Abs</span>(FMath::<span class="built_in">RadiansToDegrees</span>(ActualOrientationAngle)) &gt; LocomotionAngleDeltaThreshold)</span><br><span class="line">					&#123;</span><br><span class="line">						WarpedRotation = FQuat::<span class="built_in">FindBetween</span>(RootMotionDeltaDirection, -LocomotionForward);</span><br><span class="line">						ActualOrientationAngle = WarpedRotation.<span class="built_in">GetTwistAngle</span>(RotationAxisVector);</span><br><span class="line">					&#125;</span><br><span class="line">					</span><br><span class="line">					<span class="keyword">if</span> (FMath::<span class="built_in">Abs</span>(FMath::<span class="built_in">RadiansToDegrees</span>(PreviousOrientationAngle)) &gt; LocomotionAngleDeltaThreshold)</span><br><span class="line">					&#123;</span><br><span class="line">						<span class="comment">// Previous orientation angle might be using an opposite direction too, so flip it if it exceeds the threshold as well.</span></span><br><span class="line">						PreviousOrientationAngle = WarpedRotation.<span class="built_in">GetTwistAngle</span>(RotationAxisVector);</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				<span class="comment">// Rotate the root motion delta fully by the warped angle</span></span><br><span class="line">				<span class="type">const</span> FVector WarpedRootMotionTranslationDelta = WarpedRotation.<span class="built_in">RotateVector</span>(RootMotionDeltaTranslation);</span><br><span class="line">				RootMotionTransformDelta.<span class="built_in">SetTranslation</span>(WarpedRootMotionTranslationDelta);</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">			<span class="comment">// Forward the side effects of orientation warping on the root motion contribution for this sub-graph</span></span><br><span class="line">			<span class="type">const</span> <span class="type">bool</span> bRootMotionOverridden = RootMotionProvider-&gt;<span class="built_in">OverrideRootMotion</span>(RootMotionTransformDelta, Output.CustomAttributes);</span><br><span class="line">			<span class="built_in">ensureMsgf</span>(bRootMotionOverridden, <span class="built_in">TEXT</span>(<span class="string">&quot;Graph driven Orientation Warping expected a root motion delta to be present in the attribute stream prior to warping/overriding it.&quot;</span>));</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">// Early exit on missing root motion delta attribute</span></span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; </span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// Manual orientation warping will take the angle directly</span></span><br><span class="line">		ActualOrientationAngle = FRotator::<span class="built_in">NormalizeAxis</span>(ActualOrientationAngle);</span><br><span class="line">		ActualOrientationAngle = FMath::<span class="built_in">DegreesToRadians</span>(ActualOrientationAngle);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Optionally interpolate the effective orientation towards the target orientation angle</span></span><br><span class="line">	<span class="keyword">if</span> (RotationInterpSpeed &gt; <span class="number">0.f</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		ActualOrientationAngle = FMath::<span class="built_in">FInterpTo</span>(PreviousOrientationAngle, ActualOrientationAngle, DeltaSeconds, RotationInterpSpeed);</span><br><span class="line">		PreviousOrientationAngle = ActualOrientationAngle;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Allow the alpha value of the node to affect the final rotation</span></span><br><span class="line">	ActualOrientationAngle *= ActualAlpha * WarpingAlpha;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> ENABLE_ANIM_DEBUG</span></span><br><span class="line">	<span class="type">bool</span> bDebugging = <span class="literal">false</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> WITH_EDITORONLY_DATA</span></span><br><span class="line">	bDebugging = bDebugging || bEnableDebugDraw;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">	<span class="keyword">constexpr</span> <span class="type">float</span> DebugDrawScale = <span class="number">1.f</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">	<span class="type">const</span> int32 DebugIndex = CVarAnimNodeOrientationWarpingDebug.<span class="built_in">GetValueOnAnyThread</span>();</span><br><span class="line">	bDebugging = bDebugging || (DebugIndex &gt; <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (bDebugging)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="type">const</span> FTransform ComponentTransform = Output.AnimInstanceProxy-&gt;<span class="built_in">GetComponentTransform</span>();</span><br><span class="line">		<span class="type">const</span> FVector ActorForwardDirection = Output.AnimInstanceProxy-&gt;<span class="built_in">GetActorTransform</span>().<span class="built_in">GetRotation</span>().<span class="built_in">GetForwardVector</span>();</span><br><span class="line">		FVector DebugArrowOffset = FVector::ZAxisVector * DebugDrawScale;</span><br><span class="line"></span><br><span class="line">		<span class="type">const</span> <span class="type">bool</span> bDrawAll = DebugIndex == <span class="number">3</span>;</span><br><span class="line">		<span class="type">const</span> <span class="type">bool</span> bDrawOffset = (DebugIndex == <span class="number">2</span>) || bDrawAll;</span><br><span class="line">		<span class="type">const</span> <span class="type">bool</span> bDrawWarping = (DebugIndex == <span class="number">1</span>) || bDrawAll;</span><br><span class="line">		<span class="keyword">if</span> (bDrawWarping)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="type">const</span> FVector ForwardDirection = bGraphDrivenWarping</span><br><span class="line">				? ComponentTransform.<span class="built_in">GetRotation</span>().<span class="built_in">RotateVector</span>(LocomotionForward)</span><br><span class="line">				: ActorForwardDirection;</span><br><span class="line"></span><br><span class="line">			Output.AnimInstanceProxy-&gt;<span class="built_in">AnimDrawDebugDirectionalArrow</span>(</span><br><span class="line">				ComponentTransform.<span class="built_in">GetLocation</span>() + DebugArrowOffset,</span><br><span class="line">				ComponentTransform.<span class="built_in">GetLocation</span>() + DebugArrowOffset + ForwardDirection * <span class="number">100.f</span> * DebugDrawScale,</span><br><span class="line">				<span class="number">40.f</span> * DebugDrawScale, FColor::Red, <span class="literal">false</span>, <span class="number">0.f</span>, <span class="number">2.f</span> * DebugDrawScale);</span><br><span class="line"></span><br><span class="line">			<span class="type">const</span> FVector RotationDirection = bGraphDrivenWarping</span><br><span class="line">				? ComponentTransform.<span class="built_in">GetRotation</span>().<span class="built_in">RotateVector</span>(RootMotionDeltaDirection)</span><br><span class="line">				: ActorForwardDirection.<span class="built_in">RotateAngleAxis</span>(OrientationAngle, RotationAxisVector);</span><br><span class="line"></span><br><span class="line">			DebugArrowOffset += FVector::ZAxisVector * DebugDrawScale;</span><br><span class="line">			Output.AnimInstanceProxy-&gt;<span class="built_in">AnimDrawDebugDirectionalArrow</span>(</span><br><span class="line">				ComponentTransform.<span class="built_in">GetLocation</span>() + DebugArrowOffset,</span><br><span class="line">				ComponentTransform.<span class="built_in">GetLocation</span>() + DebugArrowOffset + RotationDirection * <span class="number">100.f</span> * DebugDrawScale,</span><br><span class="line">				<span class="number">40.f</span> * DebugDrawScale, FColor::Blue, <span class="literal">false</span>, <span class="number">0.f</span>, <span class="number">2.f</span> * DebugDrawScale);</span><br><span class="line"></span><br><span class="line">			<span class="type">const</span> <span class="type">float</span> ActualOrientationAngleDegrees = FMath::<span class="built_in">RadiansToDegrees</span>(ActualOrientationAngle);</span><br><span class="line">			<span class="type">const</span> FVector WarpedRotationDirection = bGraphDrivenWarping</span><br><span class="line">				? RotationDirection.<span class="built_in">RotateAngleAxis</span>(ActualOrientationAngleDegrees, RotationAxisVector)</span><br><span class="line">				: ActorForwardDirection.<span class="built_in">RotateAngleAxis</span>(ActualOrientationAngleDegrees, RotationAxisVector);</span><br><span class="line"></span><br><span class="line">			DebugArrowOffset += FVector::ZAxisVector * DebugDrawScale;</span><br><span class="line">			Output.AnimInstanceProxy-&gt;<span class="built_in">AnimDrawDebugDirectionalArrow</span>(</span><br><span class="line">				ComponentTransform.<span class="built_in">GetLocation</span>() + DebugArrowOffset,</span><br><span class="line">				ComponentTransform.<span class="built_in">GetLocation</span>() + DebugArrowOffset + WarpedRotationDirection * <span class="number">100.f</span> * DebugDrawScale,</span><br><span class="line">				<span class="number">40.f</span> * DebugDrawScale, FColor::Green, <span class="literal">false</span>, <span class="number">0.f</span>, <span class="number">2.f</span> * DebugDrawScale);</span><br><span class="line">			DebugArrowOffset += FVector::ZAxisVector * DebugDrawScale;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">if</span> (bDrawOffset)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="type">const</span> <span class="type">float</span> HeadingOffetDegrees = FMath::<span class="built_in">RadiansToDegrees</span>(HeadingOffset);</span><br><span class="line">			<span class="type">const</span> FVector OffsetDirection = ActorForwardDirection.<span class="built_in">RotateAngleAxis</span>(HeadingOffetDegrees, RotationAxisVector);</span><br><span class="line"></span><br><span class="line">			Output.AnimInstanceProxy-&gt;<span class="built_in">AnimDrawDebugDirectionalArrow</span>(</span><br><span class="line">				ComponentTransform.<span class="built_in">GetLocation</span>() + DebugArrowOffset,</span><br><span class="line">				ComponentTransform.<span class="built_in">GetLocation</span>() + DebugArrowOffset + OffsetDirection * <span class="number">100.f</span> * DebugDrawScale,</span><br><span class="line">				<span class="number">40.f</span> * DebugDrawScale, FColor::Purple, <span class="literal">false</span>, <span class="number">0.f</span>, <span class="number">2.f</span> * DebugDrawScale);</span><br><span class="line"></span><br><span class="line">			DebugArrowOffset += FVector::ZAxisVector * DebugDrawScale;</span><br><span class="line">			Output.AnimInstanceProxy-&gt;<span class="built_in">AnimDrawDebugDirectionalArrow</span>(</span><br><span class="line">				ComponentTransform.<span class="built_in">GetLocation</span>() + DebugArrowOffset,</span><br><span class="line">				ComponentTransform.<span class="built_in">GetLocation</span>() + DebugArrowOffset + ActorForwardDirection * <span class="number">100.f</span> * DebugDrawScale,</span><br><span class="line">				<span class="number">40.f</span> * DebugDrawScale, FColor::Black, <span class="literal">false</span>, <span class="number">0.f</span>, <span class="number">2.f</span> * DebugDrawScale);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// Combine our warping and heading offsets to rotate our root bone</span></span><br><span class="line">	<span class="type">const</span> <span class="type">float</span> CombinedRootOffset = FMath::<span class="built_in">UnwindRadians</span>(ActualOrientationAngle * DistributedBoneOrientationAlpha + HeadingOffset);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Rotate Root Bone first, as that cheaply rotates the whole pose with one transformation.</span></span><br><span class="line">	<span class="keyword">if</span> (!FMath::<span class="built_in">IsNearlyZero</span>(CombinedRootOffset, KINDA_SMALL_NUMBER))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="type">const</span> FQuat RootRotation = <span class="built_in">FQuat</span>(RotationAxisVector, CombinedRootOffset);</span><br><span class="line">		<span class="function"><span class="type">const</span> FCompactPoseBoneIndex <span class="title">RootBoneIndex</span><span class="params">(<span class="number">0</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">		<span class="function">FTransform <span class="title">RootBoneTransform</span><span class="params">(Output.Pose.GetComponentSpaceTransform(RootBoneIndex))</span></span>;</span><br><span class="line">		RootBoneTransform.<span class="built_in">SetRotation</span>(RootRotation * RootBoneTransform.<span class="built_in">GetRotation</span>());</span><br><span class="line">		RootBoneTransform.<span class="built_in">NormalizeRotation</span>();</span><br><span class="line">		Output.Pose.<span class="built_in">SetComponentSpaceTransform</span>(RootBoneIndex, RootBoneTransform);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="type">const</span> int32 NumSpineBones = SpineBoneDataArray.<span class="built_in">Num</span>();</span><br><span class="line">	<span class="type">const</span> <span class="type">bool</span> bSpineOrientationAlpha = !FMath::<span class="built_in">IsNearlyZero</span>(DistributedBoneOrientationAlpha, KINDA_SMALL_NUMBER);</span><br><span class="line">	<span class="type">const</span> <span class="type">bool</span> bUpdateSpineBones = (NumSpineBones &gt; <span class="number">0</span>) &amp;&amp; bSpineOrientationAlpha;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (bUpdateSpineBones)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// Spine bones counter rotate body orientation evenly across all bones.</span></span><br><span class="line">		<span class="keyword">for</span> (int32 ArrayIndex = <span class="number">0</span>; ArrayIndex &lt; NumSpineBones; ArrayIndex++)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="type">const</span> FOrientationWarpingSpineBoneData&amp; BoneData = SpineBoneDataArray[ArrayIndex];</span><br><span class="line">			<span class="type">const</span> FQuat SpineBoneCounterRotation = <span class="built_in">FQuat</span>(RotationAxisVector, -ActualOrientationAngle * DistributedBoneOrientationAlpha * BoneData.Weight);</span><br><span class="line">			<span class="built_in">check</span>(BoneData.Weight &gt; <span class="number">0.f</span>);</span><br><span class="line"></span><br><span class="line">			<span class="function">FTransform <span class="title">SpineBoneTransform</span><span class="params">(Output.Pose.GetComponentSpaceTransform(BoneData.BoneIndex))</span></span>;</span><br><span class="line">			SpineBoneTransform.<span class="built_in">SetRotation</span>((SpineBoneCounterRotation * SpineBoneTransform.<span class="built_in">GetRotation</span>()));</span><br><span class="line">			SpineBoneTransform.<span class="built_in">NormalizeRotation</span>();</span><br><span class="line">			Output.Pose.<span class="built_in">SetComponentSpaceTransform</span>(BoneData.BoneIndex, SpineBoneTransform);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="type">const</span> <span class="type">float</span> IKFootRootOrientationAlpha = <span class="number">1.f</span> - DistributedBoneOrientationAlpha;</span><br><span class="line">	<span class="type">const</span> <span class="type">bool</span> bUpdateIKFootRoot = (IKFootData.IKFootRootBoneIndex != <span class="built_in">FCompactPoseBoneIndex</span>(INDEX_NONE)) &amp;&amp; !FMath::<span class="built_in">IsNearlyZero</span>(IKFootRootOrientationAlpha, KINDA_SMALL_NUMBER);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Rotate IK Foot Root</span></span><br><span class="line">	<span class="keyword">if</span> (bUpdateIKFootRoot)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="type">const</span> FQuat BoneRotation = <span class="built_in">FQuat</span>(RotationAxisVector, ActualOrientationAngle * IKFootRootOrientationAlpha);</span><br><span class="line"></span><br><span class="line">		<span class="function">FTransform <span class="title">IKFootRootTransform</span><span class="params">(Output.Pose.GetComponentSpaceTransform(IKFootData.IKFootRootBoneIndex))</span></span>;</span><br><span class="line">		IKFootRootTransform.<span class="built_in">SetRotation</span>(BoneRotation * IKFootRootTransform.<span class="built_in">GetRotation</span>());</span><br><span class="line">		IKFootRootTransform.<span class="built_in">NormalizeRotation</span>();</span><br><span class="line">		Output.Pose.<span class="built_in">SetComponentSpaceTransform</span>(IKFootData.IKFootRootBoneIndex, IKFootRootTransform);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// IK Feet </span></span><br><span class="line">		<span class="comment">// These match the root orientation, so don&#x27;t rotate them. Just preserve root rotation. </span></span><br><span class="line">		<span class="comment">// We need to update their translation though, since we rotated their parent (the IK Foot Root bone).</span></span><br><span class="line">		<span class="type">const</span> int32 NumIKFootBones = IKFootData.IKFootBoneIndexArray.<span class="built_in">Num</span>();</span><br><span class="line">		<span class="type">const</span> <span class="type">bool</span> bUpdateIKFootBones = bUpdateIKFootRoot &amp;&amp; (NumIKFootBones &gt; <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (bUpdateIKFootBones)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="type">const</span> FQuat IKFootRotation = <span class="built_in">FQuat</span>(RotationAxisVector, -ActualOrientationAngle * IKFootRootOrientationAlpha);</span><br><span class="line"></span><br><span class="line">			<span class="keyword">for</span> (int32 ArrayIndex = <span class="number">0</span>; ArrayIndex &lt; NumIKFootBones; ArrayIndex++)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="type">const</span> FCompactPoseBoneIndex&amp; IKFootBoneIndex = IKFootData.IKFootBoneIndexArray[ArrayIndex];</span><br><span class="line"></span><br><span class="line">				<span class="function">FTransform <span class="title">IKFootBoneTransform</span><span class="params">(Output.Pose.GetComponentSpaceTransform(IKFootBoneIndex))</span></span>;</span><br><span class="line">				IKFootBoneTransform.<span class="built_in">SetRotation</span>(IKFootRotation * IKFootBoneTransform.<span class="built_in">GetRotation</span>());</span><br><span class="line">				IKFootBoneTransform.<span class="built_in">NormalizeRotation</span>();</span><br><span class="line">				Output.Pose.<span class="built_in">SetComponentSpaceTransform</span>(IKFootBoneIndex, IKFootBoneTransform);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	OutBoneTransforms.<span class="built_in">Sort</span>(<span class="built_in">FCompareBoneTransformIndex</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Distance-Match-距离匹配"><a href="#Distance-Match-距离匹配" class="headerlink" title="Distance Match (距离匹配)"></a>Distance Match (距离匹配)</h3><p>通过移动输入的实际位移，调整动画，解决起步或者停步时的滑步问题。</p>
<p>与参考文章有所出入，有些函数已经被移除插件库。</p>
<p>注释中提到需要跟步幅扭曲有所配合，因为AdvanceTimeByDistanceMatching似乎仅仅是提供了播放速率的调整，并没有调整骨骼。</p>
<ul>
<li>Engine\Plugins\Animation\AnimationLocomotionLibrary\Source\Runtime\Private\AnimDistanceMatchingLibrary.cpp</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">FSequenceEvaluatorReference <span class="title">UAnimDistanceMatchingLibrary::AdvanceTimeByDistanceMatching</span><span class="params">(<span class="type">const</span> FAnimUpdateContext&amp; UpdateContext, <span class="type">const</span> FSequenceEvaluatorReference&amp; SequenceEvaluator, <span class="type">float</span> DistanceTraveled, FName DistanceCurveName, FVector2D PlayRateClamp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	SequenceEvaluator.<span class="built_in">CallAnimNodeFunction</span>&lt;FAnimNode_SequenceEvaluator&gt;(</span><br><span class="line">		<span class="built_in">TEXT</span>(<span class="string">&quot;AdvanceTimeByDistanceMatching&quot;</span>),</span><br><span class="line">		[&amp;UpdateContext, DistanceTraveled, DistanceCurveName, PlayRateClamp](FAnimNode_SequenceEvaluator&amp; InSequenceEvaluator)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span> (<span class="type">const</span> FAnimationUpdateContext* AnimationUpdateContext = UpdateContext.<span class="built_in">GetContext</span>())</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="type">const</span> <span class="type">float</span> DeltaTime = AnimationUpdateContext-&gt;<span class="built_in">GetDeltaTime</span>(); </span><br><span class="line"></span><br><span class="line">				<span class="keyword">if</span> (DeltaTime &gt; <span class="number">0</span> &amp;&amp; DistanceTraveled &gt; <span class="number">0</span>)</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="keyword">if</span> (<span class="type">const</span> UAnimSequenceBase* AnimSequence = <span class="built_in">Cast</span>&lt;UAnimSequence&gt;(InSequenceEvaluator.<span class="built_in">GetSequence</span>()))</span><br><span class="line">					&#123;</span><br><span class="line">						<span class="type">const</span> <span class="type">float</span> CurrentTime = InSequenceEvaluator.<span class="built_in">GetExplicitTime</span>();</span><br><span class="line">						<span class="type">const</span> <span class="type">float</span> CurrentAssetLength = InSequenceEvaluator.<span class="built_in">GetCurrentAssetLength</span>();</span><br><span class="line">						<span class="type">const</span> <span class="type">bool</span> bAllowLooping = InSequenceEvaluator.<span class="built_in">GetShouldLoop</span>();</span><br><span class="line"></span><br><span class="line">						<span class="type">const</span> USkeleton::AnimCurveUID CurveUID = UE::Anim::DistanceMatchingUtility::<span class="built_in">GetCurveUID</span>(AnimSequence, DistanceCurveName);</span><br><span class="line">						<span class="type">float</span> TimeAfterDistanceTraveled = UE::Anim::DistanceMatchingUtility::<span class="built_in">GetTimeAfterDistanceTraveled</span>(AnimSequence, CurrentTime, DistanceTraveled, CurveUID, bAllowLooping);</span><br><span class="line"></span><br><span class="line">						<span class="comment">// Calculate the effective playrate that would result from advancing the animation by the distance traveled.</span></span><br><span class="line">						<span class="comment">// Account for the animation looping.</span></span><br><span class="line">						<span class="keyword">if</span> (TimeAfterDistanceTraveled &lt; CurrentTime)</span><br><span class="line">						&#123;</span><br><span class="line">							TimeAfterDistanceTraveled += CurrentAssetLength;</span><br><span class="line">						&#125;</span><br><span class="line">						<span class="type">float</span> EffectivePlayRate = (TimeAfterDistanceTraveled - CurrentTime) / DeltaTime;</span><br><span class="line"></span><br><span class="line">						<span class="comment">// Clamp the effective play rate.</span></span><br><span class="line">						<span class="keyword">if</span> (PlayRateClamp.X &gt;= <span class="number">0.0f</span> &amp;&amp; PlayRateClamp.X &lt; PlayRateClamp.Y)</span><br><span class="line">						&#123;</span><br><span class="line">							EffectivePlayRate = FMath::<span class="built_in">Clamp</span>(EffectivePlayRate, PlayRateClamp.X, PlayRateClamp.Y);</span><br><span class="line">						&#125;</span><br><span class="line"></span><br><span class="line">						<span class="comment">// Advance animation time by the effective play rate.</span></span><br><span class="line">						<span class="type">float</span> NewTime = CurrentTime;</span><br><span class="line">						FAnimationRuntime::<span class="built_in">AdvanceTime</span>(bAllowLooping, EffectivePlayRate * DeltaTime, NewTime, CurrentAssetLength);</span><br><span class="line"></span><br><span class="line">						<span class="keyword">if</span> (!InSequenceEvaluator.<span class="built_in">SetExplicitTime</span>(NewTime))</span><br><span class="line">						&#123;</span><br><span class="line">							<span class="built_in">UE_LOG</span>(LogAnimDistanceMatchingLibrary, Warning, <span class="built_in">TEXT</span>(<span class="string">&quot;Could not set explicit time on sequence evaluator, value is not dynamic. Set it as Always Dynamic.&quot;</span>));</span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line">					<span class="keyword">else</span></span><br><span class="line">					&#123;</span><br><span class="line">						<span class="built_in">UE_LOG</span>(LogAnimDistanceMatchingLibrary, Warning, <span class="built_in">TEXT</span>(<span class="string">&quot;Sequence evaluator does not have an anim sequence to play.&quot;</span>));</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">			&#123;</span><br><span class="line">				<span class="built_in">UE_LOG</span>(LogAnimDistanceMatchingLibrary, Warning, <span class="built_in">TEXT</span>(<span class="string">&quot;AdvanceTimeByDistanceMatching called with invalid context&quot;</span>));</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> SequenceEvaluator;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">FSequenceEvaluatorReference <span class="title">UAnimDistanceMatchingLibrary::DistanceMatchToTarget</span><span class="params">(<span class="type">const</span> FSequenceEvaluatorReference&amp; SequenceEvaluator, <span class="type">float</span> DistanceToTarget, FName DistanceCurveName)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	SequenceEvaluator.<span class="built_in">CallAnimNodeFunction</span>&lt;FAnimNode_SequenceEvaluator&gt;(</span><br><span class="line">		<span class="built_in">TEXT</span>(<span class="string">&quot;DistanceMatchToTarget&quot;</span>),</span><br><span class="line">		[DistanceToTarget, DistanceCurveName](FAnimNode_SequenceEvaluator&amp; InSequenceEvaluator)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span> (<span class="type">const</span> UAnimSequenceBase* AnimSequence = <span class="built_in">Cast</span>&lt;UAnimSequence&gt;(InSequenceEvaluator.<span class="built_in">GetSequence</span>()))</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="type">const</span> USkeleton::AnimCurveUID CurveUID = UE::Anim::DistanceMatchingUtility::<span class="built_in">GetCurveUID</span>(AnimSequence, DistanceCurveName);</span><br><span class="line">				<span class="keyword">if</span> (AnimSequence-&gt;<span class="built_in">HasCurveData</span>(CurveUID))</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="comment">// By convention, distance curves store the distance to a target as a negative value.</span></span><br><span class="line">					<span class="type">const</span> <span class="type">float</span> NewTime = UE::Anim::DistanceMatchingUtility::<span class="built_in">GetAnimPositionFromDistance</span>(AnimSequence, -DistanceToTarget, CurveUID);</span><br><span class="line">					<span class="keyword">if</span> (!InSequenceEvaluator.<span class="built_in">SetExplicitTime</span>(NewTime))</span><br><span class="line">					&#123;</span><br><span class="line">						<span class="built_in">UE_LOG</span>(LogAnimDistanceMatchingLibrary, Warning, <span class="built_in">TEXT</span>(<span class="string">&quot;Could not set explicit time on sequence evaluator, value is not dynamic. Set it as Always Dynamic.&quot;</span>));</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">else</span></span><br><span class="line">				&#123;</span><br><span class="line">					<span class="built_in">UE_LOG</span>(LogAnimDistanceMatchingLibrary, Warning, <span class="built_in">TEXT</span>(<span class="string">&quot;DistanceMatchToTarget called with invalid DistanceCurveName or animation (%s) is missing a distance curve.&quot;</span>), *<span class="built_in">GetNameSafe</span>(AnimSequence));</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">			&#123;</span><br><span class="line">				<span class="built_in">UE_LOG</span>(LogAnimDistanceMatchingLibrary, Warning, <span class="built_in">TEXT</span>(<span class="string">&quot;Sequence evaluator does not have an anim sequence to play.&quot;</span>));</span><br><span class="line">			&#125;</span><br><span class="line">			</span><br><span class="line">		&#125;);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> SequenceEvaluator;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">FSequencePlayerReference <span class="title">UAnimDistanceMatchingLibrary::SetPlayrateToMatchSpeed</span><span class="params">(<span class="type">const</span> FSequencePlayerReference&amp; SequencePlayer, <span class="type">float</span> SpeedToMatch, FVector2D PlayRateClamp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	SequencePlayer.<span class="built_in">CallAnimNodeFunction</span>&lt;FAnimNode_SequencePlayer&gt;(</span><br><span class="line">		<span class="built_in">TEXT</span>(<span class="string">&quot;SetPlayrateToMatchSpeed&quot;</span>),</span><br><span class="line">		[SpeedToMatch, PlayRateClamp](FAnimNode_SequencePlayer&amp; InSequencePlayer)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span> (<span class="type">const</span> UAnimSequence* AnimSequence = <span class="built_in">Cast</span>&lt;UAnimSequence&gt;(InSequencePlayer.<span class="built_in">GetSequence</span>()))</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="type">const</span> <span class="type">float</span> AnimLength = AnimSequence-&gt;<span class="built_in">GetPlayLength</span>();</span><br><span class="line">				<span class="keyword">if</span> (!FMath::<span class="built_in">IsNearlyZero</span>(AnimLength))</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="comment">// Calculate the speed as: (distance traveled by the animation) / (length of the animation)</span></span><br><span class="line">					<span class="type">const</span> FVector RootMotionTranslation = AnimSequence-&gt;<span class="built_in">ExtractRootMotionFromRange</span>(<span class="number">0.0f</span>, AnimLength).<span class="built_in">GetTranslation</span>();</span><br><span class="line">					<span class="type">const</span> <span class="type">float</span> RootMotionDistance = RootMotionTranslation.<span class="built_in">Size2D</span>();</span><br><span class="line">					<span class="keyword">if</span> (!FMath::<span class="built_in">IsNearlyZero</span>(RootMotionDistance))</span><br><span class="line">					&#123;</span><br><span class="line">						<span class="type">const</span> <span class="type">float</span> AnimationSpeed = RootMotionDistance / AnimLength;</span><br><span class="line">						<span class="type">float</span> DesiredPlayRate = SpeedToMatch / AnimationSpeed;</span><br><span class="line">						<span class="keyword">if</span> (PlayRateClamp.X &gt;= <span class="number">0.0f</span> &amp;&amp; PlayRateClamp.X &lt; PlayRateClamp.Y)</span><br><span class="line">						&#123;</span><br><span class="line">							DesiredPlayRate = FMath::<span class="built_in">Clamp</span>(DesiredPlayRate, PlayRateClamp.X, PlayRateClamp.Y);</span><br><span class="line">						&#125;</span><br><span class="line"></span><br><span class="line">						<span class="keyword">if</span> (!InSequencePlayer.<span class="built_in">SetPlayRate</span>(DesiredPlayRate))</span><br><span class="line">						&#123;</span><br><span class="line">							<span class="built_in">UE_LOG</span>(LogAnimDistanceMatchingLibrary, Warning, <span class="built_in">TEXT</span>(<span class="string">&quot;Could not set play rate on sequence player, value is not dynamic. Set it as Always Dynamic.&quot;</span>));</span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line">					<span class="keyword">else</span></span><br><span class="line">					&#123;</span><br><span class="line">						<span class="built_in">UE_LOG</span>(LogAnimDistanceMatchingLibrary, Warning, <span class="built_in">TEXT</span>(<span class="string">&quot;Unable to adjust playrate for animation with no root motion delta (%s).&quot;</span>), *<span class="built_in">GetNameSafe</span>(AnimSequence));</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">else</span></span><br><span class="line">				&#123;</span><br><span class="line">					<span class="built_in">UE_LOG</span>(LogAnimDistanceMatchingLibrary, Warning, <span class="built_in">TEXT</span>(<span class="string">&quot;Unable to adjust playrate for zero length animation (%s).&quot;</span>), *<span class="built_in">GetNameSafe</span>(AnimSequence));</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">			&#123;</span><br><span class="line">				<span class="built_in">UE_LOG</span>(LogAnimDistanceMatchingLibrary, Warning, <span class="built_in">TEXT</span>(<span class="string">&quot;Sequence player does not have an anim sequence to play.&quot;</span>));</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> SequencePlayer;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Pivot"><a href="#Pivot" class="headerlink" title="Pivot"></a>Pivot</h3><p>?回转运动?主要是指进行反方向移动时应该执行的动画，比如前进中收到后退的输入，以现实来说应该先做出减速的动作再往后加速</p>
<h3 id="Aim-Offset-瞄准偏移"><a href="#Aim-Offset-瞄准偏移" class="headerlink" title="Aim Offset (瞄准偏移)"></a>Aim Offset (瞄准偏移)</h3><h1 id="Lyra-Inventory-and-Lyra-Equipment"><a href="#Lyra-Inventory-and-Lyra-Equipment" class="headerlink" title="Lyra Inventory and Lyra Equipment"></a>Lyra Inventory and Lyra Equipment</h1><h2 id="Class-Diagram-1"><a href="#Class-Diagram-1" class="headerlink" title="Class Diagram"></a>Class Diagram</h2><img src="/2023/06/20/Lyra/Unreal%20Engine%205%20Lyra%20Starter%20Game%20Weapon%20Class%20Diagram.png" class="" title="Inventory and Equipment">

<h2 id="Key-Class-2"><a href="#Key-Class-2" class="headerlink" title="Key Class"></a>Key Class</h2><ul>
<li>ULyraInventoryManagerComponent</li>
</ul>
<h1 id="Lyra-Abilities"><a href="#Lyra-Abilities" class="headerlink" title="Lyra Abilities"></a>Lyra Abilities</h1><p>使用游戏技能系统来构建玩法内容，同时也会依赖Game Features来动态装卸玩法内容。</p>
<h2 id="Key-Class-3"><a href="#Key-Class-3" class="headerlink" title="Key Class"></a>Key Class</h2><ul>
<li>UGameFeatureAction_AddAbilities</li>
</ul>
<blockquote>
<p>GameFeatureAction responsible for granting abilities (and attributes) to actors of a specified type.</p>
</blockquote>
<p>继承UGameFeatureAction_WorldActionBase，负责赋予Actor特定技能和激活技能相关的逻辑。Abilities相关的Game Feature激活时会调用此类定义的回调函数。</p>
<h2 id="Work-Flow-2"><a href="#Work-Flow-2" class="headerlink" title="Work Flow"></a>Work Flow</h2><h2 id="Implementation"><a href="#Implementation" class="headerlink" title="Implementation"></a>Implementation</h2><ul>
<li>LyraStarterGame\Source\LyraGame\GameFeatures\GameFeatureAciton_AddAbilities.cpp</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">UGameFeatureAction_AddAbilities::AddToWorld</span><span class="params">(<span class="type">const</span> FWorldContext&amp; WorldContext, <span class="type">const</span> FGameFeatureStateChangeContext&amp; ChangeContext)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	UWorld* World = WorldContext.<span class="built_in">World</span>();</span><br><span class="line">	UGameInstance* GameInstance = WorldContext.OwningGameInstance;</span><br><span class="line">	FPerContextData&amp; ActiveData = ContextData.<span class="built_in">FindOrAdd</span>(ChangeContext);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> ((GameInstance != <span class="literal">nullptr</span>) &amp;&amp; (World != <span class="literal">nullptr</span>) &amp;&amp; World-&gt;<span class="built_in">IsGameWorld</span>())</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (UGameFrameworkComponentManager* ComponentMan = UGameInstance::<span class="built_in">GetSubsystem</span>&lt;UGameFrameworkComponentManager&gt;(GameInstance))</span><br><span class="line">		&#123;			</span><br><span class="line">			int32 EntryIndex = <span class="number">0</span>;</span><br><span class="line">			<span class="keyword">for</span> (<span class="type">const</span> FGameFeatureAbilitiesEntry&amp; Entry : AbilitiesList)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">if</span> (!Entry.ActorClass.<span class="built_in">IsNull</span>())</span><br><span class="line">				&#123;</span><br><span class="line">					UGameFrameworkComponentManager::FExtensionHandlerDelegate AddAbilitiesDelegate = UGameFrameworkComponentManager::FExtensionHandlerDelegate::<span class="built_in">CreateUObject</span>(</span><br><span class="line">						<span class="keyword">this</span>, &amp;UGameFeatureAction_AddAbilities::HandleActorExtension, EntryIndex, ChangeContext);</span><br><span class="line">					TSharedPtr&lt;FComponentRequestHandle&gt; ExtensionRequestHandle = ComponentMan-&gt;<span class="built_in">AddExtensionHandler</span>(Entry.ActorClass, AddAbilitiesDelegate);</span><br><span class="line"></span><br><span class="line">					ActiveData.ComponentRequests.<span class="built_in">Add</span>(ExtensionRequestHandle);</span><br><span class="line">					EntryIndex++;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">UGameFeatureAction_AddAbilities::HandleActorExtension</span><span class="params">(AActor* Actor, FName EventName, int32 EntryIndex, FGameFeatureStateChangeContext ChangeContext)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	FPerContextData* ActiveData = ContextData.<span class="built_in">Find</span>(ChangeContext);</span><br><span class="line">	<span class="keyword">if</span> (AbilitiesList.<span class="built_in">IsValidIndex</span>(EntryIndex) &amp;&amp; ActiveData)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="type">const</span> FGameFeatureAbilitiesEntry&amp; Entry = AbilitiesList[EntryIndex];</span><br><span class="line">		<span class="keyword">if</span> ((EventName == UGameFrameworkComponentManager::NAME_ExtensionRemoved) || (EventName == UGameFrameworkComponentManager::NAME_ReceiverRemoved))</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">RemoveActorAbilities</span>(Actor, *ActiveData);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> ((EventName == UGameFrameworkComponentManager::NAME_ExtensionAdded) || (EventName == ALyraPlayerState::NAME_LyraAbilityReady))</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">AddActorAbilities</span>(Actor, Entry, *ActiveData);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">UGameFeatureAction_AddAbilities::AddActorAbilities</span><span class="params">(AActor* Actor, <span class="type">const</span> FGameFeatureAbilitiesEntry&amp; AbilitiesEntry, FPerContextData&amp; ActiveData)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">check</span>(Actor);</span><br><span class="line">	<span class="keyword">if</span> (!Actor-&gt;<span class="built_in">HasAuthority</span>())</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// early out if Actor already has ability extensions applied</span></span><br><span class="line">	<span class="keyword">if</span> (ActiveData.ActiveExtensions.<span class="built_in">Find</span>(Actor) != <span class="literal">nullptr</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span>;	</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (UAbilitySystemComponent* AbilitySystemComponent = <span class="built_in">FindOrAddComponentForActor</span>&lt;UAbilitySystemComponent&gt;(Actor, AbilitiesEntry, ActiveData))</span><br><span class="line">	&#123;</span><br><span class="line">		FActorExtensions AddedExtensions;</span><br><span class="line">		AddedExtensions.Abilities.<span class="built_in">Reserve</span>(AbilitiesEntry.GrantedAbilities.<span class="built_in">Num</span>());</span><br><span class="line">		AddedExtensions.Attributes.<span class="built_in">Reserve</span>(AbilitiesEntry.GrantedAttributes.<span class="built_in">Num</span>());</span><br><span class="line">		AddedExtensions.AbilitySetHandles.<span class="built_in">Reserve</span>(AbilitiesEntry.GrantedAbilitySets.<span class="built_in">Num</span>());</span><br><span class="line"></span><br><span class="line">		<span class="keyword">for</span> (<span class="type">const</span> FLyraAbilityGrant&amp; Ability : AbilitiesEntry.GrantedAbilities)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span> (!Ability.AbilityType.<span class="built_in">IsNull</span>())</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="function">FGameplayAbilitySpec <span class="title">NewAbilitySpec</span><span class="params">(Ability.AbilityType.LoadSynchronous())</span></span>;</span><br><span class="line">				FGameplayAbilitySpecHandle AbilityHandle = AbilitySystemComponent-&gt;<span class="built_in">GiveAbility</span>(NewAbilitySpec);</span><br><span class="line"></span><br><span class="line">				AddedExtensions.Abilities.<span class="built_in">Add</span>(AbilityHandle);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">for</span> (<span class="type">const</span> FLyraAttributeSetGrant&amp; Attributes : AbilitiesEntry.GrantedAttributes)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span> (!Attributes.AttributeSetType.<span class="built_in">IsNull</span>())</span><br><span class="line">			&#123;</span><br><span class="line">				TSubclassOf&lt;UAttributeSet&gt; SetType = Attributes.AttributeSetType.<span class="built_in">LoadSynchronous</span>();</span><br><span class="line">				<span class="keyword">if</span> (SetType)</span><br><span class="line">				&#123;</span><br><span class="line">					UAttributeSet* NewSet = <span class="built_in">NewObject</span>&lt;UAttributeSet&gt;(AbilitySystemComponent-&gt;<span class="built_in">GetOwner</span>(), SetType);</span><br><span class="line">					<span class="keyword">if</span> (!Attributes.InitializationData.<span class="built_in">IsNull</span>())</span><br><span class="line">					&#123;</span><br><span class="line">						UDataTable* InitData = Attributes.InitializationData.<span class="built_in">LoadSynchronous</span>();</span><br><span class="line">						<span class="keyword">if</span> (InitData)</span><br><span class="line">						&#123;</span><br><span class="line">							NewSet-&gt;<span class="built_in">InitFromMetaDataTable</span>(InitData);</span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line"></span><br><span class="line">					AddedExtensions.Attributes.<span class="built_in">Add</span>(NewSet);</span><br><span class="line">					AbilitySystemComponent-&gt;<span class="built_in">AddAttributeSetSubobject</span>(NewSet);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		ULyraAbilitySystemComponent* LyraASC = <span class="built_in">CastChecked</span>&lt;ULyraAbilitySystemComponent&gt;(AbilitySystemComponent);</span><br><span class="line">		<span class="keyword">for</span> (<span class="type">const</span> TSoftObjectPtr&lt;<span class="type">const</span> ULyraAbilitySet&gt;&amp; SetPtr : AbilitiesEntry.GrantedAbilitySets)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span> (<span class="type">const</span> ULyraAbilitySet* Set = SetPtr.<span class="built_in">Get</span>())</span><br><span class="line">			&#123;</span><br><span class="line">				Set-&gt;<span class="built_in">GiveToAbilitySystem</span>(LyraASC, &amp;AddedExtensions.AbilitySetHandles.<span class="built_in">AddDefaulted_GetRef</span>());</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		ActiveData.ActiveExtensions.<span class="built_in">Add</span>(Actor, AddedExtensions);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">UE_LOG</span>(LogGameFeatures, Error, <span class="built_in">TEXT</span>(<span class="string">&quot;Failed to find/add an ability component to &#x27;%s&#x27;. Abilities will not be granted.&quot;</span>), *Actor-&gt;<span class="built_in">GetPathName</span>());</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>Engine\Plugins\Runtime\GameplayAbilities\Source\GameplayAbilities\Private\AbilitySystemComponent_Abilities.cpp</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">FGameplayAbilitySpecHandle <span class="title">UAbilitySystemComponent::GiveAbility</span><span class="params">(<span class="type">const</span> FGameplayAbilitySpec&amp; Spec)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (!<span class="built_in">IsValid</span>(Spec.Ability))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">ABILITY_LOG</span>(Error, <span class="built_in">TEXT</span>(<span class="string">&quot;GiveAbility called with an invalid Ability Class.&quot;</span>));</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">FGameplayAbilitySpecHandle</span>();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!<span class="built_in">IsOwnerActorAuthoritative</span>())</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">ABILITY_LOG</span>(Error, <span class="built_in">TEXT</span>(<span class="string">&quot;GiveAbility called on ability %s on the client, not allowed!&quot;</span>), *Spec.Ability-&gt;<span class="built_in">GetName</span>());</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">FGameplayAbilitySpecHandle</span>();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// If locked, add to pending list. The Spec.Handle is not regenerated when we receive, so returning this is ok.</span></span><br><span class="line">	<span class="keyword">if</span> (AbilityScopeLockCount &gt; <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		AbilityPendingAdds.<span class="built_in">Add</span>(Spec);</span><br><span class="line">		<span class="keyword">return</span> Spec.Handle;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">ABILITYLIST_SCOPE_LOCK</span>();</span><br><span class="line">	FGameplayAbilitySpec&amp; OwnedSpec = ActivatableAbilities.Items[ActivatableAbilities.Items.<span class="built_in">Add</span>(Spec)];</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> (OwnedSpec.Ability-&gt;<span class="built_in">GetInstancingPolicy</span>() == EGameplayAbilityInstancingPolicy::InstancedPerActor)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// Create the instance at creation time</span></span><br><span class="line">		<span class="built_in">CreateNewInstanceOfAbility</span>(OwnedSpec, Spec.Ability);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">OnGiveAbility</span>(OwnedSpec);</span><br><span class="line">	<span class="built_in">MarkAbilitySpecDirty</span>(OwnedSpec, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> OwnedSpec.Handle;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Class-Diagram-2"><a href="#Class-Diagram-2" class="headerlink" title="Class Diagram"></a>Class Diagram</h2><h1 id="Lyra-AI-Behavior-Tree"><a href="#Lyra-AI-Behavior-Tree" class="headerlink" title="Lyra AI Behavior Tree"></a>Lyra AI Behavior Tree</h1><h1 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h1><p>Lyra的框架设计大量采用了ECS的思想，能用来缓解AActor、ACharacter、AController在Gameplay上的臃肿问题。<br>动态装卸玩法的思路非常适合网游或者长期运营的游戏，但是不一定适用于一些大型单机游戏。<br>EnhancedInput比旧版本的输入提供了更多的轮子，长按、点按等方式不用自己造了，但是将配置、输入方式、配置映射、游戏逻辑分开，用起来其实有一点麻烦，但是其可扩展性和灵活性相当的好。不单止可以做普通的角色射击，还可以加其他载具相关的。<br>第一次接触动画向开发相关的结构，Lyra动画方案提供了更优的模块化，争取了更高的实时性能。<br>数据驱动型的框架，将玩法设计完全交给了设计师。但是要求设计师有写蓝图脚本的能力，不太清楚国内的团队，国外团队确实可以采用这个方案。</p>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><h2 id="Official-Documentation"><a href="#Official-Documentation" class="headerlink" title="Official Documentation"></a>Official Documentation</h2><ul>
<li><a target="_blank" rel="noopener" href="https://docs.unrealengine.com/5.2/en-US/enhanced-input-in-unreal-engine/">Enhanced Input in Unreal Engine | Unreal Engine 5.2 Documentation</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.unrealengine.com/5.2/en-US/abilities-in-lyra-in-unreal-engine/">Abilities in Lyra in Unreal Engine | Unreal Engine 5.2 Documentation</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.unrealengine.com/5.2/en-US/lyra-inventory-and-equipment-in-unreal-engine/">Lyra Inventory and Equipment in Unreal Engine | Unreal Engine 5.2 Documentation</a></li>
</ul>
<h2 id="Third-Party-Articles"><a href="#Third-Party-Articles" class="headerlink" title="Third-Party Articles"></a>Third-Party Articles</h2><ul>
<li><a target="_blank" rel="noopener" href="https://www.gdcvault.com/play/1024001/-Overwatch-Gameplay-Architecture-and">GDC Vault - ‘Overwatch’ Gameplay Architecture and Netcode</a></li>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/30538626">游戏开发中的ECS架构概述 – 知乎</a></li>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/473535854">《InsideUE5》GameFeatures架构（三）初始化 - 知乎</a></li>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/484763722">《InsideUE5》GameFeatures架构（四）状态机 - 知乎</a></li>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/492893002">《InsideUE5》GameFeatures架构（五）AddComponents - 知乎</a></li>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/537949870">UE5 – Lyra中的输入模块(Input) - 知乎</a></li>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/470949422">UE5 – EnhancedInput(输入增强系统) - 知乎</a></li>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/378948277">UE5 Motion Warping(运动扭曲)原理剖析及UE4适配 – 知乎</a></li>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/545559834">UE5 Distance Matching插件应用与源码解析 - 知乎</a></li>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/555984712">上万字详解UE5动画新特性Pose Warping原理与应用 – 知乎</a></li>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/517368184">UE5的动画蓝图（Lyra工程）- 知乎</a></li>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/614718286">UE5新项目Gameplay框架设计(以Lyra为例) - 知乎</a></li>
</ul>

  </div>
</article>



    </div>
    
      <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/posts/">Writing</a></li>
         
          <li><a target="_blank" rel="noopener" href="http://github.com/sergodeeva">Projects</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Version"><span class="toc-number">1.</span> <span class="toc-text">Version</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Game-Features"><span class="toc-number">2.</span> <span class="toc-text">Game Features</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Key-Class"><span class="toc-number">2.1.</span> <span class="toc-text">Key Class</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Work-Flow"><span class="toc-number">2.2.</span> <span class="toc-text">Work Flow</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#State-Machine"><span class="toc-number">2.3.</span> <span class="toc-text">State Machine</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Key-Implementation"><span class="toc-number">2.4.</span> <span class="toc-text">Key Implementation</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Game-Abilities-System"><span class="toc-number">3.</span> <span class="toc-text">Game Abilities System</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Enhanced-Input"><span class="toc-number">4.</span> <span class="toc-text">Enhanced Input</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Lyra-Input"><span class="toc-number">5.</span> <span class="toc-text">Lyra Input</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Key-Class-1"><span class="toc-number">5.1.</span> <span class="toc-text">Key Class</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Work-Flow-1"><span class="toc-number">5.2.</span> <span class="toc-text">Work Flow</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#PawnData-Data-Flow"><span class="toc-number">5.2.1.</span> <span class="toc-text">PawnData Data Flow</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Key-Implementation-1"><span class="toc-number">5.2.2.</span> <span class="toc-text">Key Implementation</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Class-Diagram"><span class="toc-number">5.2.3.</span> <span class="toc-text">Class Diagram</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Flow-Diagram"><span class="toc-number">5.2.4.</span> <span class="toc-text">Flow Diagram</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Note"><span class="toc-number">5.3.</span> <span class="toc-text">Note</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Lyra-Animation"><span class="toc-number">6.</span> <span class="toc-text">Lyra Animation</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Required-Plugin"><span class="toc-number">6.1.</span> <span class="toc-text">Required Plugin</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Solution-Design"><span class="toc-number">6.2.</span> <span class="toc-text">Solution Design</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%83%A8%E5%88%86%E9%9C%80%E8%A6%81%E6%B3%A8%E6%84%8F%E6%88%96%E8%80%85%E8%BF%98%E6%9C%AA%E4%BA%86%E8%A7%A3%E6%B8%85%E6%A5%9A%E7%9A%84%E7%BB%86%E8%8A%82"><span class="toc-number">6.3.</span> <span class="toc-text">部分需要注意或者还未了解清楚的细节</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#BlueprintThreadSafeUpdateAnimation"><span class="toc-number">6.3.1.</span> <span class="toc-text">BlueprintThreadSafeUpdateAnimation</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SelectCardinalDirectionFromAngle"><span class="toc-number">6.3.2.</span> <span class="toc-text">SelectCardinalDirectionFromAngle</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Root-Motion"><span class="toc-number">6.3.3.</span> <span class="toc-text">Root Motion</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Stride-Warping-%E6%AD%A5%E5%B9%85%E6%89%AD%E6%9B%B2"><span class="toc-number">6.3.4.</span> <span class="toc-text">Stride Warping (步幅扭曲)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Orientation-Warping-%E6%96%B9%E5%90%91%E6%89%AD%E6%9B%B2"><span class="toc-number">6.3.5.</span> <span class="toc-text">Orientation Warping (方向扭曲)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Distance-Match-%E8%B7%9D%E7%A6%BB%E5%8C%B9%E9%85%8D"><span class="toc-number">6.3.6.</span> <span class="toc-text">Distance Match (距离匹配)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Pivot"><span class="toc-number">6.3.7.</span> <span class="toc-text">Pivot</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Aim-Offset-%E7%9E%84%E5%87%86%E5%81%8F%E7%A7%BB"><span class="toc-number">6.3.8.</span> <span class="toc-text">Aim Offset (瞄准偏移)</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Lyra-Inventory-and-Lyra-Equipment"><span class="toc-number">7.</span> <span class="toc-text">Lyra Inventory and Lyra Equipment</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Class-Diagram-1"><span class="toc-number">7.1.</span> <span class="toc-text">Class Diagram</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Key-Class-2"><span class="toc-number">7.2.</span> <span class="toc-text">Key Class</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Lyra-Abilities"><span class="toc-number">8.</span> <span class="toc-text">Lyra Abilities</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Key-Class-3"><span class="toc-number">8.1.</span> <span class="toc-text">Key Class</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Work-Flow-2"><span class="toc-number">8.2.</span> <span class="toc-text">Work Flow</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Implementation"><span class="toc-number">8.3.</span> <span class="toc-text">Implementation</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Class-Diagram-2"><span class="toc-number">8.4.</span> <span class="toc-text">Class Diagram</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Lyra-AI-Behavior-Tree"><span class="toc-number">9.</span> <span class="toc-text">Lyra AI Behavior Tree</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Conclusion"><span class="toc-number">10.</span> <span class="toc-text">Conclusion</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Reference"><span class="toc-number">11.</span> <span class="toc-text">Reference</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Official-Documentation"><span class="toc-number">11.1.</span> <span class="toc-text">Official Documentation</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Third-Party-Articles"><span class="toc-number">11.2.</span> <span class="toc-text">Third-Party Articles</span></a></li></ol></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://asdlkjqpwoei.github.io/2023/06/20/Lyra/"><i class="fa fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://asdlkjqpwoei.github.io/2023/06/20/Lyra/&text=Lyra Sample"><i class="fa fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://asdlkjqpwoei.github.io/2023/06/20/Lyra/&title=Lyra Sample"><i class="fa fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://asdlkjqpwoei.github.io/2023/06/20/Lyra/&is_video=false&description=Lyra Sample"><i class="fa fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Lyra Sample&body=Check out this article: https://asdlkjqpwoei.github.io/2023/06/20/Lyra/"><i class="fa fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://asdlkjqpwoei.github.io/2023/06/20/Lyra/&title=Lyra Sample"><i class="fa fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://asdlkjqpwoei.github.io/2023/06/20/Lyra/&title=Lyra Sample"><i class="fa fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://asdlkjqpwoei.github.io/2023/06/20/Lyra/&title=Lyra Sample"><i class="fa fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://asdlkjqpwoei.github.io/2023/06/20/Lyra/&title=Lyra Sample"><i class="fa fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://asdlkjqpwoei.github.io/2023/06/20/Lyra/&name=Lyra Sample&description="><i class="fa fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
      <ul>
        <li id="toc"><a class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa fa-list fa-lg" aria-hidden="true"></i> TOC</a></li>
        <li id="share"><a class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa fa-share-alt fa-lg" aria-hidden="true"></i> Share</a></li>
        <li id="top" style="display:none"><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a></li>
        <li id="menu"><a class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa fa-bars fa-lg" aria-hidden="true"></i> Menu</a></li>
      </ul>
    </div>

  </div>
</div>

    
    <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2023 asdlkjqpwoei
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/posts/">Writing</a></li>
         
          <li><a target="_blank" rel="noopener" href="http://github.com/sergodeeva">Projects</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

</body>
</html>
<!-- styles -->

<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">


<link rel="stylesheet" href="/lib/meslo-LG/styles.css">


<link rel="stylesheet" href="/lib/justified-gallery/justifiedGallery.min.css">


<!-- jquery -->

<script src="/lib/jquery/jquery.min.js"></script>


<script src="/lib/justified-gallery/jquery.justifiedGallery.min.js"></script>


<script src="/js/main.js"></script>



    <!-- Google Analytics -->
    <script type="text/javascript">
        (function(i,s,o,g,r,a,m) {i['GoogleAnalyticsObject']=r;i[r]=i[r]||function() {
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
        ga('create', 'UA-37473492-6', 'auto');
        ga('send', 'pageview');
    </script>



